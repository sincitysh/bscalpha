<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BSC 交易分析工具</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        .trade-card {
            transition: all 0.2s ease;
            margin-bottom: 15px;
        }
        .trade-card:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        .buy-card {
            border-left: 4px solid #28a745;
        }
        .sell-card {
            border-left: 4px solid #dc3545;
        }
        .stats-box {
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .hidden {
            display: none;
        }
        .wallet-input {
            margin-bottom: 10px;
        }
        .wallet-input .input-group-append {
            cursor: pointer;
        }
        #addWalletBtn {
            margin-bottom: 10px;
        }
        .remove-wallet {
            cursor: pointer;
            color: #dc3545;
        }
    </style>
</head>
<body>
    <div class="container py-4">
        <h1 class="mb-4 text-center">BSC 交易分析工具</h1>
        
        <div class="card mb-4">
            <div class="card-body">
                <form id="analyzeForm">
                    <div id="walletsContainer">
                        <div class="wallet-input">
                            <div class="input-group">
                                <input type="text" class="form-control" placeholder="输入0x开头的BSC钱包地址" required>
                                <div class="input-group-append">
                                    <span class="input-group-text remove-wallet">
                                        <i class="bi bi-x-circle"></i>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button type="button" id="addWalletBtn" class="btn btn-outline-primary btn-sm">
                        <i class="bi bi-plus-circle"></i> 添加钱包地址
                    </button>
                    
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">日期范围</label>
                            <div class="input-group">
                                <input type="date" class="form-control" id="startDate">
                                <span class="input-group-text">至</span>
                                <input type="date" class="form-control" id="endDate">
                            </div>
                            <small class="text-muted">不填默认查询今天</small>
                        </div>
                        <div class="col-md-4">
                            <label for="apiKey" class="form-label">BSCScan API Key</label>
                            <input type="text" class="form-control" id="apiKey" value="4SJP83HZQVQ9GZZYMXJB9NMIDFQ86BCAFJ">
                            <small class="text-muted"><a href="https://bscscan.com/myapikey" target="_blank">获取API Key</a></small>
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary w-100">
                                <span class="normal-text">分析</span>
                                <span class="spinner-border spinner-border-sm hidden" id="submitSpinner" role="status"></span>
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <div id="errorMessage" class="alert alert-danger hidden" role="alert"></div>
        <div id="loader" class="loader hidden"></div>

        <div id="resultContainer" class="hidden">
            <div class="card mb-4">
                <div class="card-header">
                    <h4>分析结果</h4>
                    <p class="text-muted mb-0" id="timeRangeInfo"></p>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="stats-box bg-light">
                                <h5>交易统计</h5>
                                <div class="d-flex justify-content-between">
                                    <span>总交易次数:</span>
                                    <span id="totalTx" class="fw-bold"></span>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span>成功交易:</span>
                                    <span id="successTx" class="fw-bold"></span>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span>失败交易:</span>
                                    <span id="failedTx" class="fw-bold"></span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="stats-box bg-light">
                                <h5>交易金额</h5>
                                <div class="d-flex justify-content-between">
                                    <span>买入总额:</span>
                                    <span id="totalBuy" class="fw-bold text-success"></span>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span>卖出总额:</span>
                                    <span id="totalSell" class="fw-bold text-danger"></span>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span>Gas消耗:</span>
                                    <span id="totalGas" class="fw-bold"></span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="stats-box bg-light">
                                <h5>收益分析</h5>
                                <div class="d-flex justify-content-between">
                                    <span>交易盈亏:</span>
                                    <span id="profitLoss" class="fw-bold"></span>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span>净盈亏:</span>
                                    <span id="netProfitLoss" class="fw-bold"></span>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span>当前余额:</span>
                                    <span id="currentBalance" class="fw-bold"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <h4>交易明细</h4>
            <div id="noTradesMessage" class="alert alert-info hidden">在指定时间范围内没有找到交易</div>
            <div id="tradesContainer"></div>
        </div>
        
        <div class="mt-4 text-center">
            <p class="text-muted">
                本工具在GitHub Pages上运行，无需服务器 | 
                <a href="https://github.com/你的用户名/bsc-trading-analyzer" target="_blank">查看源码</a>
            </p>
        </div>
    </div>

    <!-- 添加Web3.js库 -->
    <script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>
    
    <script>
        // 保存API Key到本地存储
        function saveApiKey(apiKey) {
            if (apiKey) {
                localStorage.setItem('bscScanApiKey', apiKey);
            }
        }
        
        // 从本地存储获取API Key
        function getApiKey() {
            return localStorage.getItem('bscScanApiKey') || '';
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('analyzeForm');
            const loader = document.getElementById('loader');
            const errorMessage = document.getElementById('errorMessage');
            const resultContainer = document.getElementById('resultContainer');
            const submitSpinner = document.getElementById('submitSpinner');
            const noTradesMessage = document.getElementById('noTradesMessage');
            const apiKeyInput = document.getElementById('apiKey');
            
            // 设置已保存的API Key
            apiKeyInput.value = getApiKey();
            
            // 添加钱包地址输入框
            const addWalletBtn = document.getElementById('addWalletBtn');
            const walletsContainer = document.getElementById('walletsContainer');
            
            addWalletBtn.addEventListener('click', function() {
                const walletInput = document.createElement('div');
                walletInput.className = 'wallet-input';
                walletInput.innerHTML = `
                    <div class="input-group">
                        <input type="text" class="form-control" placeholder="输入0x开头的BSC钱包地址" required>
                        <div class="input-group-append">
                            <span class="input-group-text remove-wallet">
                                <i class="bi bi-x-circle"></i>
                            </span>
                        </div>
                    </div>
                `;
                walletsContainer.appendChild(walletInput);
            });
            
            // 删除钱包地址输入框
            walletsContainer.addEventListener('click', function(e) {
                if (e.target.closest('.remove-wallet')) {
                    const walletInput = e.target.closest('.wallet-input');
                    if (walletsContainer.children.length > 1) {
                        walletInput.remove();
                    }
                }
            });
            
            // 修改表单提交处理
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                // 获取所有钱包地址
                const walletInputs = walletsContainer.querySelectorAll('input');
                const addresses = Array.from(walletInputs).map(input => input.value.trim());
                
                // 验证地址
                for (const address of addresses) {
                    if (!isValidAddress(address)) {
                        errorMessage.textContent = `无效的钱包地址格式: ${address}`;
                        errorMessage.classList.remove('hidden');
                        return;
                    }
                }
                
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                const apiKey = document.getElementById('apiKey').value.trim();
                
                // 保存API Key
                saveApiKey(apiKey);
                
                // 显示加载状态
                toggleLoading(true);
                errorMessage.classList.add('hidden');
                errorMessage.textContent = '';
                resultContainer.classList.add('hidden');
                
                try {
                    if (!apiKey) {
                        throw new Error('请输入BSCScan API Key');
                    }
                    
                    // 获取时间范围
                    const timeRange = getTimeRangeTimestamps(startDate, endDate);
                    
                    // 获取所有地址的交易
                    let allTransactions = [];
                    for (const address of addresses) {
                        const transactions = await getAddressTransactions(address, timeRange, apiKey);
                        allTransactions = allTransactions.concat(transactions);
                    }
                    
                    if (allTransactions.length === 0) {
                        resultContainer.classList.remove('hidden');
                        noTradesMessage.classList.remove('hidden');
                        document.getElementById('timeRangeInfo').textContent = `统计时间: ${formatDateTime(new Date(timeRange.startTimestamp * 1000))} 至 ${formatDateTime(new Date(timeRange.endTimestamp * 1000))}`;
                        return;
                    }
                    
                    // 获取当前BNB价格
                    const bnbPrice = await getBNBPrice();
                    
                    // 获取所有地址的BNB余额总和
                    let totalBalance = 0;
                    for (const address of addresses) {
                        const balance = await getBNBBalance(address);
                        totalBalance += parseFloat(balance);
                    }
                    
                    // 分析交易
                    const analysis = await analyzeTransactions(addresses[0], allTransactions, timeRange, bnbPrice, totalBalance);
                    
                    // 渲染结果
                    renderResults({
                        success: true,
                        addresses,
                        analysis
                    });
                    
                    resultContainer.classList.remove('hidden');
                } catch (error) {
                    console.error('分析失败:', error);
                    errorMessage.textContent = error.message || '处理请求时发生错误';
                    errorMessage.classList.remove('hidden');
                } finally {
                    toggleLoading(false);
                }
            });
            
            function toggleLoading(isLoading) {
                if (isLoading) {
                    loader.classList.remove('hidden');
                    submitSpinner.classList.remove('hidden');
                    document.querySelector('.normal-text').classList.add('hidden');
                } else {
                    loader.classList.add('hidden');
                    submitSpinner.classList.add('hidden');
                    document.querySelector('.normal-text').classList.remove('hidden');
                }
            }
            
            function isValidAddress(address) {
                return /^0x[a-fA-F0-9]{40}$/.test(address);
            }
            
            // 获取BNB价格
            async function getBNBPrice() {
                try {
                    const response = await fetch('https://api.binance.com/api/v3/ticker/price?symbol=BNBUSDT');
                    const data = await response.json();
                    return parseFloat(data.price);
                } catch (error) {
                    console.error('获取BNB价格失败:', error);
                    return 220; // 默认价格
                }
            }
            
            // 获取BNB余额
            async function getBNBBalance(address) {
                try {
                    const web3 = new Web3('https://bsc-dataseed.binance.org/');
                    const balance = await web3.eth.getBalance(address);
                    return web3.utils.fromWei(balance, 'ether');
                } catch (error) {
                    console.error('获取余额失败:', error);
                    return '0';
                }
            }
            
            // 获取地址交易
            async function getAddressTransactions(address, timeRange, apiKey) {
                try {
                    const { startTimestamp, endTimestamp } = timeRange;
                    
                    const url = `https://api.bscscan.com/api?module=account&action=txlist&address=${address}&startblock=0&endblock=99999999&starttime=${startTimestamp}&endtime=${endTimestamp}&sort=asc&apikey=${apiKey}`;
                    
                    const response = await fetch(url);
                    const data = await response.json();
                    
                    if (data.status === '1' && Array.isArray(data.result)) {
                        return data.result;
                    } else {
                        throw new Error(`BSCScan API错误: ${data.message || '未知错误'}`);
                    }
                } catch (error) {
                    throw new Error(`获取交易记录失败: ${error.message}`);
                }
            }
            
            // 修改时间范围获取函数
            function getTimeRangeTimestamps(startDateStr = '', endDateStr = '') {
                const now = new Date();
                let startDate, endDate;
                
                if (startDateStr && endDateStr) {
                    // 如果提供了日期范围，使用每天的8:00
                    startDate = new Date(startDateStr);
                    startDate.setHours(8, 0, 0, 0);
                    
                    // 结束日期使用次日8:00
                    endDate = new Date(endDateStr);
                    endDate.setDate(endDate.getDate() + 1);
                    endDate.setHours(8, 0, 0, 0);
                } else {
                    // 如果没有提供日期，统计从今天8点到明天8点
                    startDate = new Date(now);
                    startDate.setHours(8, 0, 0, 0);
                    
                    // 如果当前时间早于8点，需要统计前一天8点到今天8点
                    if (now.getHours() < 8) {
                        startDate.setDate(startDate.getDate() - 1);
                    }
                    
                    // 结束时间为第二天早上8点
                    endDate = new Date(startDate);
                    endDate.setDate(endDate.getDate() + 1);
                }
                
                // 转换为时间戳（秒）
                const startTimestamp = Math.floor(startDate.getTime() / 1000);
                const endTimestamp = Math.floor(endDate.getTime() / 1000);
                
                return { startTimestamp, endTimestamp, startDate, endDate };
            }
            
            // 解析交易数据
            async function analyzeTransactions(address, transactions, timeRange, bnbPrice, bnbBalance) {
                // 定义路由地址
                const routerAddresses = {
                    'PancakeSwap': '0x10ED43C718714eb63d5aA57B78B54704E256024E'.toLowerCase(),
                    'BiSwap': '0x3a6d8cA21D1CF76F653A67577FA0D27453350dD8'.toLowerCase(),
                    'BaseSwap': '0x13f4EA83D0bd40E75C8222255bc855a974568Dd4'.toLowerCase(),
                    'BaseSwapRouter': '0xb300000b72deaeb607a12d5f54773d1c19c7028d'.toLowerCase()
                };
                
                // 初始化分析结果
                const analysis = {
                    address: address,
                    totalTx: 0,
                    totalGasCost: 0,
                    totalGasCostUSD: 0,
                    trades: [],
                    totalBuyValue: 0,
                    totalSellValue: 0,
                    profitLoss: 0,
                    netProfitLoss: 0,
                    bnbPrice: bnbPrice,
                    failedTx: 0,
                    bnbBalance: parseFloat(bnbBalance),
                    timeRange: {
                        start: new Date(timeRange.startTimestamp * 1000).toISOString(),
                        end: new Date(timeRange.endTimestamp * 1000).toISOString()
                    }
                };
                
                // Web3实例
                const web3 = new Web3('https://bsc-dataseed.binance.org/');
                
                // 筛选和分析交易
                for (const tx of transactions) {
                    try {
                        // 跳过失败的交易
                        if (tx.isError === "1") {
                            analysis.failedTx++;
                            continue;
                        }
                        
                        const to = tx.to.toLowerCase();
                        const value = tx.value ? web3.utils.fromWei(tx.value, 'ether') : '0';
                        
                        // 检查是否是DEX路由
                        if (Object.values(routerAddresses).includes(to)) {
                            const dex = Object.keys(routerAddresses).find(key => 
                                routerAddresses[key] === to
                            ) || '未知DEX';
                            
                            // 计算gas费用
                            const gasCost = web3.utils.fromWei((BigInt(tx.gasUsed) * BigInt(tx.gasPrice)).toString(), 'ether');
                            const gasCostUSD = parseFloat(gasCost) * bnbPrice;
                            
                            // 根据value判断交易类型
                            if (parseFloat(value) > 0) {
                                // 买入交易
                                const buyValue = parseFloat(value);
                                analysis.totalBuyValue += buyValue;
                                analysis.profitLoss -= buyValue;
                                
                                analysis.trades.push({
                                    type: 'buy',
                                    hash: tx.hash,
                                    timestamp: new Date(parseInt(tx.timeStamp) * 1000).toISOString(),
                                    value: buyValue,
                                    gasCost: parseFloat(gasCost),
                                    gasCostUSD: gasCostUSD,
                                    dex: dex
                                });
                            } else {
                                // 卖出交易 (简化版，实际上需要分析事件日志)
                                // 由于我们无法在前端直接分析事件日志，这里使用简化的启发式方法
                                const sellValue = parseFloat(value) || 0.01; // 简化版，实际值需要从日志中提取
                                analysis.totalSellValue += sellValue;
                                analysis.profitLoss += sellValue;
                                
                                analysis.trades.push({
                                    type: 'sell',
                                    hash: tx.hash,
                                    timestamp: new Date(parseInt(tx.timeStamp) * 1000).toISOString(),
                                    value: sellValue, 
                                    gasCost: parseFloat(gasCost),
                                    gasCostUSD: gasCostUSD,
                                    dex: dex
                                });
                            }
                            
                            analysis.totalGasCost += parseFloat(gasCost);
                            analysis.totalGasCostUSD += gasCostUSD;
                            analysis.totalTx += 1;
                        }
                    } catch (error) {
                        console.error(`处理交易错误:`, error);
                        continue;
                    }
                }
                
                analysis.netProfitLoss = analysis.profitLoss - analysis.totalGasCost;
                return analysis;
            }
            
            function renderResults(data) {
                const analysis = data.analysis;
                
                // 设置统计数据
                document.getElementById('totalTx').textContent = analysis.totalTx;
                document.getElementById('successTx').textContent = analysis.totalTx;
                document.getElementById('failedTx').textContent = analysis.failedTx;
                
                const bnbPrice = analysis.bnbPrice;
                
                // 设置交易金额
                document.getElementById('totalBuy').textContent = `${analysis.totalBuyValue.toFixed(6)} BNB ($${(analysis.totalBuyValue * bnbPrice).toFixed(2)})`;
                document.getElementById('totalSell').textContent = `${analysis.totalSellValue.toFixed(6)} BNB ($${(analysis.totalSellValue * bnbPrice).toFixed(2)})`;
                document.getElementById('totalGas').textContent = `${analysis.totalGasCost.toFixed(6)} BNB ($${analysis.totalGasCostUSD.toFixed(2)})`;
                
                // 设置收益分析
                const profitLossElem = document.getElementById('profitLoss');
                profitLossElem.textContent = `${analysis.profitLoss.toFixed(6)} BNB ($${(analysis.profitLoss * bnbPrice).toFixed(2)})`;
                profitLossElem.classList.remove('text-success', 'text-danger');
                profitLossElem.classList.add(analysis.profitLoss >= 0 ? 'text-success' : 'text-danger');
                
                const netProfitLossElem = document.getElementById('netProfitLoss');
                netProfitLossElem.textContent = `${analysis.netProfitLoss.toFixed(6)} BNB ($${(analysis.netProfitLoss * bnbPrice).toFixed(2)})`;
                netProfitLossElem.classList.remove('text-success', 'text-danger');
                netProfitLossElem.classList.add(analysis.netProfitLoss >= 0 ? 'text-success' : 'text-danger');
                
                document.getElementById('currentBalance').textContent = `${analysis.bnbBalance.toFixed(6)} BNB ($${(analysis.bnbBalance * bnbPrice).toFixed(2)})`;
                
                // 设置时间范围信息
                const startTime = new Date(analysis.timeRange.start);
                const endTime = new Date(analysis.timeRange.end);
                document.getElementById('timeRangeInfo').textContent = `统计时间: ${formatDateTime(startTime)} 至 ${formatDateTime(endTime)}`;
                
                // 渲染交易明细
                const tradesContainer = document.getElementById('tradesContainer');
                tradesContainer.innerHTML = '';
                
                if (analysis.trades.length === 0) {
                    noTradesMessage.classList.remove('hidden');
                } else {
                    noTradesMessage.classList.add('hidden');
                    
                    // 按时间倒序排序交易
                    const sortedTrades = [...analysis.trades].sort((a, b) => {
                        return new Date(b.timestamp) - new Date(a.timestamp);
                    });
                    
                    sortedTrades.forEach(trade => {
                        const tradeCard = document.createElement('div');
                        tradeCard.className = `card trade-card ${trade.type === 'buy' ? 'buy-card' : 'sell-card'}`;
                        
                        const tradeTime = new Date(trade.timestamp);
                        const valueInUsd = trade.value * bnbPrice;
                        
                        tradeCard.innerHTML = `
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h5 class="card-title mb-0">
                                        <i class="bi ${trade.type === 'buy' ? 'bi-arrow-down-circle-fill text-success' : 'bi-arrow-up-circle-fill text-danger'}"></i>
                                        ${trade.type === 'buy' ? '买入' : '卖出'} - ${trade.dex}
                                    </h5>
                                    <span class="text-muted">${formatDateTime(tradeTime)}</span>
                                </div>
                                <div class="row mb-2">
                                    <div class="col-md-6">
                                        <div class="d-flex justify-content-between">
                                            <span>交易金额:</span>
                                            <span class="fw-bold ${trade.type === 'buy' ? 'text-success' : 'text-danger'}">
                                                ${trade.value.toFixed(6)} BNB ($${valueInUsd.toFixed(2)})
                                            </span>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="d-flex justify-content-between">
                                            <span>Gas 费用:</span>
                                            <span>${trade.gasCost.toFixed(6)} BNB ($${trade.gasCostUSD.toFixed(2)})</span>
                                        </div>
                                    </div>
                                </div>
                                <a href="https://bscscan.com/tx/${trade.hash}" target="_blank" class="btn btn-sm btn-outline-secondary">
                                    <i class="bi bi-box-arrow-up-right"></i> 查看交易
                                </a>
                            </div>
                        `;
                        
                        tradesContainer.appendChild(tradeCard);
                    });
                }
            }
            
            function formatDateTime(date) {
                return new Intl.DateTimeFormat('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false
                }).format(date);
            }
        });
    </script>
</body>
</html>
