<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BSC USDT 统计分析工具</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        .trade-card {
            transition: all 0.2s ease;
            margin-bottom: 15px;
        }
        .trade-card:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        .buy-card {
            border-left: 4px solid #28a745;
        }
        .sell-card {
            border-left: 4px solid #dc3545;
        }
        .stats-box {
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .loader {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            margin: 20px auto;
        }
        .loading-spinner {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: conic-gradient(#0000 10%, #3498db);
            -webkit-mask: radial-gradient(farthest-side, #0000 calc(100% - 8px), #000 0);
            mask: radial-gradient(farthest-side, #0000 calc(100% - 8px), #000 0);
            animation: spin 1s infinite linear;
        }
        .loading-text {
            margin-top: 15px;
            font-size: 14px;
            color: #666;
            text-align: center;
        }
        .loading-progress {
            margin-top: 10px;
            width: 250px;
            height: 6px;
            background-color: #eee;
            border-radius: 3px;
            overflow: hidden;
        }
        .loading-progress-bar {
            height: 100%;
            background-color: #3498db;
            border-radius: 3px;
            transition: width 0.3s ease;
        }
        @keyframes spin {
            to { transform: rotate(1turn); }
        }
        .progress-info {
            background-color: rgba(52, 152, 219, 0.1);
            border-left: 4px solid #3498db;
            padding: 10px 15px;
            margin: 10px 0;
            font-size: 14px;
            color: #333;
            border-radius: 4px;
        }
        .hidden {
            display: none;
        }
        .wallet-input {
            margin-bottom: 10px;
        }
        .wallet-input .input-group-append {
            cursor: pointer;
        }
        #addWalletBtn {
            margin-bottom: 10px;
        }
        .remove-wallet {
            cursor: pointer;
            color: #dc3545;
        }
        .wallet-addresses {
            min-height: 100px;
            font-family: monospace;
        }
        .usdt-in { color: #28a745; }
        .usdt-out { color: #dc3545; }
        .ellipsis { max-width: 120px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; display: inline-block; vertical-align: bottom; }
    </style>
</head>
<body>
    <div class="container py-4">
        <h1 class="mb-4 text-center">BSC USDT 统计分析工具</h1>
        
        <div class="card mb-4">
            <div class="card-body">
                <form id="analyzeForm">
                    <div class="row g-3">
                        <div class="col-md-8">
                            <label class="form-label">BSC 钱包地址（支持带名称，每行一个）</label>
                            <textarea class="form-control wallet-addresses" rows="5" placeholder="输入格式：
名称 0x开头的BSC钱包地址
例如：
念安1 0xXX
念安2 0xXX" required></textarea>
                            <small class="text-muted">每行一个地址，可以在地址前加名称（用空格分隔）</small>
                        </div>
                        <div class="col-md-4">
                            <label for="date" class="form-label">统计日期</label>
                            <input type="date" class="form-control" id="date">
                            <small class="text-muted">不填默认统计今天8:00到明天8:00的数据</small>
                        </div>
                        <div class="col-md-4" style="display: none;">
                            <label for="txLimit" class="form-label">交易处理限制</label>
                            <select class="form-control" id="txLimit">
                                <option value="50">仅处理最近50笔交易</option>
                                <option value="100">仅处理最近100笔交易</option>
                                <option value="200">仅处理最近200笔交易</option>
                                <option value="all" selected>处理所有交易</option>
                            </select>
                            <small class="text-muted">限制处理的交易数量可以提高性能</small>
                        </div>
                    </div>
                    
                    <!-- 添加统计说明 -->
                    <div class="alert alert-info mt-3" role="alert">
                        <h6 class="alert-heading">📊 统计说明</h6>
                        <ul class="mb-0">
                            <li><strong>统计时间：</strong>不填默认统计今天8:00到明天8:00的数据</li>
                            <li><strong>处理范围：</strong>只处理USDT/USDC对的交易情况（如 USDT/ZKJ、USDC/ZKJ等交易对）</li>
                            <li><strong>不计入统计：</strong>普通USDT/USDC转账、流入、流出不计入买卖统计</li>
                        </ul>
                    </div>
                    
                    <div class="row mt-3">
                        <div class="col-12">
                            <button type="submit" class="btn btn-primary">
                                <span class="normal-text">分析</span>
                                <span class="spinner-border spinner-border-sm hidden" id="submitSpinner" role="status"></span>
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <div id="errorMessage" class="alert alert-danger hidden" role="alert"></div>
        <div id="loader" class="loader hidden">
            <div class="loading-spinner"></div>
            <div class="loading-text">正在分析交易数据...</div>
            <div class="loading-progress">
                <div class="loading-progress-bar" style="width: 0%"></div>
            </div>
            <div id="loading-detail" class="loading-text"></div>
        </div>

        <div id="resultContainer" class="hidden">
            <div class="card mb-4">
                <div class="card-header">
                    <h4>分析结果</h4>
                    <p class="text-muted mb-0" id="timeRangeInfo"></p>
                </div>
            </div>

            <!-- 账户分析结果容器 -->
            <div id="accountsContainer"></div>

            <div id="noTradesMessage" class="alert alert-info hidden">在指定时间范围内没有找到USDT买卖</div>
        </div>
        
        <div class="mt-4 text-center">
            <p class="text-muted mb-2">
                作者: 东东 
                <a href="https://x.com/lumaodaren" target="_blank" class="text-decoration-none">
                    <i class="bi bi-twitter-x"></i> @lumaodaren
                </a>
            </p>
            <p class="text-muted">
                <a href="https://github.com/sincitysh/bscalpha" target="_blank" class="text-decoration-none">
                    <i class="bi bi-github"></i> 查看源码
                </a>
                |
                本工具在GitHub Pages上运行，无需服务器
            </p>
        </div>
    </div>

    <!-- 添加Web3.js库 -->
    <script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>
    
    <!-- 添加Bootstrap的JavaScript依赖 -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // 1. 修复时间戳问题 - 彻底重写formatTime函数
        function formatTime(ts) {
            // 确保ts是数字
            let timestamp = typeof ts === 'string' ? parseInt(ts) : ts;
            
            // 创建日期对象
            const date = new Date(timestamp * 1000);
            
            // 格式化为本地时间字符串（不做年份修改）
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            }).replace(/\//g, '-');
        }

        function formatDateTime(date) {
            if (!(date instanceof Date) || isNaN(date.getTime())) {
                console.warn('无效的日期对象:', date);
                return new Date().toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false
                }).replace(/\//g, '-');
            }
            
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            }).replace(/\//g, '-');
        }

        const USDT_CONTRACT = '0x55d398326f99059fF775485246999027B3197955';
        
        // 添加USDC合约地址
        const USDC_CONTRACT = '0x8AC76a51cc950d9822D68b83fE1Ad97B32Cd580d';
        
        // 稳定币配置
        const STABLECOINS = {
            'USDT': {
                contract: USDT_CONTRACT.toLowerCase(),
                symbol: 'USDT',
                name: 'Tether USD',
                decimals: 18
            },
            'USDC': {
                contract: USDC_CONTRACT.toLowerCase(), 
                symbol: 'USDC',
                name: 'USD Coin',
                decimals: 18
            }
        };
        
        // 稳定币合约地址列表
        const STABLECOIN_CONTRACTS = [USDT_CONTRACT.toLowerCase(), USDC_CONTRACT.toLowerCase()];

        const BSCSCAN_API_KEYS = [
            'GFCARE1KCXRXZUTWYCRV9K65Q1V8BXZU3K',
            'AMQYJJTKB7H8GGSDY3K42G989M6S7INCFG',
            'R613WACX85IZPMASA6K8EAXTT85JQQG6J8',
            'W8U2D8MVYQCVN2TR1FU5IJB186436997CF',
            'T8RZ9IAIMPPDE665TSIP14Y3RYAWK23W3I'
        ];

        function getRandomApiKey() {
            const randomIndex = Math.floor(Math.random() * BSCSCAN_API_KEYS.length);
            return BSCSCAN_API_KEYS[randomIndex];
        }

        const DEX_ROUTER_LIST = [
            '0x10ed43c718714eb63d5aa57b78b54704e256024e', // PancakeSwap v2
            '0x05fF2B0DB69458A0750badebc4f9e13aDd608C7F', // PancakeSwap v1
            '0x3a6d8ca21d1cf76f653a67577fa0d27453350dd8', // BiSwap
            '0xcDe540d7eAFE93aC5fE6233Bee57E1270D3E330F', // BakerySwap
            '0xC0788A3aD43d79aa53B09c2EaCc313A787d1d607', // ApeSwap
            '0x7a6e4e3cc2ac9924605dc68f5d95e75e5f629b31', // Mdex Router
            '0x1b96b92314c44b159149f7e0303511fb2fc4774f', // PancakeSwap v2 (老路由)
            '0x1111111254eeb25477b68fb85ed929f73a960582', // 1inch v4 Router
            '0x11111112542d85b3ef69ae05771c2dccff4faa26', // 1inch v3 Router
            '0x111111125434b319222cdbf8c261674adb56f3ae', // 1inch v2 Router
            '0x72c30ba151f8a9d9372e887a41e577d8b49dda6c', // LiquidMesh Router (新增)
        ];

        // 定义路由地址
        const routerAddresses = {
            'PancakeSwap': '0x10ED43C718714eb63d5aA57B78B54704E256024E'.toLowerCase(),
            'BiSwap': '0x3a6d8cA21D1CF76F653A67577FA0D27453350dD8'.toLowerCase(),
            'BaseSwap': '0x13f4EA83D0bd40E75C8222255bc855a974568Dd4'.toLowerCase(),
            'BaseSwapRouter': '0xb300000b72deaeb607a12d5f54773d1c19c7028d'.toLowerCase(), // 确保这个地址正确添加
            'LiquidMesh': '0x72c30ba151f8a9d9372e887a41e577d8b49dda6c'.toLowerCase(), // 新增
            // ... 其他地址 ...
        };

        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('analyzeForm');
            const loader = document.getElementById('loader');
            const errorMessage = document.getElementById('errorMessage');
            const resultContainer = document.getElementById('resultContainer');
            const submitSpinner = document.getElementById('submitSpinner');
            const noTradesMessage = document.getElementById('noTradesMessage');
            
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                // 获取并处理钱包地址
                const addressesText = form.querySelector('.wallet-addresses').value;
                const addressEntries = addressesText.split('\n')
                    .map(line => {
                        const parts = line.trim().split(/[\s\t]+/);
                        if (parts.length >= 2) {
                            return {
                                name: parts[0],
                                address: parts[parts.length - 1].trim()
                            };
                        } else if (parts.length === 1 && parts[0]) {
                            return {
                                name: '未命名',
                                address: parts[0].trim()
                            };
                        }
                        return null;
                    })
                    .filter(Boolean);
                
                // 验证地址
                for (const entry of addressEntries) {
                    if (!isValidAddress(entry.address)) {
                        errorMessage.textContent = `无效的钱包地址格式: ${entry.address}`;
                        errorMessage.classList.remove('hidden');
                        return;
                    }
                }

                if (addressEntries.length === 0) {
                    errorMessage.textContent = '请至少输入一个钱包地址';
                    errorMessage.classList.remove('hidden');
                    return;
                }
                
                const date = document.getElementById('date').value;
                
                console.log('开始分析，输入的钱包地址：', addressesText);
                console.log('解析后的地址对象：', addressEntries);
                console.log('选择的日期：', date);
                
                // 显示加载状态
                toggleLoading(true);
                errorMessage.classList.add('hidden');
                errorMessage.textContent = '';
                resultContainer.classList.add('hidden');
                
                try {
                    // 获取时间范围
                    const timeRange = getTimeRange(date);
                    console.log('📅 统计时间范围:', timeRange);
                    
                    // 并行获取BNB价格和USDT价格
                    const [bnbPrice, usdtPrice] = await Promise.all([
                        getBNBPrice(),
                        getUSDTPrice()
                    ]);
                    
                    console.log(`💰 当前价格: BNB=${bnbPrice} USDT, USDT=${usdtPrice} USD`);
                    
                    // 🚀 使用新的ApiUtils批量处理 - 参考alpha.dog模式
                    console.log(`🚀 使用高效批量处理模式处理 ${addressEntries.length} 个地址...`);
                    
                    // 进度回调函数
                    const progressCallback = (completed, total, currentName, error = null) => {
                        const progress = Math.round((completed / total) * 100);
                        document.getElementById('loading-detail').textContent = 
                            error ? `处理 ${currentName}: 失败 (${error})` : `处理 ${currentName}: 完成`;
                        document.querySelector('.loading-progress-bar').style.width = `${progress}%`;
                    };
                    
                    // 批量获取所有地址的交易数据
                    const addressResults = await USDTApiUtils.fetchMultipleAddressesData(
                        addressEntries, 
                        timeRange, 
                        progressCallback
                    );
                    
                    // 处理结果，分析USDT交易
                    const allAnalysis = [];
                    const errors = [];
                    
                    console.log(`🔍 开始分析 ${addressResults.length} 个地址的交易数据...`);
                    
                    for (const result of addressResults) {
                        if (result.success) {
                            try {
                                console.log(`📊 分析 ${result.entry.name} 的交易...`);
                                
                                // 获取USDT余额
                                const balance = await getUSDTBalance(result.entry.address);
                                
                                // 使用超快分析函数
                                const analysis = await analyzeFast(
                                    result.entry, 
                                    result.data, 
                                    timeRange, 
                                    usdtPrice, 
                                    bnbPrice, 
                                    balance
                                );
                                
                                allAnalysis.push(analysis);
                                console.log(`✅ ${result.entry.name}: 超快分析完成 - 买入:${analysis.totalBuyValue.toFixed(2)} 卖出:${analysis.totalSellValue.toFixed(2)} 净盈亏:${analysis.netProfitLoss.toFixed(2)}`);
                                
                            } catch (e) {
                                console.error(`❌ 分析 ${result.entry.name} 失败:`, e);
                                errors.push(`${result.entry.name}: 分析失败 - ${e.message}`);
                            }
                        } else {
                            errors.push(`${result.entry.name}: 数据获取失败 - ${result.error}`);
                        }
                    }
                    
                    console.log(`🎯 处理完成: ${allAnalysis.length}成功, ${errors.length}失败`);
                    
                    // 如果有错误但仍有一些成功的结果，显示详细警告
                    if (errors.length > 0) {
                        const warningDiv = document.createElement('div');
                        warningDiv.className = 'alert alert-warning';
                        
                        const successCount = allAnalysis.length;
                        const totalCount = addressEntries.length;
                        
                        warningDiv.innerHTML = `
                            <h5>⚠️ 处理结果: ${successCount}/${totalCount} 个地址成功</h5>
                            <div class="row">
                                <div class="col-md-6">
                                    <h6 class="text-success">✅ 成功处理的地址:</h6>
                                    <ul class="mb-0">
                                        ${allAnalysis.map(analysis => `<li><strong>${analysis.name}</strong> - ${analysis.trades.length}条交易</li>`).join('')}
                                    </ul>
                                </div>
                                <div class="col-md-6">
                                    <h6 class="text-danger">❌ 处理失败的地址:</h6>
                                    <ul class="mb-0">
                                        ${errors.map(err => `<li>${err}</li>`).join('')}
                                    </ul>
                                </div>
                            </div>
                            <div class="mt-3">
                                <small class="text-muted">
                                    <i class="bi bi-info-circle"></i> 
                                    失败原因可能包括：API限制、网络超时、地址无交易记录等。您可以稍后重试失败的地址。
                                </small>
                            </div>
                        `;
                        resultContainer.insertBefore(warningDiv, resultContainer.firstChild);
                    }
                    
                    // 如果完全没有数据，显示详细错误信息
                    if (allAnalysis.length === 0) {
                        if (errors.length > 0) {
                            const errorDiv = document.createElement('div');
                            errorDiv.className = 'alert alert-danger';
                            errorDiv.innerHTML = `
                                <h5>❌ 所有地址处理失败</h5>
                                <p><strong>失败的地址和原因：</strong></p>
                                <ul>
                                    ${errors.map(err => `<li>${err}</li>`).join('')}
                                </ul>
                                <hr>
                                <h6>可能的解决方案：</h6>
                                <ul class="mb-0">
                                    <li>检查钱包地址格式是否正确</li>
                                    <li>确认地址在指定时间范围内有交易</li>
                                    <li>稍等几分钟后重试（可能遇到API限制）</li>
                                    <li>尝试减少同时查询的地址数量</li>
                                </ul>
                            `;
                            resultContainer.appendChild(errorDiv);
                            resultContainer.classList.remove('hidden');
                        } else {
                            resultContainer.classList.remove('hidden');
                            noTradesMessage.classList.remove('hidden');
                            document.getElementById('timeRangeInfo').textContent = `统计时间: ${formatDateTime(timeRange.startDate)} 至 ${formatDateTime(timeRange.endDate)}`;
                        }
                        return;
                    }
                    
                    // 渲染结果
                    await renderResults({
                        success: true,
                        addressEntries: allAnalysis.map(analysis => ({
                            name: analysis.name,
                            address: analysis.address
                        })),
                        allAnalysis
                    });
                    
                    resultContainer.classList.remove('hidden');
                    console.log(`🎉 全部完成! 总共分析了 ${allAnalysis.length} 个地址`);
                } catch (error) {
                    console.error('分析失败:', error);
                    errorMessage.textContent = error.message || '处理请求时发生错误';
                    errorMessage.classList.remove('hidden');
                } finally {
                    toggleLoading(false);
                }
            });
            
            function toggleLoading(isLoading) {
                if (isLoading) {
                    loader.classList.remove('hidden');
                    submitSpinner.classList.remove('hidden');
                    document.querySelector('.normal-text').classList.add('hidden');
                    document.querySelector('.loading-progress-bar').style.width = '0%';
                    document.getElementById('loading-detail').textContent = '准备分析...';
                } else {
                    loader.classList.add('hidden');
                    submitSpinner.classList.add('hidden');
                    document.querySelector('.normal-text').classList.remove('hidden');
                }
            }
            
            function isValidAddress(address) {
                return /^0x[a-fA-F0-9]{40}$/.test(address);
            }
            
            // 获取USDT价格（USDT对USDT永远是1）
            async function getUSDTPrice() {
                return 1;
            }
            
            // 使用缓存减少重复请求
            const receiptCache = new Map();
            const txDetailCache = new Map();
            const balanceCache = new Map();
            
            // 添加延迟函数
            function sleep(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
            
            // 优化getTxReceipt函数 - 添加缓存和减少重试
            async function getTxReceipt(txHash) {
                if (receiptCache.has(txHash)) return receiptCache.get(txHash);
                
                try {
                    const url = `https://api.bscscan.com/api?module=proxy&action=eth_getTransactionReceipt&txhash=${txHash}&apikey=${getRandomApiKey()}`;
                    const res = await fetch(url);
                    const data = await res.json();
                    
                    if (data.result) {
                        receiptCache.set(txHash, data.result);
                        return data.result;
                    }
                    return null;
                } catch (e) {
                    console.warn(`获取交易收据失败: ${txHash.slice(0, 10)}...`);
                    return null;
                }
            }
            
            // 优化getTxDetail函数 - 添加缓存和减少重试
            async function getTxDetail(txHash) {
                if (txDetailCache.has(txHash)) return txDetailCache.get(txHash);
                
                try {
                    const url = `https://api.bscscan.com/api?module=proxy&action=eth_getTransactionByHash&txhash=${txHash}&apikey=${getRandomApiKey()}`;
                    const res = await fetch(url);
                    const data = await res.json();
                    
                    if (data.result) {
                        txDetailCache.set(txHash, data.result);
                        return data.result;
                    }
                    return null;
                } catch (e) {
                    console.warn(`获取交易详情失败: ${txHash.slice(0, 10)}...`);
                    return null;
                }
            }
            
            // 优化getUSDTBalance函数 - 添加缓存
            async function getUSDTBalance(address) {
                if (balanceCache.has(address)) {
                    return balanceCache.get(address);
                }
                
                try {
                    const url = `https://api.bscscan.com/api?module=account&action=tokenbalance&contractaddress=${USDT_CONTRACT}&address=${address}&tag=latest&apikey=${getRandomApiKey()}`;
                    const res = await fetch(url);
                    const data = await res.json();
                    const balance = parseFloat(data.result) / 1e18;
                    balanceCache.set(address, balance);
                    return balance;
                } catch (e) {
                    console.warn(`获取USDT余额失败: ${address}`);
                    return 0;
                }
            }
            
            // 获取USDC余额
            async function getUSDCBalance(address) {
                const cacheKey = `${address}_USDC`;
                if (balanceCache.has(cacheKey)) {
                    return balanceCache.get(cacheKey);
                }
                
                try {
                    const url = `https://api.bscscan.com/api?module=account&action=tokenbalance&contractaddress=${USDC_CONTRACT}&address=${address}&tag=latest&apikey=${getRandomApiKey()}`;
                    const res = await fetch(url);
                    const data = await res.json();
                    const balance = parseFloat(data.result) / 1e18;
                    balanceCache.set(cacheKey, balance);
                    return balance;
                } catch (e) {
                    console.warn(`获取USDC余额失败: ${address}`);
                    return 0;
                }
            }
            
            // 获取所有稳定币余额
            async function getAllStablecoinBalances(address) {
                try {
                    const [usdtBalance, usdcBalance] = await Promise.all([
                        getUSDTBalance(address),
                        getUSDCBalance(address)
                    ]);
                    
                    return {
                        USDT: usdtBalance,
                        USDC: usdcBalance,
                        total: usdtBalance + usdcBalance
                    };
                } catch (e) {
                    console.warn(`获取稳定币余额失败: ${address}`);
                    return {
                        USDT: 0,
                        USDC: 0,
                        total: 0
                    };
                }
            }
            
            // 获取地址交易
            async function getTxList(address, timeRange) {
                const url = `https://api.bscscan.com/api?module=account&action=txlist&address=${address}&startblock=0&endblock=99999999&starttime=${timeRange.start}&endtime=${timeRange.end}&sort=asc&apikey=${getRandomApiKey()}`;
                const res = await fetch(url);
                const data = await res.json();
                if (!Array.isArray(data.result)) {
                    console.error('BscScan返回异常:', data);
                    return [];
                }
                return data.result;
            }
            
            // 优化后的getUSDTTransfers函数 - 修复区块范围问题
            async function getUSDTTransfers(address, timeRange, txLimit) {
                console.log(`🚀 开始获取 ${address.slice(0, 8)}...${address.slice(-6)} 的交易数据`);
                
                try {
                    // 动态计算区块范围，确保覆盖指定时间
                    let startBlock, endBlock;
                    
                    try {
                        // 尝试动态获取区块号
                        console.log(`🔍 获取时间 ${new Date(timeRange.start*1000).toLocaleString()} 对应的区块号...`);
                        startBlock = await getBlockByTimestamp(timeRange.start, 'before');
                        
                        console.log(`🔍 获取时间 ${new Date(timeRange.end*1000).toLocaleString()} 对应的区块号...`);
                        endBlock = await getBlockByTimestamp(timeRange.end, 'after');
                        
                        console.log(`📦 ${address.slice(0, 8)}... 动态区块范围: ${startBlock} - ${endBlock}`);
                    } catch (e) {
                        // 如果动态获取失败，使用更大的固定范围
                        console.warn(`⚠️ 动态获取区块号失败，使用扩大的固定范围:`, e.message);
                        const currentBlock = 50200000; // 基准区块
                        startBlock = Math.max(0, currentBlock - 200000); // 扩大到20万个区块
                        endBlock = currentBlock + 50000; // 向后扩展5万个区块
                        
                        console.log(`📦 ${address.slice(0, 8)}... 扩大固定区块范围: ${startBlock} - ${endBlock}`);
                    }
                    
                    // 优化的fetch函数，增加更长的延迟和更好的错误处理
                    const fetchData = async (url, description) => {
                        try {
                            console.log(`🔄 ${address.slice(0, 8)}... ${description}...`);
                            
                            // 增加延迟避免API限制
                            await sleep(1000); // 1秒延迟
                            
                            const res = await fetch(url);
                            const data = await res.json();
                            
                            console.log(`📡 ${address.slice(0, 8)}... API响应:`, data.status, data.message);
                            
                            if (data.status === '1' && Array.isArray(data.result)) {
                                console.log(`✅ ${address.slice(0, 8)}... ${description}: ${data.result.length}条`);
                                
                                // 检查时间范围
                                if (data.result.length > 0) {
                                    const times = data.result.map(tx => parseInt(tx.timeStamp));
                                    const minTime = Math.min(...times);
                                    const maxTime = Math.max(...times);
                                    console.log(`⏰ ${address.slice(0, 8)}... 数据时间范围: ${new Date(minTime*1000).toLocaleString()} - ${new Date(maxTime*1000).toLocaleString()}`);
                                    console.log(`🎯 ${address.slice(0, 8)}... 目标时间范围: ${new Date(timeRange.start*1000).toLocaleString()} - ${new Date(timeRange.end*1000).toLocaleString()}`);
                                }
                                
                                return data.result;
                            } else if (data.status === '0' && (data.message.includes('No transactions found') || data.message.includes('No records found'))) {
                                console.log(`ℹ️ ${address.slice(0, 8)}... ${description}: 无记录`);
                                return [];
                            } else {
                                console.warn(`⚠️ ${address.slice(0, 8)}... ${description}失败:`, data.message);
                                // 如果是限制错误，等待更长时间
                                if (data.message && data.message.includes('rate limit')) {
                                    console.log(`⏳ API限制，等待5秒...`);
                                    await sleep(5000);
                                }
                                return [];
                            }
                        } catch (e) {
                            console.error(`❌ ${address.slice(0, 8)}... ${description}出错:`, e.message);
                            return []; // 出错时返回空数组而不是抛出错误
                        }
                    };
                    
                    // 串行获取以避免API限制（不再并行）
                    const tokenTxUrl = `https://api.bscscan.com/api?module=account&action=tokentx&contractaddress=${USDT_CONTRACT}&address=${address}&startblock=${startBlock}&endblock=${endBlock}&sort=asc&apikey=${getRandomApiKey()}`;
                    const normalTxUrl = `https://api.bscscan.com/api?module=account&action=txlist&address=${address}&startblock=${startBlock}&endblock=${endBlock}&sort=asc&apikey=${getRandomApiKey()}`;
                    
                    console.log(`🔄 ${address.slice(0, 8)}... 开始串行获取数据...`);
                    
                    // 先获取USDT转账
                    const tokenTxs = await fetchData(tokenTxUrl, "USDT转账");
                    
                    // 等待更长时间再获取普通交易
                    console.log(`⏳ ${address.slice(0, 8)}... 等待2秒后获取普通交易...`);
                    await sleep(2000);
                    
                    const normalTxs = await fetchData(normalTxUrl, "普通交易");
                    
                    // 快速合并和过滤 - 严格按时间范围过滤
                    const hashSet = new Set();
                    const mergedTxs = [];
                    
                    // 处理USDT代币转账 - 添加详细的过滤日志
                    let filteredTokenTxs = 0;
                    let validTokenTxs = 0;
                    for (const tx of tokenTxs) {
                        const time = parseInt(tx.timeStamp);
                        if (time >= timeRange.start && time < timeRange.end) {
                            hashSet.add(tx.hash);
                            mergedTxs.push(tx);
                            validTokenTxs++;
                            console.log(`✅ ${address.slice(0, 8)}... 包含USDT转账: ${tx.hash}, 时间: ${new Date(time*1000).toLocaleString()}`);
                        } else {
                            filteredTokenTxs++;
                            console.log(`⏰ ${address.slice(0, 8)}... 时间过滤USDT转账: ${tx.hash}, 时间: ${new Date(time*1000).toLocaleString()}, 超出范围`);
                        }
                    }
                    
                    console.log(`📊 ${address.slice(0, 8)}... USDT转账统计: 有效${validTokenTxs}条, 过滤${filteredTokenTxs}条`);
                    
                    // 处理普通交易 - 也要严格按时间过滤，但添加详细日志
                    let relevantCount = 0;
                    let filteredNormalTxs = 0;
                    let validNormalTxs = 0;
                    
                    for (const tx of normalTxs) {
                        const time = parseInt(tx.timeStamp);
                        
                        if (time < timeRange.start || time >= timeRange.end) {
                            filteredNormalTxs++;
                            console.log(`⏰ ${address.slice(0, 8)}... 时间过滤普通交易: ${tx.hash}, 时间: ${new Date(time*1000).toLocaleString()}, 超出范围`);
                            continue;
                        }
                        
                        validNormalTxs++;
                        
                        if (hashSet.has(tx.hash)) {
                            console.log(`🔄 ${address.slice(0, 8)}... 跳过重复交易: ${tx.hash}`);
                            continue;
                        }
                        
                        // 快速预筛选
                        if (!tx.input || tx.input === '0x') {
                            console.log(`📝 ${address.slice(0, 8)}... 跳过无input交易: ${tx.hash}`);
                            continue;
                        }
                        
                        const methodId = tx.input.slice(0, 10).toLowerCase();
                        
                        // 只处理明确的swap方法或特殊方法
                        const importantMethods = [
                            '0xa03de6a9', '0x7c025200', '0x84bd6d29', '0x12aa3caf', 
                            '0xe5e8894b', '0x7ff36ab5', '0x38ed1739', '0x18cbafe5',
                            '0xe19c2253', '0x0d46641a' // 特殊方法
                        ];
                        
                        const isDEXRouter = DEX_ROUTER_LIST.includes(tx.to?.toLowerCase());
                        const isUSDTContract = tx.to?.toLowerCase() === USDT_CONTRACT.toLowerCase();
                        const isImportantMethod = importantMethods.includes(methodId);
                        
                        console.log(`🔍 ${address.slice(0, 8)}... 检查交易 ${tx.hash}:`);
                        console.log(`   方法ID: ${methodId}`);
                        console.log(`   目标地址: ${tx.to}`);
                        console.log(`   是DEX路由: ${isDEXRouter}`);
                        console.log(`   是USDT合约: ${isUSDTContract}`);
                        console.log(`   是重要方法: ${isImportantMethod}`);
                        
                        if (isDEXRouter || isUSDTContract || isImportantMethod) {
                            // 直接添加，不做复杂的Receipt检查
                            tx.contractAddress = USDT_CONTRACT;
                            mergedTxs.push(tx);
                            hashSet.add(tx.hash);
                            relevantCount++;
                            console.log(`✅ ${address.slice(0, 8)}... 包含相关交易: ${tx.hash}, 原因: ${isDEXRouter ? 'DEX路由' : isUSDTContract ? 'USDT合约' : '重要方法'}`);
                        } else {
                            console.log(`❌ ${address.slice(0, 8)}... 跳过不相关交易: ${tx.hash}`);
                        }
                    }
                    
                    console.log(`📊 ${address.slice(0, 8)}... 普通交易统计: 时间范围内${validNormalTxs}条, 相关${relevantCount}条, 过滤${filteredNormalTxs}条`);
                    
                    if (filteredNormalTxs > 0) {
                        console.log(`🔍 ${address.slice(0, 8)}... 时间过滤: 移除${filteredNormalTxs}条超出范围的普通交易`);
                    }
                    
                    console.log(`�� ${address.slice(0, 8)}... 快速筛选: 添加${relevantCount}条可能相关的普通交易`);
                    console.log(`�� ${address.slice(0, 8)}... 最终获得 ${mergedTxs.length} 条相关交易`);
                    
                    return mergedTxs;
                } catch (error) {
                    console.error(`💥 ${address.slice(0, 8)}... 处理失败:`, error);
                    throw new Error(`获取${address.slice(0, 8)}...的交易数据失败: ${error.message}`);
                }
            }
            
            // 批量处理相关交易
            async function processRelevantTransactions(relevantTxs, mergedTxs, hashSet) {
                const batchSize = 5; // 每批处理5个交易
                
                for (let i = 0; i < relevantTxs.length; i += batchSize) {
                    const batch = relevantTxs.slice(i, i + batchSize);
                    console.log(`⚙️ 处理交易批次 ${Math.floor(i/batchSize) + 1}/${Math.ceil(relevantTxs.length/batchSize)} (${batch.length}条)`);
                    
                    // 并行处理这一批交易
                    const results = await Promise.allSettled(
                        batch.map(tx => processTransaction(tx))
                    );
                    
                    // 添加成功处理的交易
                    for (let j = 0; j < results.length; j++) {
                        const result = results[j];
                        const tx = batch[j];
                        
                        if (result.status === 'fulfilled' && result.value) {
                            tx.contractAddress = USDT_CONTRACT;
                            mergedTxs.push(tx);
                            hashSet.add(tx.hash);
                            console.log(`✅ 添加交易: ${tx.hash.slice(0, 10)}...`);
                        }
                    }
                    
                    // 小延迟避免API限制
                    if (i + batchSize < relevantTxs.length) {
                        await sleep(200); // 减少到200ms
                    }
                }
            }
            
            // 处理单个交易
            async function processTransaction(tx) {
                try {
                    const methodId = tx.input?.slice(0, 10).toLowerCase();
                    
                    // 特殊方法ID直接通过
                    if (methodId === '0xe19c2253' || methodId === '0x0d46641a') {
                        return true;
                    }
                    
                    // USDT合约直接交互
                    if (tx.to?.toLowerCase() === USDT_CONTRACT.toLowerCase()) {
                        return true;
                    }
                    
                    // 检查swap交易是否涉及USDT
                    const receipt = await getTxReceipt(tx.hash);
                    if (receipt?.logs) {
                        const ERC20_TRANSFER_TOPIC = '0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef';
                        return receipt.logs.some(log => 
                            log.address.toLowerCase() === USDT_CONTRACT.toLowerCase() && 
                            log.topics[0] === ERC20_TRANSFER_TOPIC
                        );
                    }
                    
                    return false;
                } catch (error) {
                    console.warn(`⚠️ 处理交易失败 ${tx.hash}: ${error.message}`);
                    return false;
                }
            }
            
            // 优化区块号获取函数 - 改进错误处理
            const blockCache = new Map();
            async function getBlockByTimestamp(timestamp, closest = 'before') {
                const cacheKey = `${timestamp}_${closest}`;
                if (blockCache.has(cacheKey)) {
                    console.log(`📦 使用缓存的区块号: ${blockCache.get(cacheKey)}`);
                    return blockCache.get(cacheKey);
                }
                
                let retries = 3;
                while (retries > 0) {
                    try {
                        console.log(`🔍 获取区块号 (剩余重试${retries}次): ${new Date(timestamp*1000).toLocaleString()}`);
                        const url = `https://api.bscscan.com/api?module=block&action=getblocknobytime&timestamp=${timestamp}&closest=${closest}&apikey=${getRandomApiKey()}`;
                        const res = await fetch(url);
                        const data = await res.json();
                        
                        console.log(`📡 区块号API响应:`, data.status, data.message);
                        
                        if (data.status === '1' && data.result) {
                            const blockNumber = parseInt(data.result);
                            if (blockNumber > 0) {
                                blockCache.set(cacheKey, blockNumber);
                                console.log(`✅ ${new Date(timestamp*1000).toLocaleString()} → 区块 ${blockNumber}`);
                                return blockNumber;
                            }
                        }
                        
                        console.warn(`⚠️ 获取区块号失败: ${data.message || '无效响应'}`);
                        retries--;
                        if (retries > 0) {
                            console.log(`⏳ 等待2秒后重试...`);
                            await sleep(2000);
                        }
                    } catch (error) {
                        console.error(`❌ 获取区块号出错: ${error.message}`);
                        retries--;
                        if (retries > 0) {
                            console.log(`⏳ 等待2秒后重试...`);
                            await sleep(2000);
                        }
                    }
                }
                
                // 所有重试都失败，使用合理的默认值
                console.warn(`⚠️ 获取区块号最终失败，使用默认值`);
                const defaultBlock = closest === 'before' ? Math.max(0, 50000000) : 50300000;
                blockCache.set(cacheKey, defaultBlock);
                return defaultBlock;
            }
            
            // 修改analyzeTransactions函数，减少API调用
            async function analyzeTransactions(addressInfo, transfers, timeRange, usdtPrice, bnbPrice, usdtBalance) {
                console.log(`🔍 开始分析 ${addressInfo.name} 的 ${transfers.length} 条交易`);
                
                // 验证所有交易的时间范围
                const invalidTimeTransfers = transfers.filter(tx => {
                    const time = parseInt(tx.timeStamp);
                    return time < timeRange.start || time >= timeRange.end;
                });
                
                if (invalidTimeTransfers.length > 0) {
                    console.warn(`⚠️ ${addressInfo.name}: 发现${invalidTimeTransfers.length}条超出时间范围的交易`);
                    invalidTimeTransfers.forEach(tx => {
                        const time = parseInt(tx.timeStamp);
                        console.log(`   - ${tx.hash}: ${new Date(time*1000).toLocaleString()} (应在 ${new Date(timeRange.start*1000).toLocaleString()} - ${new Date(timeRange.end*1000).toLocaleString()})`);
                    });
                }
                
                // 过滤出直接相关且在时间范围内的交易
                const address = addressInfo.address.toLowerCase();
                const relevantTransfers = transfers.filter(tx => {
                    const time = parseInt(tx.timeStamp);
                    const isInTimeRange = time >= timeRange.start && time < timeRange.end;
                    const isRelevant = tx.from?.toLowerCase() === address || tx.to?.toLowerCase() === address || tx.contractAddress?.toLowerCase() === USDT_CONTRACT.toLowerCase();
                    
                    if (!isInTimeRange) {
                        console.log(`⏰ 时间过滤: ${tx.hash} 时间${new Date(time*1000).toLocaleString()} 超出范围`);
                    }
                    
                    return isInTimeRange && isRelevant;
                });
                
                console.log(`✅ ${addressInfo.name}: 时间和相关性过滤后剩余 ${relevantTransfers.length} 条交易`);
                
                // 添加交易详细检查
                if (relevantTransfers.length > 0) {
                    console.log(`🔍 ${addressInfo.name} 交易详情检查:`);
                    relevantTransfers.forEach((tx, index) => {
                        const time = parseInt(tx.timeStamp);
                        console.log(`   ${index + 1}. ${tx.hash}:`);
                        console.log(`      时间: ${new Date(time*1000).toLocaleString()}`);
                        console.log(`      从: ${tx.from}`);
                        console.log(`      到: ${tx.to}`);
                        console.log(`      合约: ${tx.contractAddress || '无'}`);
                        console.log(`      金额: ${tx.value || '0'}`);
                        console.log(`      input: ${tx.input ? tx.input.slice(0, 20) + '...' : '无'}`);
                    });
                }
                
                // 按交易哈希分组
                const grouped = groupByHash(relevantTransfers);
                console.log(`【${addressInfo.name}】USDT转账分组（按hash）:`, grouped.map(g => g[0].hash));
                
                const trades = [];
                const unknownTrades = [];
                let totalBuy = 0, totalSell = 0, totalGasCost = 0;
                
                // 确保bnbPrice是有效的数字
                if (isNaN(bnbPrice) || bnbPrice <= 0) {
                    console.warn(`检测到无效的BNB价格: ${bnbPrice}，使用默认价格660`);
                    bnbPrice = 660;
                }
                
                // 🚀 批量处理USDT转账 - 参考alpha.dog的高效方式
                console.log(`🚀 开始批量处理 ${grouped.length} 个交易组...`);
                
                // 添加转账类型判断函数
                function isSimpleUSDTTransfer(tx) {
                    // 1. 检查是否涉及DEX路由
                    if (DEX_ROUTER_LIST.includes(tx.to?.toLowerCase()) || 
                        DEX_ROUTER_LIST.includes(tx.from?.toLowerCase())) {
                        return false;
                    }
                    
                    // 2. 检查input是否为复杂调用
                    if (tx.input && tx.input.length > 10) {
                        const methodId = tx.input.slice(0, 10).toLowerCase();
                        const swapMethods = [
                            '0xa03de6a9', '0x7c025200', '0x84bd6d29', '0x12aa3caf',
                            '0xe5e8894b', '0x7ff36ab5', '0x38ed1739', '0x18cbafe5'
                        ];
                        if (swapMethods.includes(methodId)) {
                            return false;
                        }
                        if (methodId === '0xa9059cbb') {
                            return true;
                        }
                    }
                    
                    // 3. 如果to地址是USDT合约，且是简单调用
                    if (tx.to?.toLowerCase() === USDT_CONTRACT.toLowerCase()) {
                        return true;
                    }
                    
                    return false;
                }
                
                // 筛选出需要获取Receipt的交易
                const needReceiptTxs = [];
                const directProcessTxs = [];
                
                for (const txGroup of grouped) {
                    const tx = txGroup[0];
                    
                    // 检查是否为普通转账
                    if (isSimpleUSDTTransfer(tx)) {
                        console.log(`📤 跳过普通USDT转账: ${tx.hash}`);
                        unknownTrades.push({
                            hash: tx.hash,
                            timestamp: tx.timeStamp,
                            methodId: 'simple_transfer',
                            gasCost: GasUtils.calculateGasFromTx(tx),
                            tokenAddress: USDT_CONTRACT,
                            note: '普通USDT转账（未计入买卖统计）'
                        });
                        continue;
                    }
                    
                    if (tx.contractAddress?.toLowerCase() === USDT_CONTRACT.toLowerCase()) {
                        if (tx.value && tx.value !== '0') {
                            // 可以直接处理的USDT交易
                            directProcessTxs.push({ txGroup, tx, amount: parseFloat(tx.value) / 1e18 });
                        } else {
                            // 需要从Receipt解析的交易
                            needReceiptTxs.push({ txGroup, tx });
                        }
                    }
                }
                
                console.log(`📊 处理分类: 直接处理${directProcessTxs.length}个, 需要Receipt${needReceiptTxs.length}个`);
                
                // 处理可以直接处理的交易
                for (const { txGroup, tx, amount } of directProcessTxs) {
                    const time = parseInt(tx.timeStamp);
                    
                    if (amount <= 0) continue;
                    
                    // 使用GasUtils计算真实gas费用
                    const realGasCost = GasUtils.calculateGasFromTx(tx);
                    
                    let trade = null;
                    if (tx.from?.toLowerCase() === address) {
                        trade = {
                            hash: tx.hash,
                            usdtAmount: -amount,
                            tokenAmount: 0,
                            tokenAddress: USDT_CONTRACT,
                            isBuy: true,
                            isSell: false,
                            timestamp: time,
                            gasCost: realGasCost // 使用从交易记录计算的真实Gas费用
                        };
                        totalBuy += amount;
                    } else if (tx.to?.toLowerCase() === address) {
                        trade = {
                            hash: tx.hash,
                            usdtAmount: amount,
                            tokenAmount: 0,
                            tokenAddress: USDT_CONTRACT,
                            isBuy: false,
                            isSell: true,
                            timestamp: time,
                            gasCost: realGasCost // 使用从交易记录计算的真实Gas费用
                        };
                        totalSell += amount;
                    }
                    
                    if (trade) {
                        trades.push(trade);
                        totalGasCost += trade.gasCost;
                        console.log(`✅ 直接处理: ${tx.hash}, ${amount} USDT, ${trade.isBuy ? '买入' : '卖出'}, Gas: ${realGasCost.toFixed(6)} BNB`);
                    }
                }
                
                // 批量获取需要Receipt的交易
                if (needReceiptTxs.length > 0) {
                    console.log(`📦 批量获取 ${needReceiptTxs.length} 个交易的Receipt...`);
                    const txHashes = needReceiptTxs.map(item => item.tx.hash);
                    const receiptResults = await batchGetTxReceipts(txHashes);
                    
                    // 处理Receipt结果
                    for (let i = 0; i < needReceiptTxs.length; i++) {
                        const { txGroup, tx } = needReceiptTxs[i];
                        const { receipt } = receiptResults[i];
                        const time = parseInt(tx.timeStamp);
                        
                        // 使用GasUtils计算真实gas费用
                        const realGasCost = GasUtils.calculateGasFromTx(tx);
                        
                        if (!receipt) {
                            console.log(`⚠️ 跳过无Receipt的交易: ${tx.hash}`);
                            continue;
                        }
                        
                        const transferInfo = parseUSDTTransferFromReceipt(receipt, addressInfo.address);
                        
                        if (!transferInfo || transferInfo.amount <= 0) {
                            console.log(`⚠️ 跳过无效Transfer的交易: ${tx.hash}`);
                            continue;
                        }
                        
                        let trade = null;
                        if (transferInfo.isOutgoing) {
                            trade = {
                                hash: tx.hash,
                                usdtAmount: -transferInfo.amount,
                                tokenAmount: 0,
                                tokenAddress: USDT_CONTRACT,
                                isBuy: true,
                                isSell: false,
                                timestamp: time,
                                gasCost: realGasCost // 使用从交易记录计算的真实Gas费用
                            };
                            totalBuy += transferInfo.amount;
                        } else if (transferInfo.isIncoming) {
                            trade = {
                                hash: tx.hash,
                                usdtAmount: transferInfo.amount,
                                tokenAmount: 0,
                                tokenAddress: USDT_CONTRACT,
                                isBuy: false,
                                isSell: true,
                                timestamp: time,
                                gasCost: realGasCost // 使用从交易记录计算的真实Gas费用
                            };
                            totalSell += transferInfo.amount;
                        }
                        
                        if (trade) {
                            trades.push(trade);
                            totalGasCost += trade.gasCost;
                            console.log(`✅ Receipt处理: ${tx.hash}, ${transferInfo.amount} USDT, ${trade.isBuy ? '买入' : '卖出'}, Gas: ${realGasCost.toFixed(6)} BNB`);
                        }
                    }
                }
                
                console.log(`🎯 ${addressInfo.name} 批量处理完成: ${trades.length}笔交易`);
                
                document.getElementById('loading-detail').textContent = '分析完成';
                
                // 计算结果
                const gasCostInUSDT = totalGasCost * bnbPrice;
                const profitLoss = totalSell - totalBuy;
                const netProfitLoss = profitLoss - gasCostInUSDT;
                
                console.log(`📊 ${addressInfo.name} 分析结果: 买入${totalBuy.toFixed(2)} 卖出${totalSell.toFixed(2)} Gas${totalGasCost.toFixed(4)}BNB`);
                
                // 添加详细的分析摘要
                console.log(`📋 ${addressInfo.name} 详细摘要:`);
                console.log(`   📦 交易总数: ${relevantTransfers.length}`);
                console.log(`   ✅ 已识别交易: ${trades.length}`);
                console.log(`   ❓ 未识别交易: ${unknownTrades.length}`);
                console.log(`   💰 买入操作: ${trades.filter(t => t.isBuy).length}次，总额: ${totalBuy.toFixed(2)} USDT`);
                console.log(`   💸 卖出操作: ${trades.filter(t => t.isSell).length}次，总额: ${totalSell.toFixed(2)} USDT`);
                console.log(`   📈 净盈亏: ${profitLoss.toFixed(2)} USDT (扣除Gas前)`);
                console.log(`   📉 实际盈亏: ${netProfitLoss.toFixed(2)} USDT (扣除Gas后)`);
                
                return {
                    name: addressInfo.name,
                    address: addressInfo.address,
                    trades,
                    unknownTrades,
                    totalBuyValue: totalBuy,
                    totalSellValue: totalSell,
                    profitLoss: profitLoss,
                    netProfitLoss: netProfitLoss,
                    totalGasCost: totalGasCost,
                    gasCostInUSDT: gasCostInUSDT,
                    bnbPrice: bnbPrice,
                    usdtPrice: usdtPrice,
                    usdtBalance: parseFloat(usdtBalance),
                    timeRange
                };
            }
            
            async function renderResults(data) {
                const { addressEntries, allAnalysis } = data;
                const accountsContainer = document.getElementById('accountsContainer');
                accountsContainer.innerHTML = '';

                // 计算总亏损和是否有交易
                let totalLoss = 0;
                let totalTrades = 0;
                allAnalysis.forEach(analysis => {
                    totalLoss += analysis.netProfitLoss < 0 ? Math.abs(analysis.netProfitLoss) : 0;
                    totalTrades += analysis.trades.length;
                });

                // 从第一个分析结果中获取timeRange（所有分析应该使用相同的时间范围）
                const timeRange = allAnalysis.length > 0 ? allAnalysis[0].timeRange : null;

                // 更新时间范围显示（确保timeRange存在）
                if (timeRange) {
                    document.getElementById('timeRangeInfo').textContent = 
                        `统计时间: ${formatDateTime(timeRange.startDate)} 至 ${formatDateTime(timeRange.endDate)}`;
                }

                // 修改渲染结果函数中的总结卡片逻辑
                const summaryCard = document.createElement('div');
                summaryCard.className = 'card mb-4';

                if (totalTrades === 0) {
                    summaryCard.innerHTML = `
                        <div class="card-body bg-info text-white">
                            <h5 class="card-title">⚠️ 未检测到交易记录</h5>
                            <p class="mb-0">可能原因：</p>
                            <ul class="mb-0">
                                <li>今日未进行交易</li>
                                <li>API 访问异常，请稍后重试</li>
                                <li>选择的时间范围内无交易</li>
                            </ul>
                        </div>
                    `;
                } else {
                    // 计算总盈亏
                    let totalProfit = 0;
                    allAnalysis.forEach(analysis => {
                        totalProfit += analysis.netProfitLoss;
                    });
                    
                    // 根据盈亏情况显示不同的信息
                    if (totalProfit > 0) {
                        // 盈利情况
                        const teaEggs = Math.floor(totalProfit / 0.5); // 假设茶叶蛋0.5U一个
                        summaryCard.innerHTML = `
                            <div class="card-body bg-success text-white">
                                <h5 class="card-title">🎉 恭喜你这个交易天才！今日盈利 ${totalProfit.toFixed(2)} USDT</h5>
                                <p class="mb-0">相当于赚了 ${teaEggs} 个茶叶蛋 (按0.5U/个计算)</p>
                                <small>继续保持这样的水平！</small>
                            </div>
                        `;
                    } else if (totalProfit === 0) {
                        // 收支平衡
                        summaryCard.innerHTML = `
                            <div class="card-body bg-warning">
                                <h5 class="card-title">😐 今日收支平衡 ${totalProfit.toFixed(2)} USDT</h5>
                                <p class="mb-0">不赚不亏，保持稳定</p>
                                <small class="text-muted">明天争取有所突破！</small>
                            </div>
                        `;
                    } else if (Math.abs(totalProfit) < 5) {
                        // 小亏
                        const pigFeetMeals = Math.ceil(Math.abs(totalProfit) / 2);
                        summaryCard.innerHTML = `
                            <div class="card-body bg-warning">
                                <h5 class="card-title">😅 今日小亏 ${Math.abs(totalProfit).toFixed(2)} USDT</h5>
                                <p class="mb-0">相当于丢失了 ${pigFeetMeals} 顿猪脚饭 (按2U/顿计算)</p>
                                <small class="text-muted">别灰心，明天会更好！</small>
                            </div>
                        `;
                    } else if (Math.abs(totalProfit) >= 50) {
                        // 大亏
                        const hotPotMeals = Math.ceil(Math.abs(totalProfit) / 50);
                        summaryCard.innerHTML = `
                            <div class="card-body bg-danger text-white">
                                <h5 class="card-title">😱 今日大亏 ${Math.abs(totalProfit).toFixed(2)} USDT</h5>
                                <p class="mb-0">相当于错过了 ${hotPotMeals} 顿海底捞 (按50U/顿计算)</p>
                                <small>建议休息一下，调整心态！</small>
                            </div>
                        `;
                    } else {
                        // 中等亏损
                        const pigFeetMeals = Math.ceil(Math.abs(totalProfit) / 2);
                        summaryCard.innerHTML = `
                            <div class="card-body bg-warning">
                                <h5 class="card-title">😓 今日亏损 ${Math.abs(totalProfit).toFixed(2)} USDT</h5>
                                <p class="mb-0">相当于丢失了 ${pigFeetMeals} 顿猪脚饭 (按2U/顿计算)</p>
                                <small class="text-muted">调整策略，明天继续！</small>
                            </div>
                        `;
                    }
                }

                // 将总结卡片插入到结果容器的开头
                accountsContainer.insertBefore(summaryCard, accountsContainer.firstChild);

                // 继续渲染原有的账户分析结果
                for (let i = 0; i < addressEntries.length; i++) {
                    const entry = addressEntries[i];
                    const analysis = allAnalysis[i];
                    // 获取当前USDT余额
                    const balance = await getUSDTBalance(entry.address);
                    
                    const accountCard = document.createElement('div');
                    accountCard.className = 'card mb-4';
                    accountCard.id = `accountCard_${i}`; // 添加ID以便后续引用
                    accountCard.innerHTML = `
                        <div class="card-header bg-light">
                            <h5 class="mb-0">
                                <i class="bi bi-person-circle"></i> 
                                ${entry.name}
                                <small class="text-muted">${entry.address}</small>
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="stats-box bg-light">
                                        <h6 class="border-bottom pb-2">USDT买卖统计</h6>
                                        <div class="d-flex justify-content-between">
                                            <span>买入总额:</span>
                                            <span class="fw-bold usdt-out">${analysis.totalBuyValue.toFixed(6)} USDT</span>
                                        </div>
                                        <div class="d-flex justify-content-between">
                                            <span>卖出总额:</span>
                                            <span class="fw-bold usdt-in">${analysis.totalSellValue.toFixed(6)} USDT</span>
                                        </div>
                                        <div class="d-flex justify-content-between">
                                            <span>净盈亏:</span>
                                            <span class="fw-bold ${analysis.netProfitLoss >= 0 ? 'usdt-in' : 'usdt-out'}">${analysis.netProfitLoss.toFixed(6)} USDT</span>
                                        </div>
                                        <div class="d-flex justify-content-between">
                                            <span>当前USDT余额:</span>
                                            <span class="fw-bold">${balance.toFixed(6)} USDT</span>
                                        </div>
                                        <div class="d-flex justify-content-between">
                                            <span>总Gas消耗:</span>
                                            <span class="fw-bold">${analysis.totalGasCost.toFixed(6)} BNB ≈ ${analysis.gasCostInUSDT.toFixed(2)} USDT</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-8">
                                    <div class="stats-box bg-light">
                                        <h6 class="border-bottom pb-2">USDT买卖明细</h6>
                                        <div class="table-responsive">
                                            <table class="table table-sm table-bordered">
                                                <thead>
                                                    <tr>
                                                        <th>时间</th>
                                                        <th>类型</th>
                                                        <th>USDT金额</th>
                                                        <th>代币金额</th>
                                                        <th>代币合约</th>
                                                        <th>交易</th>
                                                        <th>Gas费用（BNB）</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    ${
                                                        analysis.trades.length === 0
                                                        ? '<tr><td colspan="7">无USDT买卖记录</td></tr>'
                                                        : analysis.trades.map(d => `
                                                            <tr>
                                                                <td>${formatTime(d.timestamp)}</td>
                                                                <td class="${d.isSpecial ? '' : (d.usdtAmount < 0 ? 'usdt-out' : 'usdt-in')}">
                                                                    ${d.isSpecial ? '特殊USDT交易' : (d.usdtAmount < 0 ? '用USDT买入' : '用其他币换USDT')}
                                                                    ${d.methodId ? `<small class="text-muted">(${d.methodId})</small>` : ''}
                                                                </td>
                                                                <td>${d.isSpecial ? '-' : Math.abs(d.usdtAmount).toFixed(6)}</td>
                                                                <td>${d.tokenAmount.toFixed(6)}</td>
                                                                <td class="ellipsis" title="${d.tokenAddress}">${d.tokenAddress}</td>
                                                                <td><a href="https://bscscan.com/tx/${d.hash}" target="_blank">查看</a></td>
                                                                <td>${d.gasCost ? d.gasCost.toFixed(6) : '-'}</td>
                                                            </tr>
                                                        `).join('')
                                                    }
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    accountsContainer.appendChild(accountCard);

                    // 渲染未识别交易
                    if (analysis.unknownTrades && analysis.unknownTrades.length > 0) {
                        renderUnknownTrades(i, analysis.unknownTrades, entry);
                    }
                }
                console.log('渲染分析结果：', allAnalysis);
            }

            function groupByHash(transfers) {
                const map = {};
                for (const tx of transfers) {
                    if (!map[tx.hash]) map[tx.hash] = [];
                    map[tx.hash].push(tx);
                }
                return Object.values(map);
            }

            function analyzeUSDTTrades(address, groupedTxs, timeRange) {
                const trades = [];
                let totalBuy = 0, totalSell = 0;
                for (const txGroup of groupedTxs) {
                    // 取消路由过滤
                    // const isSwap = txGroup.some(tx =>
                    //     DEX_ROUTER_LIST.includes(tx.to.toLowerCase()) ||
                    //     DEX_ROUTER_LIST.includes(tx.from.toLowerCase())
                    // );
                    // if (!isSwap) continue;

                    // 时间过滤
                    const time = parseInt(txGroup[0].timeStamp);
                    if (time < timeRange.start || time >= timeRange.end) continue;

                    let usdtIn = 0, usdtOut = 0;
                    let hash = txGroup[0].hash;
                    let tokenAddress = txGroup[0].contractAddress;
                    for (const tx of txGroup) {
                        if (tx.to.toLowerCase() === address.toLowerCase()) {
                            usdtIn += parseFloat(tx.value) / 1e18;
                        }
                        if (tx.from.toLowerCase() === address.toLowerCase()) {
                            usdtOut += parseFloat(tx.value) / 1e18;
                        }
                    }
                    if (usdtOut > 0) {
                        trades.push({
                            hash,
                            usdtAmount: -usdtOut,
                            tokenAmount: 0,
                            tokenAddress,
                            isBuy: true,
                            isSell: false,
                            timestamp: time
                        });
                        totalBuy += usdtOut;
                    }
                    if (usdtIn > 0) {
                        trades.push({
                            hash,
                            usdtAmount: usdtIn,
                            tokenAmount: 0,
                            tokenAddress,
                            isBuy: false,
                            isSell: true,
                            timestamp: time
                        });
                        totalSell += usdtIn;
                    }
                }
                return { trades, totalBuy, totalSell };
            }

            // 修改analyzeTxGroup函数，确保不会丢失卖出交易
            async function analyzeTxGroup(txGroup, address) {
                const tx = txGroup[0];
                const receipt = await getTxReceipt(tx.hash);
                if (!receipt || !receipt.logs) {
                    console.log(`【${address}】hash:${tx.hash} 没有收据或logs`);
                    return null;
                }

                // 获取主交易详情
                const txDetail = await getTxDetail(tx.hash);
                if (!txDetail) {
                    console.log(`【${address}】hash:${tx.hash} 没有主交易详情`);
                    return null;
                }
                
                const methodId = txDetail.input ? txDetail.input.slice(0, 10).toLowerCase() : '';
                console.log(`交易 ${tx.hash} 方法ID: ${methodId}`);
                
                // 计算gas费用 - 确保正确处理十六进制数据
                let gasCost = 0;
                try {
                    const gasUsed = parseInt(receipt.gasUsed, 16);
                    const gasPrice = parseInt(txDetail.gasPrice, 16);
                    gasCost = gasUsed * gasPrice / 1e18;
                    console.log(`交易 ${tx.hash} gas费用: ${gasCost} BNB`);
                } catch (e) {
                    console.error(`计算gas费用出错 ${tx.hash}:`, e);
                }

                const ERC20_TRANSFER_TOPIC = '0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef';
                
                // 确保地址格式统一为小写
                const normalizedAddress = address.toLowerCase();
                
                // 初始化USDT转入转出和其他代币转入转出的统计
                let usdtIn = 0, usdtOut = 0, tokenIn = 0, tokenOut = 0, tokenAddress = '';

                // 分析所有日志
                for (const log of receipt.logs) {
                    if (log.topics[0] === ERC20_TRANSFER_TOPIC) {
                        const from = '0x' + log.topics[1].slice(26).toLowerCase();
                        const to = '0x' + log.topics[2].slice(26).toLowerCase();
                        
                        try {
                            const amount = parseFloat(BigInt(log.data).toString()) / 1e18;
                            
                            // 检查是否是USDT转账
                            if (log.address.toLowerCase() === USDT_CONTRACT.toLowerCase()) {
                                // USDT转账
                                if (from === normalizedAddress) {
                                    usdtOut += amount;
                                    console.log(`交易 ${tx.hash} 检测到USDT转出: ${amount}`);
                                }
                                if (to === normalizedAddress) {
                                    usdtIn += amount;
                                    console.log(`交易 ${tx.hash} 检测到USDT转入: ${amount}`);
                                }
                            } else {
                                // 其他代币转账
                                if (from === normalizedAddress) {
                                    tokenOut += amount;
                                    if (!tokenAddress) tokenAddress = log.address.toLowerCase();
                                    console.log(`交易 ${tx.hash} 检测到代币转出: ${amount}, 合约: ${log.address}`);
                                }
                                if (to === normalizedAddress) {
                                    tokenIn += amount;
                                    if (!tokenAddress) tokenAddress = log.address.toLowerCase();
                                    console.log(`交易 ${tx.hash} 检测到代币转入: ${amount}, 合约: ${log.address}`);
                                }
                            }
                        } catch (e) {
                            console.error(`解析代币金额错误: ${tx.hash}`, e);
                        }
                    }
                }
                
                // 处理普通交易的情况
                // USDT转出且其他代币转入 = 买入交易
                if (usdtOut > 0 && tokenIn > 0) {
                    console.log(`✅ 检测到买入交易 ${tx.hash}: 支付${usdtOut} USDT, 获得${tokenIn}代币 (${tokenAddress})`);
                    return {
                        hash: tx.hash,
                        usdtAmount: -usdtOut,  // 用负数表示USDT支出
                        tokenAmount: tokenIn,
                        tokenAddress,
                        isBuy: true,
                        isSell: false,
                        timestamp: parseInt(tx.timeStamp),  // 确保转换为整数
                        gasCost: gasCost
                    };
                }
                
                // USDT转入且其他代币转出 = 卖出交易
                if (usdtIn > 0 && tokenOut > 0) {
                    console.log(`✅ 检测到卖出交易 ${tx.hash}: 支付${tokenOut}代币, 获得${usdtIn} USDT`);
                    return {
                        hash: tx.hash,
                        usdtAmount: usdtIn,  // 正数表示USDT收入
                        tokenAmount: -tokenOut,  // 负数表示代币支出
                        tokenAddress,
                        isBuy: false,
                        isSell: true,
                        timestamp: parseInt(tx.timeStamp),  // 确保转换为整数
                        gasCost: gasCost
                    };
                }
                
                // 处理只有USDT转入的情况（可能是卖出但未检测到代币转出）
                if (usdtIn > 0 && tokenOut === 0 && tokenIn === 0) {
                    console.log(`⚠️ 检测到USDT转入交易 ${tx.hash}: 获得${usdtIn} USDT, 未检测到代币流动`);
                    return {
                        hash: tx.hash,
                        usdtAmount: usdtIn,
                        tokenAmount: 0,
                        tokenAddress: tokenAddress || USDT_CONTRACT,
                        isBuy: false,
                        isSell: true,
                        timestamp: parseInt(tx.timeStamp),
                        gasCost: gasCost
                    };
                }
                
                // 处理只有USDT转出的情况（可能是买入但未检测到代币转入）
                if (usdtOut > 0 && tokenIn === 0 && tokenOut === 0) {
                    console.log(`⚠️ 检测到USDT转出交易 ${tx.hash}: 支付${usdtOut} USDT, 未检测到代币流动`);
                    return {
                        hash: tx.hash,
                        usdtAmount: -usdtOut,
                        tokenAmount: 0,
                        tokenAddress: tokenAddress || USDT_CONTRACT,
                        isBuy: true,
                        isSell: false,
                        timestamp: parseInt(tx.timeStamp),
                        gasCost: gasCost
                    };
                }
                
                // 处理特殊方法ID交易...
                // (保留现有的特殊方法ID处理代码)
                
                // 无法明确识别的交易
                return null;
            }

            // 使用明确的时间范围函数
            function getTimeRange(dateStr = '') {
                // 获取北京时间当天8:00到次日8:00的时间戳区间
                let startDate, endDate;

                if (dateStr) {
                    // 用户输入日期，设置为指定日期的北京时间8:00
                    startDate = new Date(`${dateStr}T08:00:00+08:00`);
                } else {
                    // 正确获取当前北京时间 - 修复时间戳bug
                    const now = new Date();
                    
                    console.log(`🕐 当前本地时间: ${now.toLocaleString()}`);
                    console.log(`🕐 当前UTC时间: ${now.toUTCString()}`);
                    
                    // 获取北京时间（UTC+8）
                    const bjTime = new Date(now.getTime() + (8 * 60 * 60 * 1000) - (now.getTimezoneOffset() * 60 * 1000));
                    
                    console.log(`🕐 计算的北京时间: ${bjTime.toLocaleString()}`);
                    console.log(`🕐 北京时间小时: ${bjTime.getHours()}`);
                    
                    // 获取今天北京时间的日期字符串 - 使用正确的方法
                    const year = bjTime.getFullYear();
                    const month = (bjTime.getMonth() + 1).toString().padStart(2, '0');
                    const day = bjTime.getDate().toString().padStart(2, '0');
                    const bjToday = `${year}-${month}-${day}`;
                    
                    console.log(`📅 北京今天日期: ${bjToday}`);
                    console.log(`🔢 北京时间: ${year}-${month}-${day} ${bjTime.getHours()}:${bjTime.getMinutes()}`);
                    
                    // 如果北京时间小于8点，使用昨天8点开始
                    if (bjTime.getHours() < 8) {
                        console.log(`🕐 北京时间未到8点，使用昨天8点开始`);
                        const bjYesterday = new Date(bjTime);
                        bjYesterday.setDate(bjYesterday.getDate() - 1);
                        const yYear = bjYesterday.getFullYear();
                        const yMonth = (bjYesterday.getMonth() + 1).toString().padStart(2, '0');
                        const yDay = bjYesterday.getDate().toString().padStart(2, '0');
                        const yesterdayStr = `${yYear}-${yMonth}-${yDay}`;
                        console.log(`📅 昨天日期: ${yesterdayStr}`);
                        startDate = new Date(`${yesterdayStr}T08:00:00+08:00`);
                    } else {
                        console.log(`🕐 北京时间已过8点，使用今天8点开始`);
                        console.log(`📅 使用日期: ${bjToday}`);
                        startDate = new Date(`${bjToday}T08:00:00+08:00`);
                    }
                }
                
                // 结束时间是开始时间+24小时
                endDate = new Date(startDate.getTime() + 24 * 60 * 60 * 1000);

                // 转为秒级时间戳
                const start = Math.floor(startDate.getTime() / 1000);
                const end = Math.floor(endDate.getTime() / 1000);

                console.log(`🕐 最终时间范围设置:`);
                console.log(`   开始: ${startDate.toLocaleString('zh-CN', {timeZone: 'Asia/Shanghai'})} (${start})`);
                console.log(`   结束: ${endDate.toLocaleString('zh-CN', {timeZone: 'Asia/Shanghai'})} (${end})`);
                console.log(`   总时长: ${(end - start) / 3600} 小时`);
                
                // 验证时间戳是否合理（应该是2023年）
                const startYear = new Date(start * 1000).getFullYear();
                const endYear = new Date(end * 1000).getFullYear();
                console.log(`🔍 时间戳验证: 开始年份=${startYear}, 结束年份=${endYear}`);

                return {
                    start,
                    end,
                    startDate,
                    endDate
                };
            }

            // 获取BNB价格
            async function getBNBPrice() {
                try {
                    const response = await fetch('https://api.binance.com/api/v3/ticker/price?symbol=BNBUSDT');
                    const data = await response.json();
                    const price = parseFloat(data.price);
                    
                    // 确保价格是有效的数字
                    if (!isNaN(price) && price > 0) {
                        console.log(`获取到当前BNB价格: ${price} USDT`);
                        return price;
                    } else {
                        console.warn(`获取到无效的BNB价格: ${price}，使用默认价格`);
                        return 220; // 使用默认价格
                    }
                } catch (error) {
                    console.error('获取BNB价格失败:', error);
                    return 220; // 出错时使用默认价格
                }
            }

            // 1. 添加渲染未识别交易的函数 - 放在renderResults函数之后
            function renderUnknownTrades(index, unknownTrades, entry) {
                if (!unknownTrades || unknownTrades.length === 0) return;
                
                // 创建一个新的容器
                const container = document.createElement('div');
                container.className = 'mt-4';
                container.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center border-bottom pb-2">
                        <h6 class="mb-0">未识别的USDT交易 (${unknownTrades.length})</h6>
                        <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#unknownTradesCollapse_${index}">
                            <i class="bi bi-chevron-down"></i> 展开/收起
                        </button>
                    </div>
                    <div class="collapse" id="unknownTradesCollapse_${index}">
                        <div class="alert alert-warning mt-2">
                            <i class="bi bi-exclamation-triangle"></i> 
                            以下交易无法确定具体类型，未计入统计数据
                        </div>
                        <div class="pt-2" id="unknownTradesContainer_${index}"></div>
                    </div>
                `;
                
                // 将容器添加到账户卡片
                const accountCard = document.querySelector(`#accountCard_${index}`);
                accountCard.appendChild(container);
                
                // 渲染未知交易
                const tradesContainer = document.getElementById(`unknownTradesContainer_${index}`);
                
                // 对交易按时间倒序排列
                const sortedTrades = [...unknownTrades].sort((a, b) => {
                    return new Date(b.timestamp) - new Date(a.timestamp);
                });
                
                sortedTrades.forEach(trade => {
                    const tradeCard = document.createElement('div');
                    tradeCard.className = 'card trade-card border-warning';
                    
                    tradeCard.innerHTML = `
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="card-title mb-0">
                                        <i class="bi bi-question-circle text-warning"></i>
                                        未知交易 - 方法ID: ${trade.methodId || '未知'}
                                    </h6>
                                    <div class="mt-2">
                                        <div class="d-flex align-items-center">
                                            <span>合约地址:</span>
                                            <span class="ms-2 ellipsis" title="${trade.tokenAddress || '未知'}">
                                                ${trade.tokenAddress || '未知'}
                                            </span>
                                        </div>
                                        <div class="d-flex align-items-center mt-1">
                                            <span>Gas 费用:</span>
                                            <span class="ms-2">
                                                ${trade.gasCost ? trade.gasCost.toFixed(6) : '-'} BNB
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                <div class="text-end">
                                    <div class="text-muted mb-2">${formatTime(trade.timestamp)}</div>
                                    <a href="https://bscscan.com/tx/${trade.hash}" target="_blank" class="btn btn-sm btn-outline-secondary">
                                        <i class="bi bi-box-arrow-up-right"></i> 查看交易
                                    </a>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    tradesContainer.appendChild(tradeCard);
                });
            }

            // 优化Receipt获取 - 批量处理和缓存
            async function batchGetTxReceipts(txHashes) {
                const results = [];
                const needFetchHashes = [];
                
                // 首先检查缓存
                for (const hash of txHashes) {
                    if (receiptCache.has(hash)) {
                        results.push({ hash, receipt: receiptCache.get(hash) });
                    } else {
                        needFetchHashes.push(hash);
                        results.push({ hash, receipt: null }); // 占位符
                    }
                }
                
                // 只获取缓存中没有的Receipt
                if (needFetchHashes.length > 0) {
                    console.log(`📦 需要获取 ${needFetchHashes.length} 个新Receipt (${txHashes.length - needFetchHashes.length} 个已缓存)`);
                    
                    const batchSize = 5;
                    for (let i = 0; i < needFetchHashes.length; i += batchSize) {
                        const batch = needFetchHashes.slice(i, i + batchSize);
                        console.log(`📦 批量获取Receipt: ${i+1}-${Math.min(i+batchSize, needFetchHashes.length)}/${needFetchHashes.length}`);
                        
                        const batchPromises = batch.map(async (hash) => {
                            try {
                                await sleep(150); // 减少延迟，因为已经在Gas计算中有延迟了
                                const receipt = await getTxReceipt(hash);
                                return { hash, receipt };
                            } catch (e) {
                                console.warn(`⚠️ 获取Receipt失败: ${hash.slice(0, 10)}...`);
                                return { hash, receipt: null };
                            }
                        });
                        
                        const batchResults = await Promise.all(batchPromises);
                        
                        // 更新结果数组中对应的位置
                        for (const { hash, receipt } of batchResults) {
                            const index = txHashes.indexOf(hash);
                            if (index !== -1) {
                                results[index] = { hash, receipt };
                            }
                        }
                        
                        // 批次间延迟
                        if (i + batchSize < needFetchHashes.length) {
                            await sleep(400);
                        }
                    }
                } else {
                    console.log(`📦 所有Receipt均已缓存，无需额外获取`);
                }
                
                return results;
            }
            
            // 解析USDT Transfer事件的专用函数
            function parseUSDTTransferFromReceipt(receipt, targetAddress) {
                if (!receipt || !receipt.logs) return null;
                
                const ERC20_TRANSFER_TOPIC = '0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef';
                const usdtTransferLogs = receipt.logs.filter(log => 
                    log.address.toLowerCase() === USDT_CONTRACT.toLowerCase() && 
                    log.topics[0] === ERC20_TRANSFER_TOPIC
                );
                
                for (const log of usdtTransferLogs) {
                    try {
                        const from = '0x' + log.topics[1].slice(26).toLowerCase();
                        const to = '0x' + log.topics[2].slice(26).toLowerCase();
                        const amount = parseFloat(BigInt(log.data).toString()) / 1e18;
                        
                        // 检查是否与目标地址相关
                        if (from === targetAddress.toLowerCase() || to === targetAddress.toLowerCase()) {
                            return {
                                from,
                                to,
                                amount,
                                isOutgoing: from === targetAddress.toLowerCase(),
                                isIncoming: to === targetAddress.toLowerCase()
                            };
                        }
                    } catch (e) {
                        console.warn(`⚠️ 解析Transfer事件失败:`, e);
                        continue;
                    }
                }
                
                return null;
            }

            /**
             * API相关工具函数 - 参考alpha.dog的高效模式
             */
            class USDTApiUtils {
                static BSC_SCAN_API_URL = 'https://api.bscscan.com/api';
                static USDT_CONTRACT = '0x55d398326f99059fF775485246999027B3197955'.toLowerCase();
                
                /**
                 * 从BSCScan API获取交易（带重试机制）
                 * @param {string} address - 地址
                 * @param {string} action - 操作类型 (txlist, txlistinternal, tokentx)
                 * @param {Object} options - 额外选项
                 * @returns {Promise<Array>} 交易列表
                 */
                static async fetchTransactions(address, action, options = {}) {
                    const {
                        contractAddress = null,
                        startBlock = 0,
                        endBlock = 99999999,
                        apiKey = getRandomApiKey(),
                        maxRetries = 3
                    } = options;
                    
                    let retries = maxRetries;
                    
                    while (retries > 0) {
                        try {
                            let url = `${this.BSC_SCAN_API_URL}?module=account&action=${action}&address=${address}&startblock=${startBlock}&endblock=${endBlock}&sort=desc&apikey=${apiKey}`;
                            
                            // 如果是代币交易，添加合约地址
                            if (action === 'tokentx' && contractAddress) {
                                url += `&contractaddress=${contractAddress}`;
                            }
                            
                            console.log(`📡 API请求 [${action}]: ${address.slice(0, 8)}...`);
                            
                            const response = await fetch(url);
                            const data = await response.json();
                            
                            if (data.status === '1') {
                                console.log(`✅ ${action}: ${data.result?.length || 0}条记录`);
                                return data.result || [];
                            } else if (data.status === "0" && data.message === "No transactions found") {
                                console.log(`ℹ️ ${action}: 无交易记录`);
                                return [];
                            } else if (data.status === "0" && (data.message === "NOTOK" || data.message.includes("rate limit"))) {
                                console.warn(`⚠️ ${action} API限制，等待重试... 剩余${retries-1}次`);
                                retries--;
                                if (retries > 0) {
                                    await sleep(2000 + Math.random() * 2000); // 2-4秒随机延迟
                                    continue;
                                }
                            } else {
                                console.warn(`⚠️ ${action} API错误:`, data.message);
                                return [];
                            }
                        } catch (error) {
                            console.error(`❌ ${action} 请求失败:`, error.message);
                            retries--;
                            if (retries > 0) {
                                await sleep(1000);
                            }
                        }
                    }
                    
                    console.error(`❌ ${action} 最终失败，已用尽所有重试`);
                    return [];
                }
                
                /**
                 * 获取地址的完整交易数据（三种类型）
                 * @param {string} address - 地址
                 * @param {Object} timeRange - 时间范围
                 * @returns {Promise<Object>} 分类的交易数据
                 */
                static async fetchAddressData(address, timeRange) {
                    try {
                        console.log(`🚀 获取 ${address.slice(0, 8)}... 的完整交易数据（USDT+USDC）`);
                        
                        // 计算区块范围
                        let startBlock, endBlock;
                        try {
                            [startBlock, endBlock] = await Promise.all([
                                getBlockByTimestamp(timeRange.start, 'before'),
                                getBlockByTimestamp(timeRange.end, 'after')
                            ]);
                        } catch (e) {
                            console.warn(`⚠️ 区块号获取失败，使用固定范围`);
                            startBlock = 50000000;
                            endBlock = 50300000;
                        }
                        
                        const options = { startBlock, endBlock };
                        
                        // 并行获取普通交易和内部交易
                        console.log(`📦 获取普通交易...`);
                        const normalTxList = await this.fetchTransactions(address, 'txlist', options);
                        
                        await sleep(1000); // 1秒间隔
                        
                        console.log(`📦 获取内部交易...`);
                        const internalTxList = await this.fetchTransactions(address, 'txlistinternal', options);
                        
                        await sleep(1000); // 1秒间隔
                        
                        // 🚀 新增：并行获取USDT和USDC代币交易
                        console.log(`📦 获取USDT代币交易...`);
                        const usdtTokenTxList = await this.fetchTransactions(address, 'tokentx', {
                            ...options,
                            contractAddress: USDT_CONTRACT
                        });
                        
                        await sleep(1000); // 1秒间隔
                        
                        console.log(`📦 获取USDC代币交易...`);
                        const usdcTokenTxList = await this.fetchTransactions(address, 'tokentx', {
                            ...options,
                            contractAddress: USDC_CONTRACT
                        });
                        
                        // 合并USDT和USDC交易列表
                        const tokenTxList = [...usdtTokenTxList, ...usdcTokenTxList];
                        console.log(`📊 代币交易统计: USDT ${usdtTokenTxList.length}条, USDC ${usdcTokenTxList.length}条, 总计 ${tokenTxList.length}条`);
                        
                        // 处理和合并交易数据
                        const processedData = this.processTransactions(address, normalTxList, internalTxList, tokenTxList, timeRange);
                        
                        console.log(`✅ ${address.slice(0, 8)}... 数据获取完成: ${processedData.allTransactions.length}条相关交易`);
                        
                        return processedData;
                    } catch (error) {
                        console.error(`❌ 获取地址 ${address} 数据失败:`, error);
                        throw error;
                    }
                }
                
                /**
                 * 处理和合并三种类型的交易数据 - 使用FastTransactionProcessor优化
                 * @param {string} address - 地址
                 * @param {Array} normalTxList - 普通交易
                 * @param {Array} internalTxList - 内部交易
                 * @param {Array} tokenTxList - 代币交易
                 * @param {Object} timeRange - 时间范围
                 * @returns {Object} 处理后的交易数据
                 */
                static processTransactions(address, normalTxList, internalTxList, tokenTxList, timeRange) {
                    console.log(`�� 使用FastTransactionProcessor优化处理...`);
                    
                    // 使用新的高效处理器
                    return FastTransactionProcessor.processAllTransactions(
                        address, 
                        normalTxList, 
                        internalTxList, 
                        tokenTxList, 
                        timeRange
                    );
                }
                
                /**
                 * 判断交易是否与USDT相关
                 * @param {Object} tx - 交易对象
                 * @param {string} address - 目标地址
                 * @returns {boolean} 是否相关
                 */
                static isUSDTRelatedTransaction(tx, address) {
                    // 检查是否与目标地址相关
                    if (tx.from?.toLowerCase() !== address && tx.to?.toLowerCase() !== address) {
                        return false;
                    }
                    
                    // 检查是否是USDT合约交互
                    if (tx.to?.toLowerCase() === this.USDT_CONTRACT) {
                        return true;
                    }
                    
                    // 检查是否是DEX交易
                    if (tx.input && tx.input.length >= 10) {
                        const methodId = tx.input.slice(0, 10).toLowerCase();
                        const dexMethods = [
                            '0xa03de6a9', '0x7c025200', '0x84bd6d29', '0x12aa3caf',
                            '0xe5e8894b', '0x7ff36ab5', '0x38ed1739', '0x18cbafe5',
                            '0xe19c2253', '0x0d46641a'
                        ];
                        return dexMethods.includes(methodId);
                    }
                    
                    // 检查是否是DEX路由
                    return DEX_ROUTER_LIST.includes(tx.to?.toLowerCase());
                }
                
                /**
                 * 批量获取多个地址的交易数据
                 * @param {Array} addressEntries - 地址条目数组
                 * @param {Object} timeRange - 时间范围
                 * @param {Function} progressCallback - 进度回调
                 * @returns {Promise<Array>} 处理结果数组
                 */
                static async fetchMultipleAddressesData(addressEntries, timeRange, progressCallback = null) {
                    const results = [];
                    let completed = 0;
                    
                    console.log(`🚀 开始批量获取 ${addressEntries.length} 个地址的数据`);
                    
                    for (const entry of addressEntries) {
                        try {
                            console.log(`📍 [${completed + 1}/${addressEntries.length}] 处理: ${entry.name}`);
                            
                            const addressData = await this.fetchAddressData(entry.address, timeRange);
                            
                            results.push({
                                success: true,
                                entry,
                                data: addressData,
                                error: null
                            });
                            
                            completed++;
                            if (progressCallback) {
                                progressCallback(completed, addressEntries.length, entry.name);
                            }
                            
                            console.log(`✅ ${entry.name}: 完成 (${addressData.stats.total}条交易)`);
                            
                            // 地址间延迟
                            if (completed < addressEntries.length) {
                                await sleep(2000); // 2秒延迟
                            }
                            
                        } catch (error) {
                            console.error(`❌ ${entry.name} 处理失败:`, error.message);
                            results.push({
                                success: false,
                                entry,
                                data: null,
                                error: error.message
                            });
                            
                            completed++;
                            if (progressCallback) {
                                progressCallback(completed, addressEntries.length, entry.name, error.message);
                            }
                        }
                    }
                    
                    const successCount = results.filter(r => r.success).length;
                    console.log(`🎯 批量处理完成: ${successCount}/${addressEntries.length} 个地址成功`);
                    
                    return results;
                }

                /**
                 * 超高效的USDT流入流出分析 - 基于你的ApiUtils优化
                 * @param {string} address - 地址
                 * @param {Array} normalTxList - 普通交易
                 * @param {Array} internalTxList - 内部交易  
                 * @param {Array} tokenTxList - 代币交易
                 * @param {Object} timeRange - 时间范围
                 * @returns {Object} 处理后的交易数据
                 */
                static processTransactionsUltraFast(address, normalTxList, internalTxList, tokenTxList, timeRange) {
                    const addressLower = address.toLowerCase();
                    const usdtTransfers = [];
                    const relevantSwaps = [];
                    let totalUSDTIn = 0, totalUSDTOut = 0;
                    
                    console.log(`⚡ 超高效处理: 代币${tokenTxList.length}, 普通${normalTxList.length}, 内部${internalTxList.length}`);
                    
                    // 1. 优先处理USDT代币转账（最重要，最快）
                    for (const tx of tokenTxList) {
                        const time = parseInt(tx.timeStamp);
                        if (time >= timeRange.start && time < timeRange.end) {
                            if (tx.from?.toLowerCase() === addressLower || tx.to?.toLowerCase() === addressLower) {
                                // 直接计算USDT流向，无需额外API调用
                                const amount = parseFloat(tx.value) / 1e18;
                                if (amount > 0) {
                                    tx.usdtAmount = amount;
                                    tx.isUSDTOut = tx.from?.toLowerCase() === addressLower;
                                    tx.isUSDTIn = tx.to?.toLowerCase() === addressLower;
                                    tx.txType = 'usdt_direct';
                                    
                                    if (tx.isUSDTOut) totalUSDTOut += amount;
                                    if (tx.isUSDTIn) totalUSDTIn += amount;
                                    
                                    usdtTransfers.push(tx);
                                }
                            }
                        }
                    }
                    
                    // 2. 快速识别相关swap交易（只处理明确的方法ID）
                    const fastSwapMethods = {
                        '0xa03de6a9': 'PancakeSwap',
                        '0x7c025200': 'UniswapV3', 
                        '0xe5e8894b': '1inch',
                        '0x38ed1739': 'PancakeSwap',
                        '0x18cbafe5': 'PancakeSwap'
                    };
                    
                    for (const tx of normalTxList) {
                        const time = parseInt(tx.timeStamp);
                        if (time >= timeRange.start && time < timeRange.end) {
                            if (tx.from?.toLowerCase() === addressLower || tx.to?.toLowerCase() === addressLower) {
                                const methodId = tx.input?.slice(0, 10).toLowerCase();
                                if (fastSwapMethods[methodId]) {
                                    tx.txType = 'swap_potential';
                                    tx.dexName = fastSwapMethods[methodId];
                                    tx.needsReceipt = true; // 标记需要详细分析
                                    relevantSwaps.push(tx);
                                }
                            }
                        }
                    }
                    
                    console.log(`⚡ 快速识别: USDT转账${usdtTransfers.length}条, 潜在Swap${relevantSwaps.length}条`);
                    console.log(`💰 USDT流向: 流入${totalUSDTIn.toFixed(2)}, 流出${totalUSDTOut.toFixed(2)}`);
                    
                    return {
                        usdtTransfers,
                        relevantSwaps,
                        totalUSDTIn,
                        totalUSDTOut,
                        needDetailAnalysis: relevantSwaps.length > 0,
                        stats: {
                            directUSDT: usdtTransfers.length,
                            potentialSwaps: relevantSwaps.length,
                            flowIn: totalUSDTIn,
                            flowOut: totalUSDTOut,
                            netFlow: totalUSDTIn - totalUSDTOut
                        }
                    };
                }
                
                /**
                 * 检查是否为可能包含USDT流向的DEX交易
                 * @param {Object} tx - 交易对象
                 * @param {string} userAddress - 用户地址
                 * @returns {boolean} 是否需要进一步分析
                 */
                static isPotentialDEXTransaction(tx, userAddress) {
                    console.log(`🔍 检查是否为DEX交易: ${tx.hash}`);
                    console.log(`   方法ID: ${tx.input?.slice(0, 10)}`);
                    console.log(`   目标地址: ${tx.to}`);
                    console.log(`   用户地址: ${userAddress}`);
                    console.log(`   from: ${tx.from}`);
                    
                    // 特别针对问题交易的调试
                    if (tx.hash === '0x65a753d80a95c83eac7b83139a88744f802dce45a3baea08e8d00587addf9a78') {
                        console.log(`🔥🔥🔥 正在分析问题交易!`);
                        console.log(`   输入数据: ${tx.input}`);
                        console.log(`   DEX路由列表长度: ${DEX_ROUTER_LIST.length}`);
                        console.log(`   to地址是否在DEX列表中: ${DEX_ROUTER_LIST.includes(tx.to?.toLowerCase())}`);
                        if (tx.input && tx.input.length > 10) {
                            const methodId = tx.input.slice(0, 10).toLowerCase();
                            console.log(`   提取的方法ID: ${methodId}`);
                            console.log(`   是否匹配0xa03de6a9: ${methodId === '0xa03de6a9'}`);
                        }
                    }
                    
                    // 1. 检查是否涉及用户地址
                    if (tx.from?.toLowerCase() !== userAddress && tx.to?.toLowerCase() !== userAddress) {
                        console.log(`   ❌ 不涉及用户地址`);
                        return false;
                    }
                    
                    // 2. 检查是否涉及已知的DEX路由
                    if (DEX_ROUTER_LIST.includes(tx.to?.toLowerCase())) {
                        console.log(`🎯 检测到DEX路由交易: ${tx.hash} -> ${tx.to}`);
                        return true;
                    }
                    
                    // 3. 检查方法ID是否为DEX相关
                    if (tx.input && tx.input.length > 10) {
                        const methodId = tx.input.slice(0, 10).toLowerCase();
                        const dexMethods = [
                            '0xa03de6a9', // swapExactTokensForTokens
                            '0x7c025200', // swapExactETHForTokens  
                            '0x84bd6d29', // swapExactTokensForETH
                            '0x12aa3caf', // swapExactTokensForTokensSupportingFeeOnTransferTokens
                            '0xe5e8894b', // swapExactTokensForETHSupportingFeeOnTransferTokens
                            '0x7ff36ab5', // swapExactETHForTokensSupportingFeeOnTransferTokens
                            '0x38ed1739', // swapExactTokensForTokens
                            '0x18cbafe5', // swapExactTokensForETH
                            '0xf305d719', // addLiquidityETH
                            '0xe8e33700', // addLiquidity
                            '0x02751cec', // removeLiquidity
                            '0xaf2979eb'  // removeLiquidityETH
                        ];
                        
                        if (dexMethods.includes(methodId)) {
                            console.log(`🎯 检测到DEX方法: ${tx.hash} -> ${methodId}`);
                            if (methodId === '0xa03de6a9') {
                                console.log(`🔥 特别注意: 这是callOneInch方法 ${tx.hash}`);
                            }
                            return true;
                        }
                    }
                    
                    // 4. 检查Gas使用量（DEX交易通常消耗更多Gas）
                    const gasUsed = parseFloat(tx.gasUsed || '0');
                    if (gasUsed > 100000) { // 超过10万Gas
                        console.log(`🎯 检测到高Gas交易: ${tx.hash} -> ${gasUsed} gas`);
                        return true;
                    }
                    
                    return false;
                }
                
                /**
                 * 分析交易receipt以提取USDT流向信息
                 * @param {Array} transactions - 需要分析的交易列表
                 * @param {string} userAddress - 用户地址
                 */
                static async analyzeReceiptsForUSDTFlow(transactions, userAddress) {
                    console.log(`🔍 开始分析${transactions.length}个交易的receipt...`);
                    console.log(`📋 要分析的交易哈希:`, transactions.map(tx => tx.hash));
                    
                    const batchSize = 3; // 批量处理避免API限制
                    for (let i = 0; i < transactions.length; i += batchSize) {
                        const batch = transactions.slice(i, i + batchSize);
                        console.log(`📦 处理receipt批次: ${i+1}-${Math.min(i+batchSize, transactions.length)}/${transactions.length}`);
                        
                        // 并行获取这一批的receipt
                        const receiptPromises = batch.map(async tx => {
                            try {
                                console.log(`📦 获取receipt: ${tx.hash}`);
                                await sleep(200); // 200ms延迟避免API限制
                                const receipt = await getTxReceipt(tx.hash);
                                console.log(`✅ 获取receipt成功: ${tx.hash}, logs数量: ${receipt?.logs?.length || 0}`);
                                return { tx, receipt };
                            } catch (e) {
                                console.warn(`⚠️ 获取receipt失败: ${tx.hash.slice(0, 10)}...`);
                                return { tx, receipt: null };
                            }
                        });
                        
                        const receiptResults = await Promise.all(receiptPromises);
                        
                        // 分析receipt中的USDT流向
                        for (const { tx, receipt } of receiptResults) {
                            if (receipt && receipt.logs) {
                                this.extractUSDTFlowFromReceipt(tx, receipt, userAddress);
                            }
                        }
                        
                        // 批次间延迟
                        if (i + batchSize < transactions.length) {
                            await sleep(500);
                        }
                    }
                    
                    console.log(`✅ Receipt分析完成`);
                }
                
                /**
                 * 从receipt的logs中提取USDT流向信息
                 * @param {Object} tx - 交易对象
                 * @param {Object} receipt - 交易receipt
                 * @param {string} userAddress - 用户地址
                 */
                static extractUSDTFlowFromReceipt(tx, receipt, userAddress) {
                    console.log(`🔍 分析稳定币流向: ${tx.hash}`);
                    console.log(`   用户地址: ${userAddress}`);
                    console.log(`   Receipt logs数量: ${receipt?.logs?.length || 0}`);
                    
                    const ERC20_TRANSFER_TOPIC = '0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef';
                    
                    // 查找所有稳定币转账事件
                    const stablecoinTransfers = receipt.logs.filter(log => 
                        STABLECOIN_CONTRACTS.includes(log.address.toLowerCase()) && 
                        log.topics[0] === ERC20_TRANSFER_TOPIC
                    );
                    
                    console.log(`🔍 发现${stablecoinTransfers.length}个稳定币转账事件`);
                    
                    for (const log of stablecoinTransfers) {
                        try {
                            const from = '0x' + log.topics[1].slice(26).toLowerCase();
                            const to = '0x' + log.topics[2].slice(26).toLowerCase();
                            const amount = parseFloat(BigInt(log.data).toString()) / 1e18;
                            
                            // 识别稳定币类型
                            let coinSymbol = 'Unknown';
                            if (log.address.toLowerCase() === USDT_CONTRACT.toLowerCase()) {
                                coinSymbol = 'USDT';
                            } else if (log.address.toLowerCase() === USDC_CONTRACT.toLowerCase()) {
                                coinSymbol = 'USDC';
                            }
                            
                            console.log(`🔍 ${coinSymbol} Transfer: ${from.slice(0, 8)}... -> ${to.slice(0, 8)}... : ${amount} ${coinSymbol}`);
                            
                            // 检查是否与用户相关
                            if (from === userAddress.toLowerCase() || to === userAddress.toLowerCase()) {
                                // 确保token存在
                                if (!tx.tokens[coinSymbol]) {
                                    tx.tokens[coinSymbol] = { inflow: 0, outflow: 0, address: log.address };
                                }
                                
                                if (from === userAddress.toLowerCase()) {
                                    tx.tokens[coinSymbol].outflow += amount;
                                    console.log(`  📤 用户${coinSymbol}流出: ${amount} ${coinSymbol}`);
                                }
                                if (to === userAddress.toLowerCase()) {
                                    tx.tokens[coinSymbol].inflow += amount;
                                    console.log(`  📥 用户${coinSymbol}流入: ${amount} ${coinSymbol}`);
                                }
                            }
                        } catch (e) {
                            console.warn(`⚠️ 解析Transfer事件失败:`, e);
                        }
                    }
                }
            }

            // 新的交易数据分析函数 - 处理ApiUtils返回的数据
            async function analyzeTransactionData(addressInfo, transactionData, timeRange, usdtPrice, bnbPrice, usdtBalance) {
                console.log(`🔍 开始分析 ${addressInfo.name} 的交易数据`);
                console.log(`📊 数据统计:`, transactionData.stats);
                
                // 判断是否为普通USDT转账（不应计入买卖统计）
                function isSimpleUSDTTransfer(tx) {
                    // 1. 检查是否涉及DEX路由
                    if (DEX_ROUTER_LIST.includes(tx.to?.toLowerCase()) || 
                        DEX_ROUTER_LIST.includes(tx.from?.toLowerCase())) {
                        return false; // 涉及DEX，是交易
                    }
                    
                    // 2. 检查input是否为复杂调用
                    if (tx.input && tx.input.length > 10) {
                        const methodId = tx.input.slice(0, 10).toLowerCase();
                        // 常见的swap方法ID
                        const swapMethods = [
                            '0xa03de6a9', '0x7c025200', '0x84bd6d29', '0x12aa3caf',
                            '0xe5e8894b', '0x7ff36ab5', '0x38ed1739', '0x18cbafe5'
                        ];
                        if (swapMethods.includes(methodId)) {
                            return false; // 是swap方法，是交易
                        }
                        
                        // USDT的transfer方法ID
                        if (methodId === '0xa9059cbb') {
                            return true; // 是普通transfer，是转账
                        }
                    }
                    
                    // 3. 如果to地址是USDT合约，且是简单调用，可能是普通转账
                    if (tx.to?.toLowerCase() === USDT_CONTRACT.toLowerCase()) {
                        return true;
                    }
                    
                    // 4. 其他情况视为可能的交易
                    return false;
                }
                
                const address = addressInfo.address.toLowerCase();
                const trades = [];
                const unknownTrades = [];
                let totalBuy = 0, totalSell = 0, totalGasCost = 0;
                
                // 确保bnbPrice是有效的数字
                if (isNaN(bnbPrice) || bnbPrice <= 0) {
                    console.warn(`检测到无效的BNB价格: ${bnbPrice}，使用默认价格660`);
                    bnbPrice = 660;
                }
                
                // 按交易类型分别处理
                console.log(`🚀 开始分析 ${transactionData.allTransactions.length} 条交易...`);
                
                // 需要获取Receipt的交易
                const needReceiptTxs = [];
                
                console.log(`⛽ 直接从交易记录计算Gas费用（无需额外API调用）...`);
                
                // 直接从交易记录批量计算Gas费用
                const gasCostMap = GasUtils.batchCalculateGasFromTx(transactionData.allTransactions);
                
                for (const tx of transactionData.allTransactions) {
                    const time = parseInt(tx.timeStamp);
                    const realGasCost = gasCostMap.get(tx.hash) || GasEstimator.estimateGasCost('token_transfer');
                    
                    if (tx.txType === 'usdt_transfer') {
                        // 检查是否为普通转账（不统计）还是交易买卖（统计）
                        console.log(`💰 检查USDT转账类型: ${tx.hash}`);
                        
                        // 判断是否是普通转账的条件：
                        // 1. 没有复杂的input（普通转账通常input很简单）
                        // 2. 不涉及DEX路由
                        // 3. 不是swap相关的方法
                        const isSimpleTransfer = isSimpleUSDTTransfer(tx);
                        
                        if (isSimpleTransfer) {
                            console.log(`📤 跳过普通USDT转账（不计入统计）: ${tx.hash}`);
                            // 记录为普通转账，但不计入买卖统计
                            unknownTrades.push({
                                hash: tx.hash,
                                timestamp: tx.timeStamp,
                                methodId: 'simple_transfer',
                                gasCost: realGasCost,
                                tokenAddress: USDT_CONTRACT,
                                note: '普通USDT转账（未计入买卖统计）'
                            });
                            continue;
                        }
                        
                        // 如果不是普通转账，按原逻辑处理
                        let amount = 0;
                        
                        // 首先尝试从tx.value解析
                        if (tx.value && tx.value !== '0') {
                            amount = parseFloat(tx.value) / 1e18;
                        } else {
                            // 需要从Receipt获取
                            needReceiptTxs.push({tx, realGasCost});
                            continue;
                        }
                        
                        if (amount <= 0) {
                            console.log(`⚠️ 跳过无效金额的USDT交易: ${tx.hash}, 金额: ${amount}`);
                            continue;
                        }
                        
                        let trade = null;
                        if (tx.from?.toLowerCase() === address) {
                            // USDT流出 = 买入其他代币
                            trade = {
                                hash: tx.hash,
                                usdtAmount: -amount,
                                tokenAmount: 0,
                                tokenAddress: USDT_CONTRACT,
                                isBuy: true,
                                isSell: false,
                                timestamp: time,
                                gasCost: realGasCost
                            };
                            totalBuy += amount;
                            console.log(`✅ USDT交易-买入: ${amount.toFixed(4)} USDT, Gas: ${realGasCost.toFixed(6)} BNB`);
                        } else if (tx.to?.toLowerCase() === address) {
                            // USDT流入 = 卖出其他代币
                            trade = {
                                hash: tx.hash,
                                usdtAmount: amount,
                                tokenAmount: 0,
                                tokenAddress: USDT_CONTRACT,
                                isBuy: false,
                                isSell: true,
                                timestamp: time,
                                gasCost: realGasCost
                            };
                            totalSell += amount;
                            console.log(`✅ USDT交易-卖出: ${amount.toFixed(4)} USDT, Gas: ${realGasCost.toFixed(6)} BNB`);
                        }
                        
                        if (trade) {
                            trades.push(trade);
                            totalGasCost += trade.gasCost;
                        }
                        
                    } else if (tx.txType === 'normal_relevant') {
                        // 相关的普通交易（可能是swap等）
                        console.log(`🔄 处理相关交易: ${tx.hash}, 方法: ${tx.input?.slice(0, 10)}`);
                        needReceiptTxs.push({tx, realGasCost});
                        
                    } else if (tx.txType === 'internal') {
                        // 内部交易
                        console.log(`🏠 处理内部交易: ${tx.hash}`);
                        // 内部交易通常不直接涉及USDT，但可能有ETH/BNB流动
                        unknownTrades.push({
                            hash: tx.hash,
                            timestamp: tx.timeStamp,
                            methodId: 'internal',
                            gasCost: realGasCost, // 使用真实Gas费用
                            tokenAddress: ''
                        });
                    }
                }
                
                // 批量处理需要Receipt的交易
                if (needReceiptTxs.length > 0) {
                    console.log(`📦 批量处理 ${needReceiptTxs.length} 个需要Receipt的交易...`);
                    
                    const txHashes = needReceiptTxs.map(item => item.tx.hash);
                    const receiptResults = await batchGetTxReceipts(txHashes);
                    
                    for (let i = 0; i < needReceiptTxs.length; i++) {
                        const {tx, realGasCost} = needReceiptTxs[i];
                        const { receipt } = receiptResults[i];
                        const time = parseInt(tx.timeStamp);
                        
                        if (!receipt) {
                            console.log(`⚠️ 跳过无Receipt的交易: ${tx.hash}`);
                            unknownTrades.push({
                                hash: tx.hash,
                                timestamp: tx.timeStamp,
                                methodId: tx.input?.slice(0, 10) || 'unknown',
                                gasCost: realGasCost, // 使用真实Gas费用
                                tokenAddress: tx.contractAddress || ''
                            });
                            continue;
                        }
                        
                        // 解析USDT Transfer事件
                        const transferInfo = parseUSDTTransferFromReceipt(receipt, addressInfo.address);
                        
                        if (transferInfo && transferInfo.amount > 0) {
                            let trade = null;
                            if (transferInfo.isOutgoing) {
                                // USDT流出 = 买入
                                trade = {
                                    hash: tx.hash,
                                    usdtAmount: -transferInfo.amount,
                                    tokenAmount: 0,
                                    tokenAddress: USDT_CONTRACT,
                                    isBuy: true,
                                    isSell: false,
                                    timestamp: time,
                                    gasCost: realGasCost // 使用真实Gas费用
                                };
                                totalBuy += transferInfo.amount;
                                console.log(`✅ Receipt解析-USDT流出(买入): ${transferInfo.amount.toFixed(4)} USDT, Gas: ${realGasCost.toFixed(6)} BNB`);
                            } else if (transferInfo.isIncoming) {
                                // USDT流入 = 卖出
                                trade = {
                                    hash: tx.hash,
                                    usdtAmount: transferInfo.amount,
                                    tokenAmount: 0,
                                    tokenAddress: USDT_CONTRACT,
                                    isBuy: false,
                                    isSell: true,
                                    timestamp: time,
                                    gasCost: realGasCost // 使用真实Gas费用
                                };
                                totalSell += transferInfo.amount;
                                console.log(`✅ Receipt解析-USDT流入(卖出): ${transferInfo.amount.toFixed(4)} USDT, Gas: ${realGasCost.toFixed(6)} BNB`);
                            }
                            
                            if (trade) {
                                trades.push(trade);
                                totalGasCost += trade.gasCost;
                            }
                        } else {
                            // 无法解析的交易
                            unknownTrades.push({
                                hash: tx.hash,
                                timestamp: tx.timeStamp,
                                methodId: tx.input?.slice(0, 10) || 'unknown',
                                gasCost: realGasCost, // 使用真实Gas费用
                                tokenAddress: tx.contractAddress || ''
                            });
                            console.log(`⚠️ 无法解析Transfer事件: ${tx.hash}`);
                        }
                    }
                }
                
                // 计算最终结果
                const gasCostInUSDT = totalGasCost * bnbPrice;
                const profitLoss = totalSell - totalBuy;
                const netProfitLoss = profitLoss - gasCostInUSDT;
                
                // 详细的分析摘要
                console.log(`📋 ${addressInfo.name} 详细摘要:`);
                console.log(`   📦 总交易数: ${transactionData.allTransactions.length}`);
                console.log(`   ✅ 已识别交易: ${trades.length}`);
                console.log(`   ❓ 未识别交易: ${unknownTrades.length}`);
                console.log(`   💰 USDT流出(买入): ${trades.filter(t => t.isBuy).length}次，总额: ${totalBuy.toFixed(2)} USDT`);
                console.log(`   💸 USDT流入(卖出): ${trades.filter(t => t.isSell).length}次，总额: ${totalSell.toFixed(2)} USDT`);
                console.log(`   📈 净盈亏: ${profitLoss.toFixed(2)} USDT (扣除Gas前)`);
                console.log(`   📉 实际盈亏: ${netProfitLoss.toFixed(2)} USDT (扣除Gas后)`);
                
                return {
                    name: addressInfo.name,
                    address: addressInfo.address,
                    trades,
                    unknownTrades,
                    totalBuyValue: totalBuy,
                    totalSellValue: totalSell,
                    profitLoss: profitLoss,
                    netProfitLoss: netProfitLoss,
                    totalGasCost: totalGasCost,
                    gasCostInUSDT: gasCostInUSDT,
                    bnbPrice: bnbPrice,
                    usdtPrice: usdtPrice,
                    usdtBalance: parseFloat(usdtBalance),
                    timeRange,
                    stats: transactionData.stats
                };
            }

            // 计算真实Gas费用的函数
            async function calculateRealGasCost(txHash, txType = 'token_transfer') {
                try {
                    // 并行获取交易详情和Receipt
                    const [txDetail, receipt] = await Promise.all([
                        getTxDetail(txHash),
                        getTxReceipt(txHash)
                    ]);
                    
                    if (receipt && txDetail) {
                        const gasUsed = parseInt(receipt.gasUsed, 16);
                        const gasPrice = parseInt(txDetail.gasPrice, 16);
                        const gasCost = gasUsed * gasPrice / 1e18;
                        
                        console.log(`💰 ${txHash.slice(0, 10)}... Gas费用: ${gasUsed} × ${(gasPrice/1e9).toFixed(2)}Gwei = ${gasCost.toFixed(6)} BNB`);
                        return gasCost;
                    } else {
                        console.warn(`⚠️ 无法获取Gas信息: ${txHash.slice(0, 10)}...，使用估算值`);
                        return GasEstimator.estimateGasCost(txType); // 使用动态估算
                    }
                } catch (e) {
                    console.warn(`⚠️ 计算Gas费用失败: ${txHash.slice(0, 10)}...`, e.message);
                    return GasEstimator.estimateGasCost(txType); // 使用动态估算
                }
            }
            
            // 批量计算Gas费用
            async function batchCalculateGasCosts(txHashes, txTypes = []) {
                const results = [];
                const batchSize = 3; // 减少批次大小避免API限制
                
                for (let i = 0; i < txHashes.length; i += batchSize) {
                    const batch = txHashes.slice(i, i + batchSize);
                    const batchTypes = txTypes.slice(i, i + batchSize);
                    console.log(`💰 批量计算Gas费用: ${i+1}-${Math.min(i+batchSize, txHashes.length)}/${txHashes.length}`);
                    
                    const batchPromises = batch.map((hash, index) => 
                        calculateRealGasCost(hash, batchTypes[index] || 'token_transfer')
                    );
                    const batchResults = await Promise.all(batchPromises);
                    results.push(...batchResults);
                    
                    // 批次间延迟
                    if (i + batchSize < txHashes.length) {
                        await sleep(800); // 稍微增加延迟
                    }
                }
                
                return results;
            }

            // 动态Gas费用估算器
            class GasEstimator {
                static DEFAULT_GAS_PRICE = 5e9; // 5 Gwei
                static SIMPLE_TRANSFER_GAS = 21000;
                static TOKEN_TRANSFER_GAS = 65000;
                static SWAP_GAS = 150000;
                static COMPLEX_GAS = 300000;
                
                /**
                 * 根据交易类型估算Gas费用
                 * @param {string} txType - 交易类型
                 * @param {number} gasPrice - Gas价格(wei)，可选
                 * @returns {number} 估算的Gas费用(BNB)
                 */
                static estimateGasCost(txType = 'token_transfer', gasPrice = null) {
                    const price = gasPrice || this.DEFAULT_GAS_PRICE;
                    let gasLimit;
                    
                    switch (txType) {
                        case 'simple_transfer':
                            gasLimit = this.SIMPLE_TRANSFER_GAS;
                            break;
                        case 'token_transfer':
                            gasLimit = this.TOKEN_TRANSFER_GAS;
                            break;
                        case 'swap':
                            gasLimit = this.SWAP_GAS;
                            break;
                        case 'complex':
                            gasLimit = this.COMPLEX_GAS;
                            break;
                        default:
                            gasLimit = this.TOKEN_TRANSFER_GAS;
                    }
                    
                    const estimatedCost = gasLimit * price / 1e18;
                    console.log(`⛽ Gas估算 [${txType}]: ${gasLimit} × ${(price/1e9).toFixed(1)}Gwei = ${estimatedCost.toFixed(6)} BNB`);
                    return estimatedCost;
                }
                
                /**
                 * 获取当前网络Gas价格（简化版）
                 * @returns {Promise<number>} Gas价格(wei)
                 */
                static async getCurrentGasPrice() {
                    try {
                        // 这里可以调用BSC的API获取实时gas价格
                        // 暂时使用固定值，但不硬编码在业务逻辑中
                        const estimatedGasPrice = 5e9; // 5 Gwei
                        console.log(`⛽ 当前估算Gas价格: ${(estimatedGasPrice/1e9).toFixed(1)} Gwei`);
                        return estimatedGasPrice;
                    } catch (e) {
                        console.warn(`⚠️ 获取Gas价格失败，使用默认值`);
                        return this.DEFAULT_GAS_PRICE;
                    }
                }
            }

            // Gas费用工具类 - 直接从交易记录提取
            class GasUtils {
                /**
                 * 从交易记录直接计算gas费用
                 * @param {Object} tx - 交易记录
                 * @returns {number} Gas费用(BNB)
                 */
                static calculateGasFromTx(tx) {
                    try {
                        if (tx.gasUsed && tx.gasPrice) {
                            // 直接从交易记录计算，无需额外API调用
                            const gasUsed = parseFloat(tx.gasUsed);
                            const gasPrice = parseFloat(tx.gasPrice);
                            const gasFee = (gasUsed * gasPrice) / 1e18; // 转换为BNB
                            
                            console.log(`⛽ 从交易记录计算Gas: ${gasUsed} × ${(gasPrice/1e9).toFixed(2)}Gwei = ${gasFee.toFixed(6)} BNB`);
                            return gasFee;
                        } else {
                            console.log(`⚠️ 交易记录缺少gas信息: ${tx.hash?.slice(0, 10)}...`);
                            return GasEstimator.estimateGasCost('token_transfer');
                        }
                    } catch (e) {
                        console.warn(`⚠️ 计算Gas费用失败: ${tx.hash?.slice(0, 10)}...`, e.message);
                        return GasEstimator.estimateGasCost('token_transfer');
                    }
                }
                
                /**
                 * 批量计算交易的gas费用
                 * @param {Array} transactions - 交易列表
                 * @returns {Map} hash到gas费用的映射
                 */
                static batchCalculateGasFromTx(transactions) {
                    const gasCostMap = new Map();
                    
                    console.log(`⛽ 批量从交易记录计算 ${transactions.length} 条交易的Gas费用...`);
                    
                    for (const tx of transactions) {
                        const gasCost = this.calculateGasFromTx(tx);
                        gasCostMap.set(tx.hash, gasCost);
                    }
                    
                    console.log(`✅ 批量Gas计算完成: ${gasCostMap.size} 条记录`);
                    return gasCostMap;
                }
                
                /**
                 * 统计总gas消耗
                 * @param {Array} transactions - 交易列表
                 * @returns {number} 总gas费用(BNB)
                 */
                static calculateTotalGas(transactions) {
                    let totalGas = 0;
                    
                    for (const tx of transactions) {
                        totalGas += this.calculateGasFromTx(tx);
                    }
                    
                    return totalGas;
                }
            }

            // 高效交易处理器 - 参考用户的优化方案
            class FastTransactionProcessor {
                /**
                 * 高效处理和合并交易数据（参考alpha.dog方式）
                 * @param {string} userAddress - 用户地址
                 * @param {Array} normalTxList - 普通交易列表
                 * @param {Array} internalTxList - 内部交易列表  
                 * @param {Array} tokenTxList - 代币交易列表
                 * @param {Object} timeRange - 时间范围
                 * @returns {Object} 处理后的交易数据
                 */
                static processAllTransactions(userAddress, normalTxList, internalTxList, tokenTxList, timeRange) {
                    console.log(`⚡ 快速处理: 普通${normalTxList.length}, 内部${internalTxList.length}, 代币${tokenTxList.length}`);
                    
                    // 使用Map进行高效的哈希查找
                    const txMap = new Map();
                    const addressLower = userAddress.toLowerCase();
                    
                    // 1. 处理普通交易 - 提取基础信息和BNB流向
                    normalTxList.forEach(tx => {
                        const time = parseInt(tx.timeStamp);
                        if (time < timeRange.start || time >= timeRange.end) return;
                        
                        const tokens = new Map();
                        
                        // 计算BNB流入/流出
                        if (tx.value && parseFloat(tx.value) > 0) {
                            const bnbValue = parseFloat(tx.value) / 1e18;
                            tokens.set('BNB', {
                                inflow: tx.to?.toLowerCase() === addressLower ? bnbValue : 0,
                                outflow: tx.from?.toLowerCase() === addressLower ? bnbValue : 0
                            });
                        }
                        
                        // 🚀 新增：检查是否可能包含USDT流向的DEX交易
                        const isPotentialDEXTx = this.isPotentialDEXTransaction(tx, addressLower);
                        
                        // 直接从交易记录计算真实gas费用 - 关键优化！
                        const gasFee = tx.gasUsed && tx.gasPrice ? 
                            (parseFloat(tx.gasUsed) * parseFloat(tx.gasPrice)) / 1e18 : 0;
                        
                        txMap.set(tx.hash, {
                            hash: tx.hash,
                            timeStamp: tx.timeStamp,
                            from: tx.from,
                            to: tx.to,
                            value: tx.value,
                            gasPrice: tx.gasPrice,
                            gasUsed: tx.gasUsed,
                            input: tx.input,
                            status: tx.isError === '0' ? '成功' : '失败',
                            tokens: tokens,
                            gasFee: gasFee,
                            txType: 'normal',
                            needsReceiptAnalysis: isPotentialDEXTx // 🚀 标记需要receipt分析
                        });
                    });
                    
                    // 2. 合并内部交易信息
                    internalTxList.forEach(tx => {
                        const time = parseInt(tx.timeStamp);
                        if (time < timeRange.start || time >= timeRange.end) return;
                        
                        const isUserInvolved = tx.from?.toLowerCase() === addressLower || 
                                             tx.to?.toLowerCase() === addressLower;
                        if (!isUserInvolved) return;
                        
                        if (txMap.has(tx.hash)) {
                            // 合并到现有交易
                            const existingTx = txMap.get(tx.hash);
                            if (!existingTx.tokens.has('BNB')) {
                                existingTx.tokens.set('BNB', { inflow: 0, outflow: 0 });
                            }
                            
                            const bnbValue = parseFloat(tx.value) / 1e18;
                            if (tx.to?.toLowerCase() === addressLower) {
                                existingTx.tokens.get('BNB').inflow += bnbValue;
                            } else if (tx.from?.toLowerCase() === addressLower) {
                                existingTx.tokens.get('BNB').outflow += bnbValue;
                            }
                        } else {
                            // 创建新的内部交易记录
                            const bnbValue = parseFloat(tx.value) / 1e18;
                            const tokens = new Map();
                            tokens.set('BNB', {
                                inflow: tx.to?.toLowerCase() === addressLower ? bnbValue : 0,
                                outflow: tx.from?.toLowerCase() === addressLower ? bnbValue : 0
                            });
                            
                            txMap.set(tx.hash, {
                                hash: tx.hash,
                                timeStamp: tx.timeStamp,
                                from: tx.from,
                                to: tx.to,
                                value: tx.value,
                                gasPrice: '0',
                                gasUsed: '0',
                                input: '',
                                status: '成功',
                                tokens: tokens,
                                gasFee: 0,
                                txType: 'internal'
                            });
                        }
                    });
                    
                    // 3. 合并代币交易信息
                    tokenTxList.forEach(tx => {
                        const time = parseInt(tx.timeStamp);
                        if (time < timeRange.start || time >= timeRange.end) return;
                        
                        const isUserInvolved = tx.from?.toLowerCase() === addressLower || 
                                             tx.to?.toLowerCase() === addressLower;
                        if (!isUserInvolved) return;
                        
                        const tokenSymbol = tx.tokenSymbol || 'Unknown';
                        const tokenAddress = tx.contractAddress || '';
                        const tokenValue = parseFloat(tx.value) / Math.pow(10, parseInt(tx.tokenDecimal || 18));
                        
                        console.log(`🪙 处理代币交易: ${tx.hash}, 代币: ${tokenSymbol}, 金额: ${tokenValue}, 合约: ${tokenAddress}`);
                        
                        if (txMap.has(tx.hash)) {
                            // 合并到现有交易
                            const existingTx = txMap.get(tx.hash);
                            if (!existingTx.tokens.has(tokenSymbol)) {
                                existingTx.tokens.set(tokenSymbol, {
                                    inflow: 0,
                                    outflow: 0,
                                    address: tokenAddress
                                });
                            }
                            
                            if (tx.to?.toLowerCase() === addressLower) {
                                existingTx.tokens.get(tokenSymbol).inflow += tokenValue;
                                console.log(`  ➡️ 合并流入: ${tokenValue} ${tokenSymbol} 到现有交易`);
                            }
                            if (tx.from?.toLowerCase() === addressLower) {
                                existingTx.tokens.get(tokenSymbol).outflow += tokenValue;
                                console.log(`  ⬅️ 合并流出: ${tokenValue} ${tokenSymbol} 到现有交易`);
                            }
                            
                            // 更新交易类型
                            if (existingTx.txType === 'normal') {
                                existingTx.txType = 'normal_with_token';
                            }
                        } else {
                            // 创建新的代币交易记录
                            const tokens = new Map();
                            tokens.set(tokenSymbol, {
                                inflow: tx.to?.toLowerCase() === addressLower ? tokenValue : 0,
                                outflow: tx.from?.toLowerCase() === addressLower ? tokenValue : 0,
                                address: tokenAddress
                            });
                            
                            console.log(`  🆕 新建代币交易: ${tokenSymbol}, 流入: ${tokens.get(tokenSymbol).inflow}, 流出: ${tokens.get(tokenSymbol).outflow}`);
                            
                            txMap.set(tx.hash, {
                                hash: tx.hash,
                                timeStamp: tx.timeStamp,
                                from: tx.from,
                                to: tx.to,
                                value: '0',
                                gasPrice: '0',
                                gasUsed: '0',
                                input: tx.input || '',
                                status: '成功',
                                tokens: tokens,
                                gasFee: 0,
                                txType: 'token'
                            });
                        }
                    });
                    
                    // 4. 转换为数组并排序（预处理完成）
                    const processedTxs = Array.from(txMap.values()).map(tx => {
                        // 将Map转换为普通对象以便JSON序列化
                        const tokensObj = {};
                        tx.tokens.forEach((value, key) => {
                            tokensObj[key] = value;
                        });
                        return {
                            ...tx,
                            tokens: tokensObj
                        };
                    }).sort((a, b) => parseInt(b.timeStamp) - parseInt(a.timeStamp));
                    
                    console.log(`⚡ 快速处理完成: ${processedTxs.length}条合并交易`);
                    
                    return {
                        allTransactions: processedTxs,
                        stats: {
                            total: processedTxs.length,
                            normal: processedTxs.filter(tx => tx.txType === 'normal').length,
                            internal: processedTxs.filter(tx => tx.txType === 'internal').length,
                            token: processedTxs.filter(tx => tx.txType === 'token').length
                        }
                    };
                }
                
                /**
                 * 快速分析稳定币交易流向（USDT + USDC）
                 * @param {string} userAddress - 用户地址
                 * @param {Array} processedTxs - 预处理的交易数据
                 * @returns {Object} 稳定币分析结果
                 */
                static async analyzeUSDTFlows(userAddress, processedTxs) {
                    const addressLower = userAddress.toLowerCase();
                    const trades = [];
                    const unknownTrades = [];
                    let totalBuy = 0, totalSell = 0, totalGasCost = 0;
                    
                    console.log(`⚡ 快速分析 ${processedTxs.length} 条交易的稳定币流向（USDT+USDC）...`);
                    
                    // 🚀 第一步：收集需要receipt分析的交易
                    const needReceiptAnalysis = processedTxs.filter(tx => tx.needsReceiptAnalysis);
                    if (needReceiptAnalysis.length > 0) {
                        console.log(`📦 发现${needReceiptAnalysis.length}个需要receipt分析的DEX交易`);
                        await this.analyzeReceiptsForUSDTFlow(needReceiptAnalysis, addressLower);
                    }
                    
                    // 🚀 扩展稳定币符号识别 - 支持USDT和USDC
                    const stablecoinSymbols = ['USDT', 'USDC', 'BSC-USD', 'Tether USD', 'USD Coin', 'USD'];
                    
                    for (const tx of processedTxs) {
                        // 使用预计算的gas费用 - 无需额外API调用
                        const gasCost = tx.gasFee || 0;
                        totalGasCost += gasCost;
                        
                        console.log(`🔍 检查交易: ${tx.hash}, 代币: ${Object.keys(tx.tokens).join(', ')}`);
                        
                        // 检查是否有USDT流向 - 支持多种符号
                        let usdtFlow = null;
                        let usdtSymbol = null;
                        let stablecoinContract = null;
                        
                        for (const symbol of stablecoinSymbols) {
                            if (tx.tokens[symbol]) {
                                usdtFlow = tx.tokens[symbol];
                                usdtSymbol = symbol;
                                stablecoinContract = tx.tokens[symbol].address || '';
                                break;
                            }
                        }
                        
                        // 如果没有找到符号，尝试通过合约地址识别稳定币
                        if (!usdtFlow) {
                            for (const [symbol, data] of Object.entries(tx.tokens)) {
                                if (data.address && STABLECOIN_CONTRACTS.includes(data.address.toLowerCase())) {
                                    usdtFlow = data;
                                    usdtSymbol = symbol;
                                    stablecoinContract = data.address;
                                    
                                    // 识别具体的稳定币类型并标准化符号
                                    if (data.address.toLowerCase() === USDT_CONTRACT.toLowerCase()) {
                                        usdtSymbol = 'USDT';
                                        console.log(`  🎯 通过合约地址识别USDT: ${symbol} (${data.address})`);
                                    } else if (data.address.toLowerCase() === USDC_CONTRACT.toLowerCase()) {
                                        usdtSymbol = 'USDC';
                                        console.log(`  🎯 通过合约地址识别USDC: ${symbol} (${data.address})`);
                                    }
                                    break;
                                }
                            }
                        }
                        
                        if (!usdtFlow || (usdtFlow.inflow === 0 && usdtFlow.outflow === 0)) {
                            console.log(`  ❌ 无稳定币流向: ${tx.hash}`);
                            // 无稳定币流向，记录为未知交易
                            if (this.isRelevantTransaction(tx, addressLower)) {
                                unknownTrades.push({
                                    hash: tx.hash,
                                    timestamp: tx.timeStamp,
                                    methodId: this.getMethodId(tx.input),
                                    gasCost: gasCost,
                                    tokenAddress: this.getRelevantTokenAddress(tx),
                                    note: this.getTransactionNote(tx)
                                });
                            }
                            continue;
                        }
                        
                        console.log(`  ✅ 发现稳定币流向 (${usdtSymbol}): 流入${usdtFlow.inflow}, 流出${usdtFlow.outflow}`);
                        
                        // 检查是否为普通转账（不计入买卖统计）
                        console.log(`🔍 开始检查是否为普通转账: ${tx.hash}`);
                        
                        // 特别调试问题交易
                        if (tx.hash === '0x84d262a5be32a426a16cbeaa5463c18752d868e43184f11509f5d17e29a121cf') {
                            console.log(`🚨🚨🚨 正在调试问题transfer交易!`);
                            console.log(`   方法ID: ${tx.input?.slice(0, 10)}`);
                            console.log(`   完整input: ${tx.input}`);
                            console.log(`   目标地址: ${tx.to}`);
                            console.log(`   稳定币合约: ${stablecoinContract}`);
                            console.log(`   交易类型: ${tx.txType}`);
                            console.log(`   交易from: ${tx.from}`);
                            console.log(`   交易value: ${tx.value}`);
                            console.log(`   代币信息: ${JSON.stringify(tx.tokens)}`);
                            console.log(`   完整交易对象:`, tx);
                        }
                        
                        const isSimpleTransfer = this.isSimpleStablecoinTransfer(tx, stablecoinContract);
                        console.log(`🔍 普通转账检查结果: ${isSimpleTransfer}`);
                        
                        if (isSimpleTransfer) {
                            console.log(`📤 跳过普通稳定币转账: ${tx.hash} (${usdtSymbol})`);
                            unknownTrades.push({
                                hash: tx.hash,
                                timestamp: tx.timeStamp,
                                methodId: 'simple_transfer',
                                gasCost: gasCost,
                                tokenAddress: stablecoinContract,
                                note: `普通${usdtSymbol}转账（未计入买卖统计）`
                            });
                            continue;
                        }
                        
                        // 分析USDT流向
                        if (usdtFlow.outflow > 0) {
                            // 稳定币流出 = 买入其他代币
                            trades.push({
                                hash: tx.hash,
                                usdtAmount: -usdtFlow.outflow,
                                tokenAmount: 0,
                                tokenAddress: stablecoinContract,
                                stablecoinType: usdtSymbol, // 新增字段标识稳定币类型
                                isBuy: true,
                                isSell: false,
                                timestamp: parseInt(tx.timeStamp),
                                gasCost: gasCost
                            });
                            totalBuy += usdtFlow.outflow;
                            console.log(`✅ ${usdtSymbol}买入: ${usdtFlow.outflow.toFixed(4)} ${usdtSymbol}, Gas: ${gasCost.toFixed(6)} BNB`);
                        }
                        
                        if (usdtFlow.inflow > 0) {
                            // 稳定币流入 = 卖出其他代币
                            trades.push({
                                hash: tx.hash,
                                usdtAmount: usdtFlow.inflow,
                                tokenAmount: 0,
                                tokenAddress: stablecoinContract,
                                stablecoinType: usdtSymbol, // 新增字段标识稳定币类型
                                isBuy: false,
                                isSell: true,
                                timestamp: parseInt(tx.timeStamp),
                                gasCost: gasCost
                            });
                            totalSell += usdtFlow.inflow;
                            console.log(`✅ ${usdtSymbol}卖出: ${usdtFlow.inflow.toFixed(4)} ${usdtSymbol}, Gas: ${gasCost.toFixed(6)} BNB`);
                        }
                    }
                    
                    console.log(`⚡ 快速分析完成: ${trades.length}笔稳定币交易, ${unknownTrades.length}笔其他交易`);
                    
                    return {
                        trades,
                        unknownTrades,
                        totalBuyValue: totalBuy,
                        totalSellValue: totalSell,
                        totalGasCost: totalGasCost
                    };
                }
                
                // 辅助方法
                static isRelevantTransaction(tx, userAddress) {
                    return tx.from?.toLowerCase() === userAddress || tx.to?.toLowerCase() === userAddress;
                }
                
                static getMethodId(input) {
                    return input && input.length >= 10 ? input.slice(0, 10) : 'unknown';
                }
                
                static getRelevantTokenAddress(tx) {
                    // 返回第一个非BNB代币地址
                    for (const [symbol, data] of Object.entries(tx.tokens)) {
                        if (symbol !== 'BNB' && data.address) {
                            return data.address;
                        }
                    }
                    return '';
                }
                
                static getTransactionNote(tx) {
                    if (tx.txType === 'internal') return '内部交易';
                    if (tx.txType === 'token') return '代币交易';
                    return '普通交易';
                }
                
                static isSimpleStablecoinTransfer(tx, stablecoinContract = null) {
                    console.log(`🔍 检查是否为普通稳定币转账: ${tx.hash}`);
                    console.log(`   方法ID: ${tx.input?.slice(0, 10)}`);
                    console.log(`   目标地址: ${tx.to}`);
                    console.log(`   稳定币合约: ${stablecoinContract}`);
                    console.log(`   交易类型: ${tx.txType}`);
                    
                    // 🚀 新增：特殊处理纯代币交易
                    if (tx.txType === 'token') {
                        console.log(`   ✅ 检测到纯代币交易，检查是否为稳定币转账`);
                        
                        // 检查是否只有一种稳定币流向，且没有其他复杂代币交换
                        const tokenKeys = Object.keys(tx.tokens);
                        const stablecoinKeys = tokenKeys.filter(key => 
                            STABLECOIN_CONTRACTS.includes(tx.tokens[key].address?.toLowerCase())
                        );
                        
                        console.log(`   代币种类: ${tokenKeys.join(', ')}`);
                        console.log(`   稳定币种类: ${stablecoinKeys.join(', ')}`);
                        
                        // 如果只涉及一种稳定币，且没有复杂的代币交换，认为是普通转账
                        if (stablecoinKeys.length === 1 && tokenKeys.length === 1) {
                            console.log(`   ✅ 纯稳定币转账，认定为普通转账`);
                            return true;
                        }
                        
                        // 如果涉及多种代币或复杂交换，可能是交易
                        if (tokenKeys.length > 1) {
                            console.log(`   ❌ 涉及多种代币，可能是交易`);
                            return false;
                        }
                    }
                    
                    // 1. 检查是否涉及DEX路由
                    if (DEX_ROUTER_LIST.includes(tx.to?.toLowerCase()) || 
                        DEX_ROUTER_LIST.includes(tx.from?.toLowerCase())) {
                        console.log(`   ❌ 涉及DEX路由，不是普通转账`);
                        return false;
                    }
                    
                    // 2. 检查方法ID
                    if (tx.input && tx.input.length > 10) {
                        const methodId = tx.input.slice(0, 10).toLowerCase();
                        console.log(`   检查方法ID: ${methodId}`);
                        
                        const swapMethods = [
                            '0xa03de6a9', '0x7c025200', '0x84bd6d29', '0x12aa3caf',
                            '0xe5e8894b', '0x7ff36ab5', '0x38ed1739', '0x18cbafe5'
                        ];
                        if (swapMethods.includes(methodId)) {
                            console.log(`   ❌ 是swap方法，不是普通转账`);
                            return false;
                        }
                        if (methodId === '0xa9059cbb') {
                            console.log(`   ✅ 是transfer方法，认定为普通转账`);
                            return true; // ERC20 transfer方法
                        }
                    }
                    
                    // 3. 检查是否直接与稳定币合约交互
                    if (stablecoinContract && tx.to?.toLowerCase() === stablecoinContract.toLowerCase()) {
                        console.log(`   ✅ 直接与稳定币合约交互，认定为普通转账`);
                        return true;
                    }
                    
                    // 4. 检查是否与任何稳定币合约交互
                    if (!stablecoinContract && STABLECOIN_CONTRACTS.includes(tx.to?.toLowerCase())) {
                        console.log(`   ✅ 与稳定币合约交互，认定为普通转账`);
                        return true;
                    }
                    
                    console.log(`   ❌ 不符合普通转账条件`);
                    return false;
                }
                
                /**
                 * 检查是否为可能包含USDT流向的DEX交易
                 * @param {Object} tx - 交易对象
                 * @param {string} userAddress - 用户地址
                 * @returns {boolean} 是否需要进一步分析
                 */
                static isPotentialDEXTransaction(tx, userAddress) {
                    console.log(`🔍 检查是否为DEX交易: ${tx.hash}`);
                    console.log(`   方法ID: ${tx.input?.slice(0, 10)}`);
                    console.log(`   目标地址: ${tx.to}`);
                    console.log(`   用户地址: ${userAddress}`);
                    console.log(`   from: ${tx.from}`);
                    
                    // 特别针对问题交易的调试
                    if (tx.hash === '0x65a753d80a95c83eac7b83139a88744f802dce45a3baea08e8d00587addf9a78') {
                        console.log(`🔥🔥🔥 正在分析问题交易!`);
                        console.log(`   输入数据: ${tx.input}`);
                        console.log(`   DEX路由列表长度: ${DEX_ROUTER_LIST.length}`);
                        console.log(`   to地址是否在DEX列表中: ${DEX_ROUTER_LIST.includes(tx.to?.toLowerCase())}`);
                        if (tx.input && tx.input.length > 10) {
                            const methodId = tx.input.slice(0, 10).toLowerCase();
                            console.log(`   提取的方法ID: ${methodId}`);
                            console.log(`   是否匹配0xa03de6a9: ${methodId === '0xa03de6a9'}`);
                        }
                    }
                    
                    // 1. 检查是否涉及用户地址
                    if (tx.from?.toLowerCase() !== userAddress && tx.to?.toLowerCase() !== userAddress) {
                        console.log(`   ❌ 不涉及用户地址`);
                        return false;
                    }
                    
                    // 2. 检查是否涉及已知的DEX路由
                    if (DEX_ROUTER_LIST.includes(tx.to?.toLowerCase())) {
                        console.log(`🎯 检测到DEX路由交易: ${tx.hash} -> ${tx.to}`);
                        return true;
                    }
                    
                    // 3. 检查方法ID是否为DEX相关
                    if (tx.input && tx.input.length > 10) {
                        const methodId = tx.input.slice(0, 10).toLowerCase();
                        const dexMethods = [
                            '0xa03de6a9', // swapExactTokensForTokens
                            '0x7c025200', // swapExactETHForTokens  
                            '0x84bd6d29', // swapExactTokensForETH
                            '0x12aa3caf', // swapExactTokensForTokensSupportingFeeOnTransferTokens
                            '0xe5e8894b', // swapExactTokensForETHSupportingFeeOnTransferTokens
                            '0x7ff36ab5', // swapExactETHForTokensSupportingFeeOnTransferTokens
                            '0x38ed1739', // swapExactTokensForTokens
                            '0x18cbafe5', // swapExactTokensForETH
                            '0xf305d719', // addLiquidityETH
                            '0xe8e33700', // addLiquidity
                            '0x02751cec', // removeLiquidity
                            '0xaf2979eb'  // removeLiquidityETH
                        ];
                        
                        if (dexMethods.includes(methodId)) {
                            console.log(`🎯 检测到DEX方法: ${tx.hash} -> ${methodId}`);
                            if (methodId === '0xa03de6a9') {
                                console.log(`🔥 特别注意: 这是callOneInch方法 ${tx.hash}`);
                            }
                            return true;
                        }
                    }
                    
                    // 4. 检查Gas使用量（DEX交易通常消耗更多Gas）
                    const gasUsed = parseFloat(tx.gasUsed || '0');
                    if (gasUsed > 100000) { // 超过10万Gas
                        console.log(`🎯 检测到高Gas交易: ${tx.hash} -> ${gasUsed} gas`);
                        return true;
                    }
                    
                    return false;
                }
                
                /**
                 * 分析交易receipt以提取USDT流向信息
                 * @param {Array} transactions - 需要分析的交易列表
                 * @param {string} userAddress - 用户地址
                 */
                static async analyzeReceiptsForUSDTFlow(transactions, userAddress) {
                    console.log(`🔍 开始分析${transactions.length}个交易的receipt...`);
                    
                    const batchSize = 3; // 批量处理避免API限制
                    for (let i = 0; i < transactions.length; i += batchSize) {
                        const batch = transactions.slice(i, i + batchSize);
                        console.log(`📦 处理receipt批次: ${i+1}-${Math.min(i+batchSize, transactions.length)}/${transactions.length}`);
                        
                        // 并行获取这一批的receipt
                        const receiptPromises = batch.map(async tx => {
                            try {
                                console.log(`📦 获取receipt: ${tx.hash}`);
                                await sleep(200); // 200ms延迟避免API限制
                                const receipt = await getTxReceipt(tx.hash);
                                console.log(`✅ 获取receipt成功: ${tx.hash}, logs数量: ${receipt?.logs?.length || 0}`);
                                return { tx, receipt };
                            } catch (e) {
                                console.warn(`⚠️ 获取receipt失败: ${tx.hash.slice(0, 10)}...`);
                                return { tx, receipt: null };
                            }
                        });
                        
                        const receiptResults = await Promise.all(receiptPromises);
                        
                        // 分析receipt中的USDT流向
                        for (const { tx, receipt } of receiptResults) {
                            if (receipt && receipt.logs) {
                                this.extractUSDTFlowFromReceipt(tx, receipt, userAddress);
                            }
                        }
                        
                        // 批次间延迟
                        if (i + batchSize < transactions.length) {
                            await sleep(500);
                        }
                    }
                    
                    console.log(`✅ Receipt分析完成`);
                }
                
                /**
                 * 从receipt的logs中提取USDT流向信息
                 * @param {Object} tx - 交易对象
                 * @param {Object} receipt - 交易receipt
                 * @param {string} userAddress - 用户地址
                 */
                static extractUSDTFlowFromReceipt(tx, receipt, userAddress) {
                    console.log(`🔍 分析稳定币流向: ${tx.hash}`);
                    console.log(`   用户地址: ${userAddress}`);
                    console.log(`   Receipt logs数量: ${receipt?.logs?.length || 0}`);
                    
                    const ERC20_TRANSFER_TOPIC = '0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef';
                    
                    // 查找USDT转账事件
                    const usdtTransfers = receipt.logs.filter(log => 
                        log.address.toLowerCase() === USDT_CONTRACT.toLowerCase() && 
                        log.topics[0] === ERC20_TRANSFER_TOPIC
                    );
                    
                    let totalInflow = 0;
                    let totalOutflow = 0;
                    
                    for (const log of usdtTransfers) {
                        try {
                            const from = '0x' + log.topics[1].slice(26).toLowerCase();
                            const to = '0x' + log.topics[2].slice(26).toLowerCase();
                            const amount = parseFloat(BigInt(log.data).toString()) / 1e18;
                            
                            console.log(`🔍 USDT Transfer: ${from.slice(0, 8)}... -> ${to.slice(0, 8)}... : ${amount} USDT`);
                            
                            // 检查是否与用户相关 - 确保用小写比较
                            if (from === userAddress.toLowerCase()) {
                                totalOutflow += amount;
                                console.log(`  📤 用户USDT流出: ${amount} USDT`);
                            }
                            if (to === userAddress.toLowerCase()) {
                                totalInflow += amount;
                                console.log(`  📥 用户USDT流入: ${amount} USDT`);
                            }
                        } catch (e) {
                            console.warn(`⚠️ 解析Transfer事件失败:`, e);
                        }
                    }
                    
                    // 将USDT流向信息添加到交易的tokens中
                    if (totalInflow > 0 || totalOutflow > 0) {
                        if (!tx.tokens['USDT']) {
                            tx.tokens['USDT'] = { inflow: 0, outflow: 0, address: USDT_CONTRACT };
                        }
                        tx.tokens['USDT'].inflow += totalInflow;
                        tx.tokens['USDT'].outflow += totalOutflow;
                        
                        console.log(`✅ 提取到USDT流向: ${tx.hash} -> 流入${totalInflow}, 流出${totalOutflow}`);
                    } else {
                        console.log(`ℹ️ 未发现USDT流向: ${tx.hash}`);
                    }
                }
            }

            // 超快分析函数 - 使用FastTransactionProcessor
            async function analyzeFast(addressInfo, transactionData, timeRange, usdtPrice, bnbPrice, usdtBalance) {
                console.log(`⚡ 使用FastTransactionProcessor超快分析 ${addressInfo.name}`);
                console.log(`📊 数据统计:`, transactionData.stats);
                
                // 确保bnbPrice是有效的数字
                if (isNaN(bnbPrice) || bnbPrice <= 0) {
                    console.warn(`检测到无效的BNB价格: ${bnbPrice}，使用默认价格660`);
                    bnbPrice = 660;
                }
                
                // 使用FastTransactionProcessor进行USDT流向分析
                const result = await FastTransactionProcessor.analyzeUSDTFlows(
                    addressInfo.address, 
                    transactionData.allTransactions
                );
                
                // 计算最终结果
                const gasCostInUSDT = result.totalGasCost * bnbPrice;
                const profitLoss = result.totalSellValue - result.totalBuyValue;
                const netProfitLoss = profitLoss - gasCostInUSDT;
                
                // 详细的分析摘要
                console.log(`📋 ${addressInfo.name} 超快分析摘要:`);
                console.log(`   📦 总交易数: ${transactionData.allTransactions.length}`);
                console.log(`   ✅ USDT交易: ${result.trades.length}`);
                console.log(`   ❓ 其他交易: ${result.unknownTrades.length}`);
                console.log(`   💰 USDT买入: ${result.trades.filter(t => t.isBuy).length}次，总额: ${result.totalBuyValue.toFixed(2)} USDT`);
                console.log(`   💸 USDT卖出: ${result.trades.filter(t => t.isSell).length}次，总额: ${result.totalSellValue.toFixed(2)} USDT`);
                console.log(`   📈 净盈亏: ${profitLoss.toFixed(2)} USDT (扣除Gas前)`);
                console.log(`   📉 实际盈亏: ${netProfitLoss.toFixed(2)} USDT (扣除Gas后)`);
                
                return {
                    name: addressInfo.name,
                    address: addressInfo.address,
                    trades: result.trades,
                    unknownTrades: result.unknownTrades,
                    totalBuyValue: result.totalBuyValue,
                    totalSellValue: result.totalSellValue,
                    profitLoss: profitLoss,
                    netProfitLoss: netProfitLoss,
                    totalGasCost: result.totalGasCost,
                    gasCostInUSDT: gasCostInUSDT,
                    bnbPrice: bnbPrice,
                    usdtPrice: usdtPrice,
                    usdtBalance: parseFloat(usdtBalance),
                    timeRange,
                    stats: transactionData.stats
                };
            }
        });
    </script>
</body>
</html>

