<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BSC USDT 统计分析工具</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        .trade-card {
            transition: all 0.2s ease;
            margin-bottom: 15px;
        }
        .trade-card:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        .buy-card {
            border-left: 4px solid #28a745;
        }
        .sell-card {
            border-left: 4px solid #dc3545;
        }
        .stats-box {
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .loader {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            margin: 20px auto;
        }
        .loading-spinner {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: conic-gradient(#0000 10%, #3498db);
            -webkit-mask: radial-gradient(farthest-side, #0000 calc(100% - 8px), #000 0);
            mask: radial-gradient(farthest-side, #0000 calc(100% - 8px), #000 0);
            animation: spin 1s infinite linear;
        }
        .loading-text {
            margin-top: 15px;
            font-size: 14px;
            color: #666;
            text-align: center;
        }
        .loading-progress {
            margin-top: 10px;
            width: 250px;
            height: 6px;
            background-color: #eee;
            border-radius: 3px;
            overflow: hidden;
        }
        .loading-progress-bar {
            height: 100%;
            background-color: #3498db;
            border-radius: 3px;
            transition: width 0.3s ease;
        }
        @keyframes spin {
            to { transform: rotate(1turn); }
        }
        .progress-info {
            background-color: rgba(52, 152, 219, 0.1);
            border-left: 4px solid #3498db;
            padding: 10px 15px;
            margin: 10px 0;
            font-size: 14px;
            color: #333;
            border-radius: 4px;
        }
        .hidden {
            display: none;
        }
        .wallet-input {
            margin-bottom: 10px;
        }
        .wallet-input .input-group-append {
            cursor: pointer;
        }
        #addWalletBtn {
            margin-bottom: 10px;
        }
        .remove-wallet {
            cursor: pointer;
            color: #dc3545;
        }
        .wallet-addresses {
            min-height: 100px;
            font-family: monospace;
        }
        .usdt-in { color: #28a745; }
        .usdt-out { color: #dc3545; }
        .ellipsis { max-width: 120px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; display: inline-block; vertical-align: bottom; }
    </style>
</head>
<body>
    <div class="container py-4">
        <h1 class="mb-4 text-center">BSC USDT 统计分析工具</h1>
        
        <div class="card mb-4">
            <div class="card-body">
                <form id="analyzeForm">
                    <div class="row g-3">
                        <div class="col-md-8">
                            <label class="form-label">BSC 钱包地址（支持带名称，每行一个）</label>
                            <textarea class="form-control wallet-addresses" rows="5" placeholder="输入格式：
名称 0x开头的BSC钱包地址
例如：
念安1 0xXX
念安2 0xXX" required></textarea>
                            <small class="text-muted">每行一个地址，可以在地址前加名称（用空格分隔）</small>
                        </div>
                        <div class="col-md-4">
                            <label for="date" class="form-label">统计日期</label>
                            <input type="date" class="form-control" id="date">
                            <small class="text-muted">不填默认统计今天8:00到明天8:00的数据</small>
                        </div>
                        <div class="col-md-4">
                            <label for="txLimit" class="form-label">交易处理限制</label>
                            <select class="form-control" id="txLimit">
                                <option value="50">仅处理最近50笔交易</option>
                                <option value="100">仅处理最近100笔交易</option>
                                <option value="200">仅处理最近200笔交易</option>
                                <option value="all" selected>处理所有交易</option>
                            </select>
                            <small class="text-muted">限制处理的交易数量可以提高性能</small>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <button type="submit" class="btn btn-primary">
                                <span class="normal-text">分析</span>
                                <span class="spinner-border spinner-border-sm hidden" id="submitSpinner" role="status"></span>
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <div id="errorMessage" class="alert alert-danger hidden" role="alert"></div>
        <div id="loader" class="loader hidden">
            <div class="loading-spinner"></div>
            <div class="loading-text">正在分析交易数据...</div>
            <div class="loading-progress">
                <div class="loading-progress-bar" style="width: 0%"></div>
            </div>
            <div id="loading-detail" class="loading-text"></div>
        </div>

        <div id="resultContainer" class="hidden">
            <div class="card mb-4">
                <div class="card-header">
                    <h4>分析结果</h4>
                    <p class="text-muted mb-0" id="timeRangeInfo"></p>
                </div>
            </div>

            <!-- 账户分析结果容器 -->
            <div id="accountsContainer"></div>

            <div id="noTradesMessage" class="alert alert-info hidden">在指定时间范围内没有找到USDT买卖</div>
        </div>
        
        <div class="mt-4 text-center">
            <p class="text-muted mb-2">
                作者: 东东 
                <a href="https://x.com/lumaodaren" target="_blank" class="text-decoration-none">
                    <i class="bi bi-twitter-x"></i> @lumaodaren
                </a>
            </p>
            <p class="text-muted">
                <a href="https://github.com/sincitysh/bscalpha" target="_blank" class="text-decoration-none">
                    <i class="bi bi-github"></i> 查看源码
                </a>
                |
                本工具在GitHub Pages上运行，无需服务器
            </p>
        </div>
    </div>

    <!-- 添加Web3.js库 -->
    <script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>
    
    <!-- 添加Bootstrap的JavaScript依赖 -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        function getTimeRange(dateStr) {
            const now = new Date();
            // 先转为北京时间
            const beijingOffset = 8 * 60; // 东八区
            const localOffset = now.getTimezoneOffset();
            const diff = beijingOffset + localOffset;
            const beijingNow = new Date(now.getTime() + diff * 60 * 1000);

            let startDate, endDate;
            if (dateStr) {
                startDate = new Date(dateStr);
                startDate.setHours(8, 0, 0, 0);
            } else {
                startDate = new Date(beijingNow);
                startDate.setHours(8, 0, 0, 0);
                if (beijingNow.getHours() < 8) startDate.setDate(startDate.getDate() - 1);
            }
            endDate = new Date(startDate);
            endDate.setDate(endDate.getDate() + 1);
            return {
                start: Math.floor(startDate.getTime() / 1000),
                end: Math.floor(endDate.getTime() / 1000),
                startDate, endDate
            };
        }

        const USDT_CONTRACT = '0x55d398326f99059fF775485246999027B3197955';

        const BSCSCAN_API_KEYS = [
            'GFCARE1KCXRXZUTWYCRV9K65Q1V8BXZU3K',
            'AMQYJJTKB7H8GGSDY3K42G989M6S7INCFG',
            'R613WACX85IZPMASA6K8EAXTT85JQQG6J8',
            'W8U2D8MVYQCVN2TR1FU5IJB186436997CF',
            'T8RZ9IAIMPPDE665TSIP14Y3RYAWK23W3I'
        ];

        function getRandomApiKey() {
            const randomIndex = Math.floor(Math.random() * BSCSCAN_API_KEYS.length);
            return BSCSCAN_API_KEYS[randomIndex];
        }

        const DEX_ROUTER_LIST = [
            '0x10ed43c718714eb63d5aa57b78b54704e256024e', // PancakeSwap v2
            '0x05fF2B0DB69458A0750badebc4f9e13aDd608C7F', // PancakeSwap v1
            '0x3a6d8ca21d1cf76f653a67577fa0d27453350dd8', // BiSwap
            '0xcDe540d7eAFE93aC5fE6233Bee57E1270D3E330F', // BakerySwap
            '0xC0788A3aD43d79aa53B09c2EaCc313A787d1d607', // ApeSwap
            '0x7a6e4e3cc2ac9924605dc68f5d95e75e5f629b31', // Mdex Router
            '0x1b96b92314c44b159149f7e0303511fb2fc4774f', // PancakeSwap v2 (老路由)
            '0x1111111254eeb25477b68fb85ed929f73a960582', // 1inch v4 Router
            '0x11111112542d85b3ef69ae05771c2dccff4faa26', // 1inch v3 Router
            '0x111111125434b319222cdbf8c261674adb56f3ae', // 1inch v2 Router
        ];

        // 定义路由地址
        const routerAddresses = {
            'PancakeSwap': '0x10ED43C718714eb63d5aA57B78B54704E256024E'.toLowerCase(),
            'BiSwap': '0x3a6d8cA21D1CF76F653A67577FA0D27453350dD8'.toLowerCase(),
            'BaseSwap': '0x13f4EA83D0bd40E75C8222255bc855a974568Dd4'.toLowerCase(),
            'BaseSwapRouter': '0xb300000b72deaeb607a12d5f54773d1c19c7028d'.toLowerCase(), // 确保这个地址正确添加
            // ... 其他地址 ...
        };

        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('analyzeForm');
            const loader = document.getElementById('loader');
            const errorMessage = document.getElementById('errorMessage');
            const resultContainer = document.getElementById('resultContainer');
            const submitSpinner = document.getElementById('submitSpinner');
            const noTradesMessage = document.getElementById('noTradesMessage');
            
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                // 获取并处理钱包地址
                const addressesText = form.querySelector('.wallet-addresses').value;
                const addressEntries = addressesText.split('\n')
                    .map(line => {
                        const parts = line.trim().split(/[\s\t]+/);
                        if (parts.length >= 2) {
                            return {
                                name: parts[0],
                                address: parts[parts.length - 1].trim()
                            };
                        } else if (parts.length === 1 && parts[0]) {
                            return {
                                name: '未命名',
                                address: parts[0].trim()
                            };
                        }
                        return null;
                    })
                    .filter(Boolean);
                
                // 验证地址
                for (const entry of addressEntries) {
                    if (!isValidAddress(entry.address)) {
                        errorMessage.textContent = `无效的钱包地址格式: ${entry.address}`;
                        errorMessage.classList.remove('hidden');
                        return;
                    }
                }

                if (addressEntries.length === 0) {
                    errorMessage.textContent = '请至少输入一个钱包地址';
                    errorMessage.classList.remove('hidden');
                    return;
                }
                
                const date = document.getElementById('date').value;
                
                console.log('开始分析，输入的钱包地址：', addressesText);
                console.log('解析后的地址对象：', addressEntries);
                console.log('选择的日期：', date);
                
                // 显示加载状态
                toggleLoading(true);
                errorMessage.classList.add('hidden');
                errorMessage.textContent = '';
                resultContainer.classList.add('hidden');
                
                try {
                    // 获取时间范围
                    const timeRange = getTimeRange(date);
                    console.log('统计时间范围:', timeRange);
                    
                    // 获取所有地址的交易
                    let allTransactions = [];
                    const errors = [];
                    
                    // 串行处理每个地址，避免并发请求
                    for (const entry of addressEntries) {
                        try {
                            console.log(`开始获取地址 ${entry.name} (${entry.address}) 的USDT转账...`);
                            const txLimit = document.getElementById('txLimit').value;
                            const transfers = await getUSDTTransfers(entry.address, timeRange, txLimit);
                            console.log(`地址 ${entry.name} 获取到 ${transfers.length} 条USDT转账`);
                            console.log(`【${entry.name}】USDT转账原始数据:`, transfers);
                            allTransactions = allTransactions.concat(transfers.map(tx => ({...tx, accountName: entry.name})));
                        } catch (error) {
                            errors.push(`${entry.name}: ${error.message}`);
                            console.error(`处理地址 ${entry.name} 时出错:`, error);
                        }
                    }
                    
                    // 如果有错误但仍有一些成功的结果，显示警告
                    if (errors.length > 0) {
                        const warningDiv = document.createElement('div');
                        warningDiv.className = 'alert alert-warning';
                        warningDiv.innerHTML = `
                            <h5>部分数据获取失败</h5>
                            <ul class="mb-0">
                                ${errors.map(err => `<li>${err}</li>`).join('')}
                            </ul>
                        `;
                        resultContainer.insertBefore(warningDiv, resultContainer.firstChild);
                    }
                    
                    // 如果完全没有数据，显示错误
                    if (allTransactions.length === 0 && errors.length > 0) {
                        throw new Error('所有地址的数据获取均失败');
                    }
                    
                    if (allTransactions.length === 0) {
                        resultContainer.classList.remove('hidden');
                        noTradesMessage.classList.remove('hidden');
                        document.getElementById('timeRangeInfo').textContent = `统计时间: ${formatTime(timeRange.start)} 至 ${formatTime(timeRange.end)}`;
                        return;
                    }
                    
                    // 获取当前USDT价格
                    const usdtPrice = await getUSDTPrice();
                    
                    // 获取所有地址的USDT余额总和
                    let totalBalance = 0;
                    for (const entry of addressEntries) {
                        const balance = await getUSDTBalance(entry.address);
                        totalBalance += parseFloat(balance);
                    }
                    
                    // 分析交易
                    const allAnalysis = [];
                    for (const entry of addressEntries) {
                        const txs = allTransactions.filter(tx => tx.accountName === entry.name);
                        const bnbPrice = await getBNBPrice();
                        const analysis = await analyzeTransactions(entry, txs, timeRange, usdtPrice, bnbPrice, await getUSDTBalance(entry.address));
                        allAnalysis.push(analysis);
                    }
                    
                    // 渲染结果
                    await renderResults({
                        success: true,
                        addressEntries,
                        allAnalysis
                    });
                    
                    resultContainer.classList.remove('hidden');
                } catch (error) {
                    console.error('分析失败:', error);
                    errorMessage.textContent = error.message || '处理请求时发生错误';
                    errorMessage.classList.remove('hidden');
                } finally {
                    toggleLoading(false);
                }
            });
            
            function toggleLoading(isLoading) {
                if (isLoading) {
                    loader.classList.remove('hidden');
                    submitSpinner.classList.remove('hidden');
                    document.querySelector('.normal-text').classList.add('hidden');
                    document.querySelector('.loading-progress-bar').style.width = '0%';
                    document.getElementById('loading-detail').textContent = '准备分析...';
                } else {
                    loader.classList.add('hidden');
                    submitSpinner.classList.add('hidden');
                    document.querySelector('.normal-text').classList.remove('hidden');
                }
            }
            
            function isValidAddress(address) {
                return /^0x[a-fA-F0-9]{40}$/.test(address);
            }
            
            // 获取USDT价格（USDT对USDT永远是1）
            async function getUSDTPrice() {
                return 1;
            }
            
            // 获取USDT余额
            async function getUSDTBalance(address) {
                const url = `https://api.bscscan.com/api?module=account&action=tokenbalance&contractaddress=${USDT_CONTRACT}&address=${address}&tag=latest&apikey=${getRandomApiKey()}`;
                const res = await fetch(url);
                const data = await res.json();
                return parseFloat(data.result) / 1e18;
            }
            
            // 获取地址交易
            async function getTxList(address, timeRange) {
                const url = `https://api.bscscan.com/api?module=account&action=txlist&address=${address}&startblock=0&endblock=99999999&starttime=${timeRange.start}&endtime=${timeRange.end}&sort=asc&apikey=${getRandomApiKey()}`;
                const res = await fetch(url);
                const data = await res.json();
                if (!Array.isArray(data.result)) {
                    console.error('BscScan返回异常:', data);
                    return [];
                }
                return data.result;
            }
            
            // 使用缓存减少重复请求
            const receiptCache = {};
            const txDetailCache = {};
            
            async function getTxReceipt(txHash) {
                if (receiptCache[txHash]) return receiptCache[txHash];
                
                const url = `https://api.bscscan.com/api?module=proxy&action=eth_getTransactionReceipt&txhash=${txHash}&apikey=${getRandomApiKey()}`;
                try {
                    const res = await fetch(url);
                    const data = await res.json();
                    receiptCache[txHash] = data.result;
                    return data.result;
                } catch (e) {
                    console.error(`获取交易收据失败: ${txHash}`, e);
                    return null;
                }
            }
            
            async function getTxDetail(txHash) {
                if (txDetailCache[txHash]) return txDetailCache[txHash];
                
                const url = `https://api.bscscan.com/api?module=proxy&action=eth_getTransactionByHash&txhash=${txHash}&apikey=${getRandomApiKey()}`;
                try {
                    const res = await fetch(url);
                    const data = await res.json();
                    txDetailCache[txHash] = data.result;
                    return data.result;
                } catch (e) {
                    console.error(`获取交易详情失败: ${txHash}`, e);
                    return null;
                }
            }
            
            // 获取地址USDT相关的所有转账（包括合约内部swap）
            async function getUSDTTransfers(address, timeRange, txLimit) {
                // 同时获取代币转账和普通交易，确保捕获所有可能的USDT交易
                const [tokenTxs, normalTxs] = await Promise.all([
                    // 获取USDT代币转账
                    (async () => {
                        const url = `https://api.bscscan.com/api?module=account&action=tokentx&contractaddress=${USDT_CONTRACT}&address=${address}&startblock=0&endblock=99999999&starttime=${timeRange.start}&endtime=${timeRange.end}&sort=asc&apikey=${getRandomApiKey()}`;
                        const res = await fetch(url);
                        const data = await res.json();
                        return Array.isArray(data.result) ? data.result : [];
                    })(),
                    // 获取所有普通交易，但限制处理数量
                    (async () => {
                        const url = `https://api.bscscan.com/api?module=account&action=txlist&address=${address}&startblock=0&endblock=99999999&starttime=${timeRange.start}&endtime=${timeRange.end}&sort=asc&apikey=${getRandomApiKey()}`;
                        const res = await fetch(url);
                        const data = await res.json();
                        let allTxs = Array.isArray(data.result) ? data.result : [];
                        
                        // 首先筛选时间范围
                        allTxs = allTxs.filter(tx => {
                            const txTime = parseInt(tx.timeStamp);
                            return txTime >= timeRange.start && txTime <= timeRange.end;
                        });
                        
                        console.log(`获取到 ${allTxs.length} 条符合时间范围的普通交易`);
                        
                        // 再应用交易限制
                        if (txLimit !== 'all') {
                            const limitNum = parseInt(txLimit);
                            allTxs = allTxs.slice(-limitNum);
                            console.log(`应用交易限制，仅处理最近 ${txLimit} 笔交易`);
                        }
                        
                        return allTxs;
                    })()
                ]);
                
                console.log(`地址 ${address} USDT代币转账: ${tokenTxs.length}条`);
                console.log(`地址 ${address} 普通交易: ${normalTxs.length}条`);
                
                // 合并交易数据，确保不重复
                const hashSet = new Set();
                const mergedTxs = [];
                
                // 添加USDT代币转账
                for (const tx of tokenTxs) {
                    hashSet.add(tx.hash);
                    mergedTxs.push(tx);
                }
                
                // 分批处理普通交易，每批处理50个
                const batchSize = 50;
                const totalTxs = normalTxs.length;
                for (let i = 0; i < normalTxs.length; i += batchSize) {
                    const batch = normalTxs.slice(i, i + batchSize);
                    const progress = Math.min(100, Math.round((i / totalTxs) * 100));
                    console.log(`处理第 ${i/batchSize + 1} 批交易 (${i}-${i+batch.length})`);
                    
                    // 更新UI以显示进度
                    document.getElementById('loading-detail').textContent = `处理中: ${i}/${totalTxs} 条交易`;
                    document.querySelector('.loading-progress-bar').style.width = `${progress}%`;
                    
                    // 给UI时间更新
                    await new Promise(resolve => setTimeout(resolve, 0));
                    
                    for (const tx of batch) {
                        // 如果已经有这个hash了，跳过
                        if (hashSet.has(tx.hash)) continue;
                        
                        // 检查是否是swap交易
                        if (tx.input && tx.input.length >= 10) {
                            const methodId = tx.input.slice(0, 10).toLowerCase();
                            const swapMethods = [
                                '0xa03de6a9', // 1inch callOneInch
                                '0x7c025200', // 1inch swap
                                '0x84bd6d29', // 1inch clipperSwap
                                '0x12aa3caf', // 1inch swap variant
                                '0xe449022e', // 1inch uniswapV3Swap
                                '0x90411a32', // 1inch swap variant
                                '0xdad12b6c', // 1inch proxySwap
                                '0xe5e8894b', // 1inch proxySwapV2
                                '0x7ff36ab5', // PancakeSwap swapExactETHForTokens
                                '0x38ed1739', // PancakeSwap swapExactTokensForTokens
                                '0x18cbafe5', // PancakeSwap swapExactTokensForETH
                                '0x8803dbee', // PancakeSwap swapTokensForExactTokens
                            ];
                            
                            const isDexRouter = DEX_ROUTER_LIST.includes(tx.to.toLowerCase());
                            
                            if (swapMethods.includes(methodId) || isDexRouter) {
                                // 这可能是一个swap交易，获取交易收据检查是否涉及USDT
                                const receipt = await getTxReceipt(tx.hash);
                                if (receipt && receipt.logs) {
                                    const ERC20_TRANSFER_TOPIC = '0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef';
                                    const hasUsdtTransfer = receipt.logs.some(log => 
                                        log.address.toLowerCase() === USDT_CONTRACT.toLowerCase() && 
                                        log.topics[0] === ERC20_TRANSFER_TOPIC
                                    );
                                    
                                    if (hasUsdtTransfer) {
                                        console.log(`发现swap交易涉及USDT: ${tx.hash} (方法ID: ${methodId})`);
                                        // 为了保持格式一致，添加contractAddress字段
                                        tx.contractAddress = USDT_CONTRACT;
                                        mergedTxs.push(tx);
                                        hashSet.add(tx.hash);
                                    }
                                }
                            }
                        }
                    }
                }
                
                console.log(`合并后总共: ${mergedTxs.length}条交易`);
                return mergedTxs;
            }
            
            // 解析交易数据
            async function analyzeTransactions(addressInfo, transfers, timeRange, usdtPrice, bnbPrice, usdtBalance) {
                const grouped = groupByHash(transfers);
                console.log(`【${addressInfo.name}】USDT转账分组（按hash）:`, grouped.map(g => g[0].hash));
                const trades = [];
                let totalBuy = 0, totalSell = 0, totalGasCost = 0;
                
                const totalTxs = grouped.length;
                document.getElementById('loading-detail').textContent = `分析 ${addressInfo.name} 的交易: 0/${totalTxs}`;
                document.querySelector('.loading-progress-bar').style.width = '0%';
                
                for (let i = 0; i < grouped.length; i++) {
                    const progress = Math.min(100, Math.round((i / totalTxs) * 100));
                    document.getElementById('loading-detail').textContent = `分析 ${addressInfo.name} 的交易: ${i+1}/${totalTxs}`;
                    document.querySelector('.loading-progress-bar').style.width = `${progress}%`;
                    
                    const txGroup = grouped[i];
                    const tx = txGroup[0];
                    const time = parseInt(tx.timeStamp);
                    
                    if (time < timeRange.start || time >= timeRange.end) continue;
                    
                    // 添加超时处理
                    const tradePromise = analyzeTxGroup(txGroup, addressInfo.address);
                    const timeoutPromise = new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('分析超时')), 10000)
                    );
                    
                    try {
                        const trade = await Promise.race([tradePromise, timeoutPromise]);
                        if (trade) {
                            trades.push(trade);
                            if (trade.isBuy) totalBuy += Math.abs(trade.usdtAmount);
                            if (trade.isSell) totalSell += Math.abs(trade.usdtAmount);
                            totalGasCost += trade.gasCost || 0;
                        }
                    } catch (e) {
                        console.error(`分析交易 ${tx.hash} 失败:`, e);
                        // 继续处理下一个交易
                    }
                }
                
                // 不需要移除progressDiv，而是清空加载详情
                document.getElementById('loading-detail').textContent = '分析完成';
                
                const gasCostInUSDT = totalGasCost * bnbPrice;
                const netProfitLoss = totalSell - totalBuy - gasCostInUSDT;
                
                const analysis = {
                    name: addressInfo.name,
                    address: addressInfo.address,
                    trades,
                    totalBuyValue: totalBuy,
                    totalSellValue: totalSell,
                    profitLoss: totalSell - totalBuy,
                    netProfitLoss: netProfitLoss,
                    totalGasCost: totalGasCost,
                    gasCostInUSDT: gasCostInUSDT,
                    bnbPrice: bnbPrice,
                    usdtPrice: usdtPrice,
                    usdtBalance: parseFloat(usdtBalance),
                    timeRange
                };
                return analysis;
            }
            
            async function renderResults(data) {
                const { addressEntries, allAnalysis } = data;
                const accountsContainer = document.getElementById('accountsContainer');
                accountsContainer.innerHTML = '';

                // 计算总亏损和是否有交易
                let totalLoss = 0;
                let totalTrades = 0;
                allAnalysis.forEach(analysis => {
                    totalLoss += analysis.netProfitLoss < 0 ? Math.abs(analysis.netProfitLoss) : 0;
                    totalTrades += analysis.trades.length;
                });

                // 创建总结卡片
                const summaryCard = document.createElement('div');
                summaryCard.className = 'card mb-4';
                
                if (totalTrades === 0) {
                    summaryCard.innerHTML = `
                        <div class="card-body bg-info text-white">
                            <h5 class="card-title">⚠️ 未检测到交易记录</h5>
                            <p class="mb-0">可能原因：</p>
                            <ul class="mb-0">
                                <li>今日未进行交易</li>
                                <li>API 访问异常，请稍后重试</li>
                                <li>选择的时间范围内无交易</li>
                            </ul>
                        </div>
                    `;
                } else if (totalLoss < 5) {
                    const pigFeetMeals = Math.ceil(totalLoss / 2);
                    summaryCard.innerHTML = `
                        <div class="card-body bg-warning">
                            <h5 class="card-title">😅 今日小亏 ${totalLoss.toFixed(2)} USDT</h5>
                            <p class="mb-0">相当于丢失了 ${pigFeetMeals} 顿猪脚饭 (按2U/顿计算)</p>
                            <small class="text-muted">别灰心，明天会更好！</small>
                        </div>
                    `;
                } else if (totalLoss >= 50) {
                    const hotPotMeals = Math.ceil(totalLoss / 50);
                    summaryCard.innerHTML = `
                        <div class="card-body bg-danger text-white">
                            <h5 class="card-title">😱 今日大亏 ${totalLoss.toFixed(2)} USDT</h5>
                            <p class="mb-0">相当于错过了 ${hotPotMeals} 顿海底捞 (按50U/顿计算)</p>
                            <small>建议休息一下，调整心态！</small>
                        </div>
                    `;
                } else {
                    const pigFeetMeals = Math.ceil(totalLoss / 2);
                    summaryCard.innerHTML = `
                        <div class="card-body bg-warning">
                            <h5 class="card-title">😓 今日亏损 ${totalLoss.toFixed(2)} USDT</h5>
                            <p class="mb-0">相当于丢失了 ${pigFeetMeals} 顿猪脚饭 (按2U/顿计算)</p>
                            <small class="text-muted">调整策略，明天继续！</small>
                        </div>
                    `;
                }

                // 将总结卡片插入到结果容器的开头
                accountsContainer.insertBefore(summaryCard, accountsContainer.firstChild);

                // 继续渲染原有的账户分析结果
                for (let i = 0; i < addressEntries.length; i++) {
                    const entry = addressEntries[i];
                    const analysis = allAnalysis[i];
                    // 获取当前USDT余额
                    const balance = await getUSDTBalance(entry.address);
                    
                    const accountCard = document.createElement('div');
                    accountCard.className = 'card mb-4';
                    accountCard.innerHTML = `
                        <div class="card-header bg-light">
                            <h5 class="mb-0">
                                <i class="bi bi-person-circle"></i> 
                                ${entry.name}
                                <small class="text-muted">${entry.address}</small>
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="stats-box bg-light">
                                        <h6 class="border-bottom pb-2">USDT买卖统计</h6>
                                        <div class="d-flex justify-content-between">
                                            <span>买入总额:</span>
                                            <span class="fw-bold usdt-out">${analysis.totalBuyValue.toFixed(6)} USDT</span>
                                        </div>
                                        <div class="d-flex justify-content-between">
                                            <span>卖出总额:</span>
                                            <span class="fw-bold usdt-in">${analysis.totalSellValue.toFixed(6)} USDT</span>
                                        </div>
                                        <div class="d-flex justify-content-between">
                                            <span>净盈亏:</span>
                                            <span class="fw-bold">${analysis.netProfitLoss.toFixed(6)} USDT</span>
                                        </div>
                                        <div class="d-flex justify-content-between">
                                            <span>当前USDT余额:</span>
                                            <span class="fw-bold">${balance.toFixed(6)} USDT</span>
                                        </div>
                                        <div class="d-flex justify-content-between">
                                            <span>总Gas消耗:</span>
                                            <span class="fw-bold">${analysis.totalGasCost.toFixed(6)} BNB ≈ ${analysis.gasCostInUSDT.toFixed(2)} USDT</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-8">
                                    <div class="stats-box bg-light">
                                        <h6 class="border-bottom pb-2">USDT买卖明细</h6>
                                        <div class="table-responsive">
                                            <table class="table table-sm table-bordered">
                                                <thead>
                                                    <tr>
                                                        <th>时间</th>
                                                        <th>类型</th>
                                                        <th>USDT金额</th>
                                                        <th>代币金额</th>
                                                        <th>代币合约</th>
                                                        <th>交易</th>
                                                        <th>Gas费用（BNB）</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    ${
                                                        analysis.trades.length === 0
                                                        ? '<tr><td colspan="6">无USDT买卖记录</td></tr>'
                                                        : analysis.trades.map(d => `
                                                            <tr>
                                                                <td>${formatTime(d.timestamp)}</td>
                                                                <td class="${d.usdtAmount < 0 ? 'usdt-out' : 'usdt-in'}">
                                                                    ${d.usdtAmount < 0 ? '用USDT买入' : '用其他币换USDT'}
                                                                </td>
                                                                <td>${Math.abs(d.usdtAmount).toFixed(6)}</td>
                                                                <td>${d.tokenAmount.toFixed(6)}</td>
                                                                <td class="ellipsis" title="${d.tokenAddress}">${d.tokenAddress}</td>
                                                                <td><a href="https://bscscan.com/tx/${d.hash}" target="_blank">查看</a></td>
                                                                <td>${d.gasCost ? d.gasCost.toFixed(6) : '-'}</td>
                                                            </tr>
                                                        `).join('')
                                                    }
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    accountsContainer.appendChild(accountCard);
                }
                console.log('渲染分析结果：', allAnalysis);
            }

            function formatTime(ts) {
                return new Date(ts * 1000).toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai', hour12: false });
            }

            // 解析一笔交易，判断是否为USDT买入/卖出
            async function analyzeTx(tx, address) {
                const receipt = await getTxReceipt(tx.hash);
                if (!receipt || !receipt.logs) return null;
                const ERC20_TRANSFER_TOPIC = '0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef';
                let usdtIn = 0, usdtOut = 0, tokenIn = 0, tokenOut = 0, tokenAddress = '';
                for (const log of receipt.logs) {
                    if (log.topics[0] === ERC20_TRANSFER_TOPIC) {
                        const contract = log.address.toLowerCase();
                        const from = '0x' + log.topics[1].slice(26).toLowerCase();
                        const to = '0x' + log.topics[2].slice(26).toLowerCase();
                        let amount = 0;
                        try {
                            if (log.data && log.data !== "0x") {
                                amount = parseFloat(BigInt(log.data).toString()) / 1e18;
                            }
                        } catch (e) {
                            amount = 0;
                        }
                        if (contract === USDT_CONTRACT.toLowerCase()) {
                            if (from === address.toLowerCase()) usdtOut += amount;
                            if (to === address.toLowerCase()) usdtIn += amount;
                        } else if (from === address.toLowerCase() || to === address.toLowerCase()) {
                            if (!tokenAddress) tokenAddress = contract;
                            if (from === address.toLowerCase()) tokenOut += amount;
                            if (to === address.toLowerCase()) tokenIn += amount;
                        }
                    }
                }
                if (usdtOut > 0 && tokenIn > 0) {
                    return {
                        hash: tx.hash,
                        usdtAmount: -usdtOut,
                        tokenAmount: tokenIn,
                        tokenAddress,
                        isBuy: true,
                        isSell: false,
                        timestamp: tx.timeStamp
                    };
                }
                if (usdtIn > 0 && tokenOut > 0) {
                    return {
                        hash: tx.hash,
                        usdtAmount: usdtIn,
                        tokenAmount: -tokenOut,
                        tokenAddress,
                        isBuy: false,
                        isSell: true,
                        timestamp: tx.timeStamp
                    };
                }
                return null;
            }

            function groupByHash(transfers) {
                const map = {};
                for (const tx of transfers) {
                    if (!map[tx.hash]) map[tx.hash] = [];
                    map[tx.hash].push(tx);
                }
                return Object.values(map);
            }

            function analyzeUSDTTrades(address, groupedTxs, timeRange) {
                const trades = [];
                let totalBuy = 0, totalSell = 0;
                for (const txGroup of groupedTxs) {
                    // 取消路由过滤
                    // const isSwap = txGroup.some(tx =>
                    //     DEX_ROUTER_LIST.includes(tx.to.toLowerCase()) ||
                    //     DEX_ROUTER_LIST.includes(tx.from.toLowerCase())
                    // );
                    // if (!isSwap) continue;

                    // 时间过滤
                    const time = parseInt(txGroup[0].timeStamp);
                    if (time < timeRange.start || time >= timeRange.end) continue;

                    let usdtIn = 0, usdtOut = 0;
                    let hash = txGroup[0].hash;
                    let tokenAddress = txGroup[0].contractAddress;
                    for (const tx of txGroup) {
                        if (tx.to.toLowerCase() === address.toLowerCase()) {
                            usdtIn += parseFloat(tx.value) / 1e18;
                        }
                        if (tx.from.toLowerCase() === address.toLowerCase()) {
                            usdtOut += parseFloat(tx.value) / 1e18;
                        }
                    }
                    if (usdtOut > 0) {
                        trades.push({
                            hash,
                            usdtAmount: -usdtOut,
                            tokenAmount: 0,
                            tokenAddress,
                            isBuy: true,
                            isSell: false,
                            timestamp: time
                        });
                        totalBuy += usdtOut;
                    }
                    if (usdtIn > 0) {
                        trades.push({
                            hash,
                            usdtAmount: usdtIn,
                            tokenAmount: 0,
                            tokenAddress,
                            isBuy: false,
                            isSell: true,
                            timestamp: time
                        });
                        totalSell += usdtIn;
                    }
                }
                return { trades, totalBuy, totalSell };
            }

            // 解析一组同hash的USDT转账，判断是否为USDT买入/卖出
            async function analyzeTxGroup(txGroup, address) {
                const tx = txGroup[0];
                const receipt = await getTxReceipt(tx.hash);
                if (!receipt || !receipt.logs) {
                    console.log(`【${address}】hash:${tx.hash} 没有收据或logs`);
                    return null;
                }

                // 获取主交易详情
                const txDetail = await getTxDetail(tx.hash);
                if (!txDetail) {
                    console.log(`【${address}】hash:${tx.hash} 没有主交易详情`);
                    return null;
                }
                
                const methodId = txDetail.input ? txDetail.input.slice(0, 10).toLowerCase() : '';
                console.log(`交易 ${tx.hash} 方法ID: ${methodId}`);
                
                // 判断是否为swap类交易
                const isSwap = (() => {
                    if (!txDetail.input) return false;
                    const input = txDetail.input.slice(0, 10).toLowerCase();
                    // 1inch、PancakeSwap等swap方法
                    const swapMethods = [
                        '0xa03de6a9', // 1inch callOneInch
                        '0x7c025200', // 1inch swap
                        '0x84bd6d29', // 1inch clipperSwap
                        '0x12aa3caf', // 1inch swap variant
                        '0xe449022e', // 1inch uniswapV3Swap
                        '0x90411a32', // 1inch swap variant
                        '0xdad12b6c', // 1inch proxySwap
                        '0xe5e8894b', // 1inch proxySwapV2
                        '0x7ff36ab5', // PancakeSwap swapExactETHForTokens
                        '0x38ed1739', // PancakeSwap swapExactTokensForTokens
                        '0x18cbafe5', // PancakeSwap swapExactTokensForETH
                        '0x8803dbee', // PancakeSwap swapTokensForExactTokens
                    ];
                    if (swapMethods.includes(input)) return true;
                    // 目标地址是DEX路由
                    if (DEX_ROUTER_LIST.includes(tx.to.toLowerCase())) return true;
                    return false;
                })();

                // 即使不是swap交易，也尝试分析USDT转账
                // 这能确保捕获所有类型的USDT交易

                // 计算gas费用
                const gasUsed = parseInt(receipt.gasUsed, 16);
                const gasPrice = parseInt(txDetail.gasPrice, 16);
                const gasCost = gasUsed * gasPrice / 1e18;

                const ERC20_TRANSFER_TOPIC = '0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef';
                let usdtIn = 0, usdtOut = 0, tokenIn = 0, tokenOut = 0, tokenAddress = '';

                // 特别处理1inch交易
                const is1inch = ['0xdad12b6c', '0xe5e8894b', '0xa03de6a9'].includes(methodId);
                if (is1inch) {
                    console.log(`处理1inch交易: ${tx.hash} (方法: ${methodId}), 来自: ${tx.from.toLowerCase()}, 目标: ${tx.to.toLowerCase()}`);
                    
                    // 仔细检查1inch交易的日志
                    for (const log of receipt.logs) {
                        if (log.topics[0] === ERC20_TRANSFER_TOPIC) {
                            const contract = log.address.toLowerCase();
                            const from = '0x' + log.topics[1].slice(26).toLowerCase();
                            const to = '0x' + log.topics[2].slice(26).toLowerCase();
                            let amount = 0;
                            try {
                                if (log.data && log.data !== "0x") {
                                    amount = parseFloat(BigInt(log.data).toString()) / 1e18;
                                }
                            } catch (e) {
                                amount = 0;
                            }
                            
                            console.log(`1inch日志: 合约=${contract}, 从=${from}, 到=${to}, 金额=${amount}, 用户地址=${address.toLowerCase()}`);
                            
                            // USDT转出 - 可能是买入的第一步
                            if (contract === USDT_CONTRACT.toLowerCase() && from === address.toLowerCase()) {
                                usdtOut += amount;
                                console.log(`检测到USDT流出: ${amount}`);
                            }
                            
                            // USDT转入 - 可能是卖出的结果
                            if (contract === USDT_CONTRACT.toLowerCase() && to === address.toLowerCase()) {
                                usdtIn += amount;
                                console.log(`检测到USDT流入: ${amount}`);
                            }
                            
                            // 非USDT代币转入 - 可能是买入的结果
                            if (contract !== USDT_CONTRACT.toLowerCase() && to === address.toLowerCase()) {
                                if (!tokenAddress) tokenAddress = contract;
                                tokenIn += amount;
                                console.log(`检测到非USDT代币流入: ${amount}, 合约: ${contract}`);
                            }
                            
                            // 非USDT代币转出 - 可能是卖出的开始
                            if (contract !== USDT_CONTRACT.toLowerCase() && from === address.toLowerCase()) {
                                if (!tokenAddress) tokenAddress = contract;
                                tokenOut += amount;
                                console.log(`检测到非USDT代币流出: ${amount}, 合约: ${contract}`);
                            }
                        }
                    }
                    
                    // 1inch特殊情况1: proxySwap可能不直接转入代币，而是通过内部调用转入
                    if (methodId === '0xdad12b6c' && usdtOut > 0 && tokenIn === 0) {
                        console.log(`proxySwap交易 ${tx.hash} 检测到USDT流出但没有代币流入，尝试查找内部代币转账`);
                        
                        // 检查是否有其他非USDT代币转入
                        let foundTokenIn = false;
                        for (const log of receipt.logs) {
                            if (log.topics[0] === ERC20_TRANSFER_TOPIC) {
                                const contract = log.address.toLowerCase();
                                const to = '0x' + log.topics[2].slice(26).toLowerCase();
                                
                                // 如果有任何非USDT代币转入用户地址，视为买入交易的目标代币
                                if (contract !== USDT_CONTRACT.toLowerCase() && to === address.toLowerCase()) {
                                    try {
                                        const amount = parseFloat(BigInt(log.data).toString()) / 1e18;
                                        if (amount > 0) {
                                            console.log(`✅ proxySwap买入: 找到目标代币 ${amount} (合约: ${contract})`);
                                            tokenIn = amount;
                                            tokenAddress = contract;
                                            foundTokenIn = true;
                                            break;
                                        }
                                    } catch (e) {
                                        console.error("解析代币数量错误:", e);
                                    }
                                }
                            }
                        }
                        
                        // 如果仍未找到，强制识别为买入交易
                        if (!foundTokenIn && usdtOut > 0) {
                            console.log(`⚠️ proxySwap强制识别为买入: 支付 ${usdtOut} USDT`);
                            // 先尝试从input数据中找出目标代币地址
                            try {
                                if (methodId === '0xdad12b6c') { // proxySwap
                                    const toTokenPosition = 202; // proxySwap的第4个参数位置(toToken)
                                    if (txDetail.input.length >= toTokenPosition + 64) {
                                        const toTokenHex = txDetail.input.substring(toTokenPosition, toTokenPosition + 64);
                                        if (toTokenHex && toTokenHex !== '0000000000000000000000000000000000000000000000000000000000000000') {
                                            // 从hex中提取地址部分
                                            const extractedAddress = '0x' + toTokenHex.substring(24);
                                            console.log(`从input数据提取的目标代币地址: ${extractedAddress}`);
                                            tokenAddress = extractedAddress.toLowerCase();
                                        }
                                    }
                                }
                            } catch (e) {
                                console.error("解析input数据错误:", e);
                            }
                            
                            // 无论如何都记录为买入交易
                            return {
                                hash: tx.hash,
                                usdtAmount: -usdtOut,
                                tokenAmount: tokenIn > 0 ? tokenIn : 1, // 如果没找到具体数量，默认为1
                                tokenAddress: tokenAddress || "未知代币", // 如果没找到代币地址，标记为未知
                                isBuy: true,
                                isSell: false,
                                timestamp: tx.timeStamp,
                                gasCost: gasCost,
                                note: "自动识别的1inch买入交易"
                            };
                        }
                    }
                    
                    // 1inch特殊情况2: 处理其他1inch方法的买入
                    if (is1inch && usdtOut > 0 && tokenIn === 0) {
                        console.log(`1inch交易 ${tx.hash} (${methodId}) 检测到USDT流出但没有代币流入，强制识别为买入交易`);
                        
                        return {
                            hash: tx.hash,
                            usdtAmount: -usdtOut,
                            tokenAmount: 1, // 默认数量
                            tokenAddress: tokenAddress || "未知代币",
                            isBuy: true,
                            isSell: false,
                            timestamp: tx.timeStamp,
                            gasCost: gasCost,
                            note: "自动识别的1inch买入交易"
                        };
                    }
                }

                // 专门检测BaseSwapRouter + callOneInch组合
                if (methodId === '0xa03de6a9' && tx.to.toLowerCase() === '0xb300000b72deaeb607a12d5f54773d1c19c7028d'.toLowerCase()) {
                    console.log(`检测到特殊组合: callOneInch + BaseSwapRouter, 交易: ${tx.hash}`);
                    
                    // 强制设置dex为BaseSwapRouter
                    dex = 'BaseSwapRouter';
                    
                    // 添加特殊处理逻辑，确保正确识别是否为卖出交易
                    // ...与现有的内部交易检测逻辑类似...
                }

                // 通用检查 - 必须放在1inch特殊处理后
                if (usdtOut > 0 && tokenIn > 0) {
                    console.log(`✅ 检测到买入交易 ${tx.hash}: 支付${usdtOut} USDT, 获得${tokenIn}代币`);
                    return {
                        hash: tx.hash,
                        usdtAmount: -usdtOut,
                        tokenAmount: tokenIn,
                        tokenAddress,
                        isBuy: true,
                        isSell: false,
                        timestamp: tx.timeStamp,
                        gasCost: gasCost
                    };
                }
                
                // 检测卖出交易
                if (usdtIn > 0 && tokenOut > 0) {
                    console.log(`✅ 检测到卖出交易 ${tx.hash}: 支付${tokenOut}代币, 获得${usdtIn} USDT`);
                    return {
                        hash: tx.hash,
                        usdtAmount: usdtIn,
                        tokenAmount: -tokenOut,
                        tokenAddress,
                        isBuy: false,
                        isSell: true,
                        timestamp: tx.timeStamp,
                        gasCost: gasCost
                    };
                }
                
                return null;
            }

            async function getBNBPrice() {
                try {
                    const res = await fetch('https://api.binance.com/api/v3/ticker/price?symbol=BNBUSDT');
                    const data = await res.json();
                    return parseFloat(data.price);
                } catch (e) {
                    return 0;
                }
            }
        });
    </script>
</body>
</html>
