<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BSC USDT 统计分析工具</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        .trade-card {
            transition: all 0.2s ease;
            margin-bottom: 15px;
        }
        .trade-card:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        .buy-card {
            border-left: 4px solid #28a745;
        }
        .sell-card {
            border-left: 4px solid #dc3545;
        }
        .stats-box {
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .loader {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            margin: 20px auto;
        }
        .loading-spinner {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: conic-gradient(#0000 10%, #3498db);
            -webkit-mask: radial-gradient(farthest-side, #0000 calc(100% - 8px), #000 0);
            mask: radial-gradient(farthest-side, #0000 calc(100% - 8px), #000 0);
            animation: spin 1s infinite linear;
        }
        .loading-text {
            margin-top: 15px;
            font-size: 14px;
            color: #666;
            text-align: center;
        }
        .loading-progress {
            margin-top: 10px;
            width: 250px;
            height: 6px;
            background-color: #eee;
            border-radius: 3px;
            overflow: hidden;
        }
        .loading-progress-bar {
            height: 100%;
            background-color: #3498db;
            border-radius: 3px;
            transition: width 0.3s ease;
        }
        @keyframes spin {
            to { transform: rotate(1turn); }
        }
        .progress-info {
            background-color: rgba(52, 152, 219, 0.1);
            border-left: 4px solid #3498db;
            padding: 10px 15px;
            margin: 10px 0;
            font-size: 14px;
            color: #333;
            border-radius: 4px;
        }
        .hidden {
            display: none;
        }
        .wallet-input {
            margin-bottom: 10px;
        }
        .wallet-input .input-group-append {
            cursor: pointer;
        }
        #addWalletBtn {
            margin-bottom: 10px;
        }
        .remove-wallet {
            cursor: pointer;
            color: #dc3545;
        }
        .wallet-addresses {
            min-height: 100px;
            font-family: monospace;
        }
        .usdt-in { color: #28a745; }
        .usdt-out { color: #dc3545; }
        .ellipsis { max-width: 120px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; display: inline-block; vertical-align: bottom; }
    </style>
</head>
<body>
    <div class="container py-4">
        <h1 class="mb-4 text-center">BSC USDT 统计分析工具</h1>
        
        <div class="card mb-4">
            <div class="card-body">
                <form id="analyzeForm">
                    <div class="row g-3">
                        <div class="col-md-8">
                            <label class="form-label">BSC 钱包地址（支持带名称，每行一个）</label>
                            <textarea class="form-control wallet-addresses" rows="5" placeholder="输入格式：
名称 0x开头的BSC钱包地址
例如：
念安1 0xXX
念安2 0xXX" required></textarea>
                            <small class="text-muted">每行一个地址，可以在地址前加名称（用空格分隔）</small>
                        </div>
                        <div class="col-md-4">
                            <label for="date" class="form-label">统计日期</label>
                            <input type="date" class="form-control" id="date">
                            <small class="text-muted">不填默认统计今天8:00到明天8:00的数据</small>
                        </div>
                        <div class="col-md-4" style="display: none;">
                            <label for="txLimit" class="form-label">交易处理限制</label>
                            <select class="form-control" id="txLimit">
                                <option value="50">仅处理最近50笔交易</option>
                                <option value="100">仅处理最近100笔交易</option>
                                <option value="200">仅处理最近200笔交易</option>
                                <option value="all" selected>处理所有交易</option>
                            </select>
                            <small class="text-muted">限制处理的交易数量可以提高性能</small>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <button type="submit" class="btn btn-primary">
                                <span class="normal-text">分析</span>
                                <span class="spinner-border spinner-border-sm hidden" id="submitSpinner" role="status"></span>
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <div id="errorMessage" class="alert alert-danger hidden" role="alert"></div>
        <div id="loader" class="loader hidden">
            <div class="loading-spinner"></div>
            <div class="loading-text">正在分析交易数据...</div>
            <div class="loading-progress">
                <div class="loading-progress-bar" style="width: 0%"></div>
            </div>
            <div id="loading-detail" class="loading-text"></div>
        </div>

        <div id="resultContainer" class="hidden">
            <div class="card mb-4">
                <div class="card-header">
                    <h4>分析结果</h4>
                    <p class="text-muted mb-0" id="timeRangeInfo"></p>
                </div>
            </div>

            <!-- 账户分析结果容器 -->
            <div id="accountsContainer"></div>

            <div id="noTradesMessage" class="alert alert-info hidden">在指定时间范围内没有找到USDT买卖</div>
        </div>
        
        <div class="mt-4 text-center">
            <p class="text-muted mb-2">
                作者: 东东 
                <a href="https://x.com/lumaodaren" target="_blank" class="text-decoration-none">
                    <i class="bi bi-twitter-x"></i> @lumaodaren
                </a>
            </p>
            <p class="text-muted">
                <a href="https://github.com/sincitysh/bscalpha" target="_blank" class="text-decoration-none">
                    <i class="bi bi-github"></i> 查看源码
                </a>
                |
                本工具在GitHub Pages上运行，无需服务器
            </p>
        </div>
    </div>

    <!-- 添加Web3.js库 -->
    <script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>
    
    <!-- 添加Bootstrap的JavaScript依赖 -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // 1. 修复时间戳问题 - 彻底重写formatTime函数
        function formatTime(ts) {
            // 确保ts是数字
            let timestamp = typeof ts === 'string' ? parseInt(ts) : ts;
            
            // 创建日期对象
            const date = new Date(timestamp * 1000);
            
            // 格式化为本地时间字符串（不做年份修改）
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            }).replace(/\//g, '-');
        }

        function formatDateTime(date) {
            if (!(date instanceof Date) || isNaN(date.getTime())) {
                console.warn('无效的日期对象:', date);
                return new Date().toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false
                }).replace(/\//g, '-');
            }
            
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            }).replace(/\//g, '-');
        }

        const USDT_CONTRACT = '0x55d398326f99059fF775485246999027B3197955';

        const BSCSCAN_API_KEYS = [
            'GFCARE1KCXRXZUTWYCRV9K65Q1V8BXZU3K',
            'AMQYJJTKB7H8GGSDY3K42G989M6S7INCFG',
            'R613WACX85IZPMASA6K8EAXTT85JQQG6J8',
            'W8U2D8MVYQCVN2TR1FU5IJB186436997CF',
            'T8RZ9IAIMPPDE665TSIP14Y3RYAWK23W3I'
        ];

        function getRandomApiKey() {
            const randomIndex = Math.floor(Math.random() * BSCSCAN_API_KEYS.length);
            return BSCSCAN_API_KEYS[randomIndex];
        }

        const DEX_ROUTER_LIST = [
            '0x10ed43c718714eb63d5aa57b78b54704e256024e', // PancakeSwap v2
            '0x05fF2B0DB69458A0750badebc4f9e13aDd608C7F', // PancakeSwap v1
            '0x3a6d8ca21d1cf76f653a67577fa0d27453350dd8', // BiSwap
            '0xcDe540d7eAFE93aC5fE6233Bee57E1270D3E330F', // BakerySwap
            '0xC0788A3aD43d79aa53B09c2EaCc313A787d1d607', // ApeSwap
            '0x7a6e4e3cc2ac9924605dc68f5d95e75e5f629b31', // Mdex Router
            '0x1b96b92314c44b159149f7e0303511fb2fc4774f', // PancakeSwap v2 (老路由)
            '0x1111111254eeb25477b68fb85ed929f73a960582', // 1inch v4 Router
            '0x11111112542d85b3ef69ae05771c2dccff4faa26', // 1inch v3 Router
            '0x111111125434b319222cdbf8c261674adb56f3ae', // 1inch v2 Router
            '0x72c30ba151f8a9d9372e887a41e577d8b49dda6c', // LiquidMesh Router (新增)
        ];

        // 定义路由地址
        const routerAddresses = {
            'PancakeSwap': '0x10ED43C718714eb63d5aA57B78B54704E256024E'.toLowerCase(),
            'BiSwap': '0x3a6d8cA21D1CF76F653A67577FA0D27453350dD8'.toLowerCase(),
            'BaseSwap': '0x13f4EA83D0bd40E75C8222255bc855a974568Dd4'.toLowerCase(),
            'BaseSwapRouter': '0xb300000b72deaeb607a12d5f54773d1c19c7028d'.toLowerCase(), // 确保这个地址正确添加
            'LiquidMesh': '0x72c30ba151f8a9d9372e887a41e577d8b49dda6c'.toLowerCase(), // 新增
            // ... 其他地址 ...
        };

        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('analyzeForm');
            const loader = document.getElementById('loader');
            const errorMessage = document.getElementById('errorMessage');
            const resultContainer = document.getElementById('resultContainer');
            const submitSpinner = document.getElementById('submitSpinner');
            const noTradesMessage = document.getElementById('noTradesMessage');
            
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                // 获取并处理钱包地址
                const addressesText = form.querySelector('.wallet-addresses').value;
                const addressEntries = addressesText.split('\n')
                    .map(line => {
                        const parts = line.trim().split(/[\s\t]+/);
                        if (parts.length >= 2) {
                            return {
                                name: parts[0],
                                address: parts[parts.length - 1].trim()
                            };
                        } else if (parts.length === 1 && parts[0]) {
                            return {
                                name: '未命名',
                                address: parts[0].trim()
                            };
                        }
                        return null;
                    })
                    .filter(Boolean);
                
                // 验证地址
                for (const entry of addressEntries) {
                    if (!isValidAddress(entry.address)) {
                        errorMessage.textContent = `无效的钱包地址格式: ${entry.address}`;
                        errorMessage.classList.remove('hidden');
                        return;
                    }
                }

                if (addressEntries.length === 0) {
                    errorMessage.textContent = '请至少输入一个钱包地址';
                    errorMessage.classList.remove('hidden');
                    return;
                }
                
                const date = document.getElementById('date').value;
                
                console.log('开始分析，输入的钱包地址：', addressesText);
                console.log('解析后的地址对象：', addressEntries);
                console.log('选择的日期：', date);
                
                // 显示加载状态
                toggleLoading(true);
                errorMessage.classList.add('hidden');
                errorMessage.textContent = '';
                resultContainer.classList.add('hidden');
                
                try {
                    // 获取时间范围
                    const timeRange = getTimeRange(date);
                    console.log('统计时间范围:', timeRange);
                    
                    // 获取所有地址的交易
                    let allTransactions = [];
                    const errors = [];
                    
                    // 获取当前BNB价格
                    let bnbPrice = await getBNBPrice();
                    
                    // 确保bnbPrice是有效的数字
                    if (isNaN(bnbPrice) || bnbPrice <= 0) {
                        console.warn(`获取的BNB价格无效: ${bnbPrice}，使用默认价格220`);
                        bnbPrice = 220; // 使用默认价格
                    }
                    
                    // 串行处理每个地址，避免并发请求
                    for (const entry of addressEntries) {
                        try {
                            console.log(`开始获取地址 ${entry.name} (${entry.address}) 的USDT转账...`);
                            const txLimit = document.getElementById('txLimit').value;
                            const transfers = await getUSDTTransfers(entry.address, timeRange, txLimit);
                            console.log(`地址 ${entry.name} 获取到 ${transfers.length} 条USDT转账`);
                            console.log(`【${entry.name}】USDT转账原始数据:`, transfers);
                            allTransactions = allTransactions.concat(transfers.map(tx => ({...tx, accountName: entry.name})));
                        } catch (error) {
                            errors.push(`${entry.name}: ${error.message}`);
                            console.error(`处理地址 ${entry.name} 时出错:`, error);
                        }
                    }
                    
                    // 如果有错误但仍有一些成功的结果，显示警告
                    if (errors.length > 0) {
                        const warningDiv = document.createElement('div');
                        warningDiv.className = 'alert alert-warning';
                        warningDiv.innerHTML = `
                            <h5>部分数据获取失败</h5>
                            <ul class="mb-0">
                                ${errors.map(err => `<li>${err}</li>`).join('')}
                            </ul>
                        `;
                        resultContainer.insertBefore(warningDiv, resultContainer.firstChild);
                    }
                    
                    // 如果完全没有数据，显示错误
                    if (allTransactions.length === 0 && errors.length > 0) {
                        throw new Error('所有地址的数据获取均失败');
                    }
                    
                    if (allTransactions.length === 0) {
                        resultContainer.classList.remove('hidden');
                        noTradesMessage.classList.remove('hidden');
                        document.getElementById('timeRangeInfo').textContent = `统计时间: ${formatDateTime(timeRange.startDate)} 至 ${formatDateTime(timeRange.endDate)}`;
                        return;
                    }
                    
                    // 获取当前USDT价格
                    const usdtPrice = await getUSDTPrice();
                    
                    // 获取所有地址的USDT余额总和
                    let totalBalance = 0;
                    for (const entry of addressEntries) {
                        const balance = await getUSDTBalance(entry.address);
                        totalBalance += parseFloat(balance);
                    }
                    
                    // 分析交易
                    const allAnalysis = [];
                    for (const entry of addressEntries) {
                        const txs = allTransactions.filter(tx => tx.accountName === entry.name);
                        const analysis = await analyzeTransactions(entry, txs, timeRange, usdtPrice, bnbPrice, await getUSDTBalance(entry.address));
                        allAnalysis.push(analysis);
                    }
                    
                    // 渲染结果
                    await renderResults({
                        success: true,
                        addressEntries,
                        allAnalysis
                    });
                    
                    resultContainer.classList.remove('hidden');
                } catch (error) {
                    console.error('分析失败:', error);
                    errorMessage.textContent = error.message || '处理请求时发生错误';
                    errorMessage.classList.remove('hidden');
                } finally {
                    toggleLoading(false);
                }
            });
            
            function toggleLoading(isLoading) {
                if (isLoading) {
                    loader.classList.remove('hidden');
                    submitSpinner.classList.remove('hidden');
                    document.querySelector('.normal-text').classList.add('hidden');
                    document.querySelector('.loading-progress-bar').style.width = '0%';
                    document.getElementById('loading-detail').textContent = '准备分析...';
                } else {
                    loader.classList.add('hidden');
                    submitSpinner.classList.add('hidden');
                    document.querySelector('.normal-text').classList.remove('hidden');
                }
            }
            
            function isValidAddress(address) {
                return /^0x[a-fA-F0-9]{40}$/.test(address);
            }
            
            // 获取USDT价格（USDT对USDT永远是1）
            async function getUSDTPrice() {
                return 1;
            }
            
            // 获取USDT余额
            async function getUSDTBalance(address) {
                const url = `https://api.bscscan.com/api?module=account&action=tokenbalance&contractaddress=${USDT_CONTRACT}&address=${address}&tag=latest&apikey=${getRandomApiKey()}`;
                const res = await fetch(url);
                const data = await res.json();
                return parseFloat(data.result) / 1e18;
            }
            
            // 获取地址交易
            async function getTxList(address, timeRange) {
                const url = `https://api.bscscan.com/api?module=account&action=txlist&address=${address}&startblock=0&endblock=99999999&starttime=${timeRange.start}&endtime=${timeRange.end}&sort=asc&apikey=${getRandomApiKey()}`;
                const res = await fetch(url);
                const data = await res.json();
                if (!Array.isArray(data.result)) {
                    console.error('BscScan返回异常:', data);
                    return [];
                }
                return data.result;
            }
            
            // 使用缓存减少重复请求
            const receiptCache = {};
            const txDetailCache = {};
            
            // 添加延迟函数
            function sleep(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
            
            // 修改getTxReceipt函数添加重试机制
            async function getTxReceipt(txHash) {
                if (receiptCache[txHash]) return receiptCache[txHash];
                
                let retries = 3;
                while (retries > 0) {
                    try {
                        const url = `https://api.bscscan.com/api?module=proxy&action=eth_getTransactionReceipt&txhash=${txHash}&apikey=${getRandomApiKey()}`;
                        const res = await fetch(url);
                        const data = await res.json();
                        
                        if (data.status === '0' && data.message === 'NOTOK' && data.result.includes('rate limit')) {
                            console.warn(`API速率限制，等待1秒后重试... (${retries}次尝试剩余)`);
                            await sleep(1000); // 等待1秒后重试
                            retries--;
                            continue;
                        }
                        
                        receiptCache[txHash] = data.result;
                        return data.result;
                    } catch (e) {
                        console.error(`获取交易收据失败: ${txHash}`, e);
                        retries--;
                        if (retries > 0) {
                            await sleep(1000);
                            continue;
                        }
                        return null;
                    }
                }
                
                return null;
            }
            
            // 修改getTxDetail函数添加重试机制
            async function getTxDetail(txHash) {
                if (txDetailCache[txHash]) return txDetailCache[txHash];
                
                let retries = 3;
                while (retries > 0) {
                    try {
                        const url = `https://api.bscscan.com/api?module=proxy&action=eth_getTransactionByHash&txhash=${txHash}&apikey=${getRandomApiKey()}`;
                        const res = await fetch(url);
                        const data = await res.json();
                        
                        if (data.status === '0' && data.message === 'NOTOK' && data.result.includes('rate limit')) {
                            console.warn(`API速率限制，等待1秒后重试... (${retries}次尝试剩余)`);
                            await sleep(1000); // 等待1秒后重试
                            retries--;
                            continue;
                        }
                        
                        txDetailCache[txHash] = data.result;
                        return data.result;
                    } catch (e) {
                        console.error(`获取交易详情失败: ${txHash}`, e);
                        retries--;
                        if (retries > 0) {
                            await sleep(1000);
                            continue;
                        }
                        return null;
                    }
                }
                
                return null;
            }
            
            // 修改getUSDTTransfers函数添加重试机制
            async function getUSDTTransfers(address, timeRange, txLimit) {
                console.log(`严格按照时间范围筛选: ${new Date(timeRange.start*1000).toLocaleString()} - ${new Date(timeRange.end*1000).toLocaleString()}`);
                
                // 添加延迟以避免触发API速率限制
                const fetchWithRetry = async (url, description) => {
                    let retries = 3;
                    while (retries > 0) {
                        try {
                            console.log(`${description}API请求URL: ${url}`);
                            const res = await fetch(url);
                            const data = await res.json();
                            
                            if (data.status === '0' && data.message === 'NOTOK' && data.result.includes('rate limit')) {
                                console.warn(`API速率限制，等待2秒后重试... (${retries}次尝试剩余)`);
                                await sleep(2000); // 等待2秒后重试
                                retries--;
                                continue;
                            }
                            
                            if (data.status === '1' && Array.isArray(data.result)) {
                                console.log(`获取到 ${data.result.length} 条${description}记录`);
                                return data.result;
                            } else if (data.status === '0' && data.message.includes('No transactions found')) {
                                console.log(`地址 ${address} 没有${description}记录`);
                                return [];
                            } else {
                                console.error(`获取${description}失败:`, data);
                                retries--;
                                if (retries > 0) {
                                    await sleep(2000);
                                    continue;
                                }
                                return [];
                            }
                        } catch (e) {
                            console.error(`获取${description}时出错:`, e);
                            retries--;
                            if (retries > 0) {
                                await sleep(2000);
                                continue;
                            }
                            return [];
                        }
                    }
                    return [];
                };
                
                // 同时获取代币转账和普通交易，确保捕获所有可能的USDT交易
                // 但是添加序列化请求以避免触发速率限制
                
                // 先获取USDT代币转账
                const tokenTxUrl = `https://api.bscscan.com/api?module=account&action=tokentx&contractaddress=${USDT_CONTRACT}&address=${address}&startblock=0&endblock=99999999&starttime=${timeRange.start}&endtime=${timeRange.end}&sort=asc&apikey=${getRandomApiKey()}`;
                const tokenTxs = await fetchWithRetry(tokenTxUrl, "USDT转账");
                
                // 等待1秒避免触发速率限制
                await sleep(1000);
                
                // 再获取普通交易
                const normalTxUrl = `https://api.bscscan.com/api?module=account&action=txlist&address=${address}&startblock=0&endblock=99999999&starttime=${timeRange.start}&endtime=${timeRange.end}&sort=asc&apikey=${getRandomApiKey()}`;
                const normalTxs = await fetchWithRetry(normalTxUrl, "普通交易");
                
                console.log(`地址 ${address} USDT代币转账: ${tokenTxs.length}条`);
                console.log(`地址 ${address} 普通交易: ${normalTxs.length}条`);
                
                // 合并交易数据，确保不重复
                const hashSet = new Set();
                const mergedTxs = [];
                
                // 添加USDT代币转账
                for (const tx of tokenTxs) {
                    // 双重检查时间范围
                    const time = parseInt(tx.timeStamp);
                    if (time < timeRange.start || time > timeRange.end) {
                        console.log(`跳过范围外USDT转账: ${tx.hash}, 时间: ${new Date(time*1000).toLocaleString()}`);
                        continue;
                    }
                    
                    hashSet.add(tx.hash);
                    mergedTxs.push(tx);
                }
                
                // 处理普通交易，主要为了获取swap交易
                for (const tx of normalTxs) {
                    // 双重检查时间范围
                    const time = parseInt(tx.timeStamp);
                    if (time < timeRange.start || time > timeRange.end) {
                        console.log(`跳过范围外普通交易: ${tx.hash}, 时间: ${new Date(time*1000).toLocaleString()}`);
                        continue;
                    }
                    
                    // 如果已经处理过这个交易哈希，跳过
                    if (hashSet.has(tx.hash)) continue;
                    
                    try {
                        // 特别检查是否是特殊方法ID交易
                        if (tx.input && tx.input.length >= 10) {
                            const methodId = tx.input.slice(0, 10).toLowerCase();
                            
                            // 特殊处理这些方法ID - 直接添加，不需要额外检查
                            if (methodId === '0xe19c2253' || methodId === '0x0d46641a') {
                                console.log(`发现特殊方法ID交易: ${tx.hash} (方法ID: ${methodId})`);
                                tx.contractAddress = USDT_CONTRACT; // 设置为USDT合约地址
                                mergedTxs.push(tx);
                                hashSet.add(tx.hash);
                                continue; // 处理完毕，继续下一个交易
                            }
                            
                            // 检查swap方法
                            const swapMethods = [
                                '0xa03de6a9', // 1inch callOneInch
                                '0x7c025200', // 1inch swap
                                '0x84bd6d29', // 1inch clipperSwap
                                '0x12aa3caf', // 1inch swap variant
                                '0xe449022e', // 1inch uniswapV3Swap
                                '0x90411a32', // 1inch swap variant
                                '0xdad12b6c', // 1inch proxySwap
                                '0xe5e8894b', // 1inch proxySwapV2
                                '0x7ff36ab5', // PancakeSwap swapExactETHForTokens
                                '0x38ed1739', // PancakeSwap swapExactTokensForTokens
                                '0x18cbafe5', // PancakeSwap swapExactTokensForETH
                                '0x8803dbee', // PancakeSwap swapTokensForExactTokens
                                '0xb6f9de95', // LiquidMesh swapExactTokensForTokens
                                '0x791ac947', // LiquidMesh swapExactETHForTokens
                                '0x42712a67', // LiquidMesh swapExactTokensForETH
                            ];
                            
                            const isDexRouter = DEX_ROUTER_LIST.includes(tx.to.toLowerCase());
                            
                            if (swapMethods.includes(methodId) || isDexRouter) {
                                const receipt = await getTxReceipt(tx.hash);
                                if (receipt && receipt.logs) {
                                    const ERC20_TRANSFER_TOPIC = '0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef';
                                    const hasUsdtTransfer = receipt.logs.some(log => 
                                        log.address.toLowerCase() === USDT_CONTRACT.toLowerCase() && 
                                        log.topics[0] === ERC20_TRANSFER_TOPIC
                                    );
                                    
                                    if (hasUsdtTransfer) {
                                        console.log(`发现swap交易涉及USDT: ${tx.hash} (方法ID: ${methodId})`);
                                        tx.contractAddress = USDT_CONTRACT;
                                        mergedTxs.push(tx);
                                        hashSet.add(tx.hash);
                                    }
                                }
                            }
                        } else if (tx.to && tx.to.toLowerCase() === USDT_CONTRACT.toLowerCase()) {
                            // 与USDT合约的直接交互
                            console.log(`发现与USDT合约的直接交互: ${tx.hash}`);
                            tx.contractAddress = USDT_CONTRACT;
                            mergedTxs.push(tx);
                            hashSet.add(tx.hash);
                        }
                    } catch (error) {
                        console.error(`处理交易时出错: ${tx.hash}`, error);
                    }
                }
                
                console.log(`合并后总共: ${mergedTxs.length}条交易，全部在时间范围内`);
                return mergedTxs;
            }
            
            // 修改analyzeTransactions函数，处理未知交易
            async function analyzeTransactions(addressInfo, transfers, timeRange, usdtPrice, bnbPrice, usdtBalance) {
                // 首先确保只使用时间范围内的交易
                const filteredTransfers = transfers.filter(tx => {
                    const time = parseInt(tx.timeStamp);
                    const isInRange = time >= timeRange.start && time <= timeRange.end;
                    if (!isInRange) {
                        console.log(`分析前过滤掉范围外交易: ${tx.hash}, 时间: ${new Date(time*1000).toLocaleString()}`);
                    }
                    return isInRange;
                });
                
                console.log(`过滤后剩余 ${filteredTransfers.length} 条交易在分析时间范围内`);
                
                // 过滤出直接相关的交易，但保留特殊方法ID交易
                const address = addressInfo.address.toLowerCase();
                const strictlyRelevantTransfers = filteredTransfers.filter(tx => {
                    // 检查交易是否与地址相关
                    if (tx.from.toLowerCase() === address || tx.to.toLowerCase() === address) {
                        return true; // 直接相关的交易
                    }
                    
                    // 对于特殊方法ID，我们需要在后续处理中进一步验证
                    if (tx.input && tx.input.length >= 10) {
                        const methodId = tx.input.slice(0, 10).toLowerCase();
                        if (methodId === '0xe19c2253' || methodId === '0x0d46641a') {
                            return true; // 特殊方法ID交易，保留以便后续处理
                        }
                    }
                    
                    return false; // 不相关的交易
                });
                
                console.log(`相关交易过滤后剩余 ${strictlyRelevantTransfers.length} 条交易`);
                
                // 按交易哈希分组
                const grouped = groupByHash(strictlyRelevantTransfers);
                console.log(`【${addressInfo.name}】USDT转账分组（按hash）:`, grouped.map(g => g[0].hash));
                
                const trades = [];
                const unknownTrades = []; // 未识别交易数组
                let totalBuy = 0, totalSell = 0, totalGasCost = 0;
                
                const totalTxs = grouped.length;
                document.getElementById('loading-detail').textContent = `分析 ${addressInfo.name} 的交易: 0/${totalTxs}`;
                document.querySelector('.loading-progress-bar').style.width = '0%';
                
                // 确保bnbPrice是有效的数字
                if (isNaN(bnbPrice) || bnbPrice <= 0) {
                    console.warn(`检测到无效的BNB价格: ${bnbPrice}，使用默认价格220`);
                    bnbPrice = 660; // 使用默认价格
                }
                
                for (let i = 0; i < grouped.length; i++) {
                    const progress = Math.min(100, Math.round((i / totalTxs) * 100));
                    document.getElementById('loading-detail').textContent = `分析 ${addressInfo.name} 的交易: ${i+1}/${totalTxs}`;
                    document.querySelector('.loading-progress-bar').style.width = `${progress}%`;
                    
                    const txGroup = grouped[i];
                    const tx = txGroup[0];
                    const time = parseInt(tx.timeStamp);
                    
                    // 打印时间戳，便于调试
                    console.log(`交易: ${tx.hash} 时间戳: ${time}`);
                    console.log(`交易日期: ${new Date(time*1000).toLocaleString()}`);
                    console.log(`时间范围: ${new Date(timeRange.start*1000).toLocaleString()} - ${new Date(timeRange.end*1000).toLocaleString()}`);

                    // 严格检查时间范围
                    if (time < timeRange.start || time > timeRange.end) {
                        console.log(`交易时间超出范围，跳过: ${tx.hash}`);
                        continue;
                    }
                    
                    // 首先检查是否是特殊方法ID交易
                    const txDetail = await getTxDetail(tx.hash);
                    const receipt = await getTxReceipt(tx.hash);
                    
                    if (txDetail && txDetail.input && receipt && receipt.logs) {
                        const methodId = txDetail.input.slice(0, 10).toLowerCase();
                        
                        // 特殊处理 0xe19c2253 和 0x0d46641a 方法ID
                        if (methodId === '0xe19c2253' || methodId === '0x0d46641a') {
                            console.log(`处理特殊方法ID交易: ${tx.hash}, 方法ID: ${methodId}`);
                            
                            // 检查交易日志，确定USDT转入和转出
                            const ERC20_TRANSFER_TOPIC = '0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef';
                            const usdtLogs = receipt.logs.filter(log => 
                                log.address.toLowerCase() === USDT_CONTRACT.toLowerCase() && 
                                log.topics[0] === ERC20_TRANSFER_TOPIC
                            );
                            
                            // 如果有USDT相关的日志
                            if (usdtLogs.length > 0) {
                                // 计算gas费用
                                let gasCost = 0;
                                try {
                                    const gasUsed = parseInt(receipt.gasUsed, 16);
                                    const gasPrice = parseInt(txDetail.gasPrice, 16);
                                    gasCost = gasUsed * gasPrice / 1e18;
                                } catch (e) {
                                    console.error(`计算gas费用出错: ${tx.hash}`, e);
                                }
                                
                                // 计算USDT转入和转出
                                let usdtIn = 0, usdtOut = 0;
                                
                                for (const log of usdtLogs) {
                                    const from = '0x' + log.topics[1].slice(26).toLowerCase();
                                    const to = '0x' + log.topics[2].slice(26).toLowerCase();
                                    
                                    try {
                                        const amount = parseFloat(BigInt(log.data).toString()) / 1e18;
                                        
                                        if (from.toLowerCase() === addressInfo.address.toLowerCase()) {
                                            usdtOut += amount;
                                            console.log(`特殊方法交易 ${tx.hash} 检测到USDT转出: ${amount}`);
                                        }
                                        if (to.toLowerCase() === addressInfo.address.toLowerCase()) {
                                            usdtIn += amount;
                                            console.log(`特殊方法交易 ${tx.hash} 检测到USDT转入: ${amount}`);
                                        }
                                    } catch (e) {
                                        console.error(`解析USDT金额错误: ${tx.hash}`, e);
                                    }
                                }
                                
                                // 根据USDT流向创建交易对象
                                let specialTrade = null;
                                
                                if (usdtIn > 0 && usdtOut === 0) {
                                    // 只有USDT转入 = 卖出交易
                                    specialTrade = {
                                        hash: tx.hash,
                                        usdtAmount: usdtIn,
                                        tokenAmount: 0,
                                        tokenAddress: USDT_CONTRACT,
                                        isBuy: false,
                                        isSell: true,
                                        timestamp: time,
                                        gasCost: gasCost
                                    };
                                    totalSell += usdtIn;
                                } else if (usdtOut > 0 && usdtIn === 0) {
                                    // 只有USDT转出 = 买入交易
                                    specialTrade = {
                                        hash: tx.hash,
                                        usdtAmount: -usdtOut,
                                        tokenAmount: 0,
                                        tokenAddress: USDT_CONTRACT,
                                        isBuy: true,
                                        isSell: false,
                                        timestamp: time,
                                        gasCost: gasCost
                                    };
                                    totalBuy += usdtOut;
                                } else if (usdtIn > 0 && usdtOut > 0) {
                                    // 同时有USDT转入和转出，根据净额判断
                                    const netAmount = usdtIn - usdtOut;
                                    specialTrade = {
                                        hash: tx.hash,
                                        usdtAmount: netAmount,
                                        tokenAmount: 0,
                                        tokenAddress: USDT_CONTRACT,
                                        isBuy: netAmount < 0,
                                        isSell: netAmount > 0,
                                        timestamp: time,
                                        gasCost: gasCost
                                    };
                                    
                                    if (netAmount > 0) {
                                        totalSell += netAmount;
                                    } else {
                                        totalBuy += Math.abs(netAmount);
                                    }
                                }
                                
                                if (specialTrade) {
                                    trades.push(specialTrade);
                                    totalGasCost += gasCost;
                                    console.log(`成功处理特殊方法ID交易: ${tx.hash}`);
                                    continue; // 处理成功，继续下一个交易
                                }
                            }
                        }
                    }
                    
                    // 如果不是特殊方法ID交易，使用标准的analyzeTxGroup函数处理
                    try {
                        const tradePromise = analyzeTxGroup(txGroup, addressInfo.address);
                        const timeoutPromise = new Promise((_, reject) => 
                            setTimeout(() => reject(new Error('分析超时')), 10000)
                        );
                        
                        const trade = await Promise.race([tradePromise, timeoutPromise]);
                        if (trade) {
                            // 确保为每个交易添加gas费用
                            if (trade.gasCost === undefined || trade.gasCost === null) {
                                // 如果交易没有gas费用，尝试计算
                                if (!receipt || !txDetail) {
                                    receipt = await getTxReceipt(tx.hash);
                                    txDetail = await getTxDetail(tx.hash);
                                }
                                
                                if (receipt && txDetail) {
                                    try {
                                        const gasUsed = parseInt(receipt.gasUsed, 16);
                                        const gasPrice = parseInt(txDetail.gasPrice, 16);
                                        trade.gasCost = gasUsed * gasPrice / 1e18;
                                        console.log(`为交易 ${tx.hash} 计算gas费用: ${trade.gasCost}`);
                                    } catch (e) {
                                        console.error(`计算gas费用出错: ${tx.hash}`, e);
                                        trade.gasCost = 0;
                                    }
                                }
                            }
                            
                            // 确保gas费用是数字
                            trade.gasCost = typeof trade.gasCost === 'number' ? trade.gasCost : 0;
                            
                            // 确保gas费用被加入总计
                            totalGasCost += trade.gasCost;
                            console.log(`交易 ${tx.hash} 的gas费用: ${trade.gasCost}, 累计gas费用: ${totalGasCost}`);
                            
                            trades.push(trade);
                            if (trade.isBuy) {
                                totalBuy += Math.abs(trade.usdtAmount);
                                console.log(`累计买入总额增加 ${Math.abs(trade.usdtAmount)}, 当前: ${totalBuy}`);
                            }
                            if (trade.isSell) {
                                totalSell += Math.abs(trade.usdtAmount);
                                console.log(`累计卖出总额增加 ${Math.abs(trade.usdtAmount)}, 当前: ${totalSell}`);
                            }
                        } else if (tx.contractAddress && tx.contractAddress.toLowerCase() === USDT_CONTRACT.toLowerCase()) {
                            // 二次尝试处理特殊方法ID交易
                            if (!receipt || !txDetail) {
                                receipt = await getTxReceipt(tx.hash);
                                txDetail = await getTxDetail(tx.hash);
                            }
                            
                            if (receipt && txDetail) {
                                const methodId = txDetail.input ? txDetail.input.slice(0, 10).toLowerCase() : '未知';
                                const gasUsed = parseInt(receipt.gasUsed, 16);
                                const gasPrice = parseInt(txDetail.gasPrice, 16);
                                const gasCost = gasUsed * gasPrice / 1e18;
                                
                                // 检查是否与USDT相关
                                const ERC20_TRANSFER_TOPIC = '0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef';
                                const usdtLogs = receipt.logs.filter(log => 
                                    log.address.toLowerCase() === USDT_CONTRACT.toLowerCase() && 
                                    log.topics[0] === ERC20_TRANSFER_TOPIC
                                );
                                
                                if (usdtLogs.length > 0 && (methodId === '0xe19c2253' || methodId === '0x0d46641a')) {
                                    // 如果是特殊方法ID且有USDT转账，尝试直接创建交易对象
                                    console.log(`二次尝试处理特殊方法ID交易: ${tx.hash} (方法ID: ${methodId})`);
                                    
                                    // 计算USDT转入和转出
                                    let usdtIn = 0, usdtOut = 0;
                                    
                                    for (const log of usdtLogs) {
                                        const from = '0x' + log.topics[1].slice(26).toLowerCase();
                                        const to = '0x' + log.topics[2].slice(26).toLowerCase();
                                        
                                        try {
                                            const amount = parseFloat(BigInt(log.data).toString()) / 1e18;
                                            
                                            if (from.toLowerCase() === addressInfo.address.toLowerCase()) {
                                                usdtOut += amount;
                                            }
                                            if (to.toLowerCase() === addressInfo.address.toLowerCase()) {
                                                usdtIn += amount;
                                            }
                                        } catch (e) {
                                            console.error(`解析USDT金额错误: ${tx.hash}`, e);
                                        }
                                    }
                                    
                                    // 创建交易对象
                                    if (usdtIn > 0 || usdtOut > 0) {
                                        // 根据净额判断交易类型
                                        const netAmount = usdtIn - usdtOut;
                                        const specialTrade = {
                                            hash: tx.hash,
                                            usdtAmount: netAmount,
                                            tokenAmount: 0,
                                            tokenAddress: USDT_CONTRACT,
                                            isBuy: netAmount < 0,
                                            isSell: netAmount > 0,
                                            timestamp: time,
                                            gasCost: gasCost
                                        };
                                        
                                        trades.push(specialTrade);
                                        totalGasCost += gasCost;
                                        
                                        if (netAmount > 0) {
                                            totalSell += netAmount;
                                        } else if (netAmount < 0) {
                                            totalBuy += Math.abs(netAmount);
                                        }
                                        
                                        console.log(`成功二次处理特殊方法ID交易: ${tx.hash}`);
                                        continue; // 处理成功，继续下一个交易
                                    }
                                }
                                
                                // 如果无法创建交易对象，添加到未知交易列表
                                unknownTrades.push({
                                    hash: tx.hash,
                                    timestamp: tx.timeStamp,
                                    methodId: methodId,
                                    gasCost: gasCost,
                                    tokenAddress: tx.contractAddress || ''
                                });
                                console.log(`添加未识别USDT交易: ${tx.hash}, 方法ID: ${methodId}`);
                            }
                        }
                    } catch (e) {
                        console.error(`分析交易 ${tx.hash} 失败:`, e);
                        // 继续处理下一个交易
                    }
                }
                
                // 不需要移除progressDiv，而是清空加载详情
                document.getElementById('loading-detail').textContent = '分析完成';
                
                // 计算USDT等值的gas费用，确保所有数值都是有效的
                if (isNaN(totalGasCost)) totalGasCost = 0;
                const gasCostInUSDT = totalGasCost * bnbPrice;
                console.log(`Gas费用(BNB): ${totalGasCost}, 当前BNB价格: ${bnbPrice}, Gas费用(USDT): ${gasCostInUSDT}`);
                
                // 计算净盈亏（扣除gas费用），确保所有计算都使用有效数值
                const profitLoss = totalSell - totalBuy;
                const netProfitLoss = profitLoss - gasCostInUSDT;
                
                // 创建分析结果对象
                const analysis = {
                    name: addressInfo.name,
                    address: addressInfo.address,
                    trades,
                    unknownTrades,
                    totalBuyValue: totalBuy,
                    totalSellValue: totalSell,
                    profitLoss: profitLoss, // 买卖差额
                    netProfitLoss: netProfitLoss, // 净盈亏（扣除gas）
                    totalGasCost: totalGasCost, // BNB形式的gas费用
                    gasCostInUSDT: gasCostInUSDT, // USDT等值的gas费用
                    bnbPrice: bnbPrice,
                    usdtPrice: usdtPrice,
                    usdtBalance: parseFloat(usdtBalance),
                    timeRange
                };
                
                return analysis;
            }
            
            async function renderResults(data) {
                const { addressEntries, allAnalysis } = data;
                const accountsContainer = document.getElementById('accountsContainer');
                accountsContainer.innerHTML = '';

                // 计算总亏损和是否有交易
                let totalLoss = 0;
                let totalTrades = 0;
                allAnalysis.forEach(analysis => {
                    totalLoss += analysis.netProfitLoss < 0 ? Math.abs(analysis.netProfitLoss) : 0;
                    totalTrades += analysis.trades.length;
                });

                // 从第一个分析结果中获取timeRange（所有分析应该使用相同的时间范围）
                const timeRange = allAnalysis.length > 0 ? allAnalysis[0].timeRange : null;

                // 更新时间范围显示（确保timeRange存在）
                if (timeRange) {
                    document.getElementById('timeRangeInfo').textContent = 
                        `统计时间: ${formatDateTime(timeRange.startDate)} 至 ${formatDateTime(timeRange.endDate)}`;
                }

                // 修改渲染结果函数中的总结卡片逻辑
                const summaryCard = document.createElement('div');
                summaryCard.className = 'card mb-4';

                if (totalTrades === 0) {
                    summaryCard.innerHTML = `
                        <div class="card-body bg-info text-white">
                            <h5 class="card-title">⚠️ 未检测到交易记录</h5>
                            <p class="mb-0">可能原因：</p>
                            <ul class="mb-0">
                                <li>今日未进行交易</li>
                                <li>API 访问异常，请稍后重试</li>
                                <li>选择的时间范围内无交易</li>
                            </ul>
                        </div>
                    `;
                } else {
                    // 计算总盈亏
                    let totalProfit = 0;
                    allAnalysis.forEach(analysis => {
                        totalProfit += analysis.netProfitLoss;
                    });
                    
                    // 根据盈亏情况显示不同的信息
                    if (totalProfit > 0) {
                        // 盈利情况
                        const teaEggs = Math.floor(totalProfit / 0.5); // 假设茶叶蛋0.5U一个
                        summaryCard.innerHTML = `
                            <div class="card-body bg-success text-white">
                                <h5 class="card-title">🎉 恭喜你这个交易天才！今日盈利 ${totalProfit.toFixed(2)} USDT</h5>
                                <p class="mb-0">相当于赚了 ${teaEggs} 个茶叶蛋 (按0.5U/个计算)</p>
                                <small>继续保持这样的水平！</small>
                            </div>
                        `;
                    } else if (totalProfit === 0) {
                        // 收支平衡
                        summaryCard.innerHTML = `
                            <div class="card-body bg-warning">
                                <h5 class="card-title">😐 今日收支平衡 ${totalProfit.toFixed(2)} USDT</h5>
                                <p class="mb-0">不赚不亏，保持稳定</p>
                                <small class="text-muted">明天争取有所突破！</small>
                            </div>
                        `;
                    } else if (Math.abs(totalProfit) < 5) {
                        // 小亏
                        const pigFeetMeals = Math.ceil(Math.abs(totalProfit) / 2);
                        summaryCard.innerHTML = `
                            <div class="card-body bg-warning">
                                <h5 class="card-title">😅 今日小亏 ${Math.abs(totalProfit).toFixed(2)} USDT</h5>
                                <p class="mb-0">相当于丢失了 ${pigFeetMeals} 顿猪脚饭 (按2U/顿计算)</p>
                                <small class="text-muted">别灰心，明天会更好！</small>
                            </div>
                        `;
                    } else if (Math.abs(totalProfit) >= 50) {
                        // 大亏
                        const hotPotMeals = Math.ceil(Math.abs(totalProfit) / 50);
                        summaryCard.innerHTML = `
                            <div class="card-body bg-danger text-white">
                                <h5 class="card-title">😱 今日大亏 ${Math.abs(totalProfit).toFixed(2)} USDT</h5>
                                <p class="mb-0">相当于错过了 ${hotPotMeals} 顿海底捞 (按50U/顿计算)</p>
                                <small>建议休息一下，调整心态！</small>
                            </div>
                        `;
                    } else {
                        // 中等亏损
                        const pigFeetMeals = Math.ceil(Math.abs(totalProfit) / 2);
                        summaryCard.innerHTML = `
                            <div class="card-body bg-warning">
                                <h5 class="card-title">😓 今日亏损 ${Math.abs(totalProfit).toFixed(2)} USDT</h5>
                                <p class="mb-0">相当于丢失了 ${pigFeetMeals} 顿猪脚饭 (按2U/顿计算)</p>
                                <small class="text-muted">调整策略，明天继续！</small>
                            </div>
                        `;
                    }
                }

                // 将总结卡片插入到结果容器的开头
                accountsContainer.insertBefore(summaryCard, accountsContainer.firstChild);

                // 继续渲染原有的账户分析结果
                for (let i = 0; i < addressEntries.length; i++) {
                    const entry = addressEntries[i];
                    const analysis = allAnalysis[i];
                    // 获取当前USDT余额
                    const balance = await getUSDTBalance(entry.address);
                    
                    const accountCard = document.createElement('div');
                    accountCard.className = 'card mb-4';
                    accountCard.id = `accountCard_${i}`; // 添加ID以便后续引用
                    accountCard.innerHTML = `
                        <div class="card-header bg-light">
                            <h5 class="mb-0">
                                <i class="bi bi-person-circle"></i> 
                                ${entry.name}
                                <small class="text-muted">${entry.address}</small>
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="stats-box bg-light">
                                        <h6 class="border-bottom pb-2">USDT买卖统计</h6>
                                        <div class="d-flex justify-content-between">
                                            <span>买入总额:</span>
                                            <span class="fw-bold usdt-out">${analysis.totalBuyValue.toFixed(6)} USDT</span>
                                        </div>
                                        <div class="d-flex justify-content-between">
                                            <span>卖出总额:</span>
                                            <span class="fw-bold usdt-in">${analysis.totalSellValue.toFixed(6)} USDT</span>
                                        </div>
                                        <div class="d-flex justify-content-between">
                                            <span>净盈亏:</span>
                                            <span class="fw-bold ${analysis.netProfitLoss >= 0 ? 'usdt-in' : 'usdt-out'}">${analysis.netProfitLoss.toFixed(6)} USDT</span>
                                        </div>
                                        <div class="d-flex justify-content-between">
                                            <span>当前USDT余额:</span>
                                            <span class="fw-bold">${balance.toFixed(6)} USDT</span>
                                        </div>
                                        <div class="d-flex justify-content-between">
                                            <span>总Gas消耗:</span>
                                            <span class="fw-bold">${analysis.totalGasCost.toFixed(6)} BNB ≈ ${analysis.gasCostInUSDT.toFixed(2)} USDT</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-8">
                                    <div class="stats-box bg-light">
                                        <h6 class="border-bottom pb-2">USDT买卖明细</h6>
                                        <div class="table-responsive">
                                            <table class="table table-sm table-bordered">
                                                <thead>
                                                    <tr>
                                                        <th>时间</th>
                                                        <th>类型</th>
                                                        <th>USDT金额</th>
                                                        <th>代币金额</th>
                                                        <th>代币合约</th>
                                                        <th>交易</th>
                                                        <th>Gas费用（BNB）</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    ${
                                                        analysis.trades.length === 0
                                                        ? '<tr><td colspan="7">无USDT买卖记录</td></tr>'
                                                        : analysis.trades.map(d => `
                                                            <tr>
                                                                <td>${formatTime(d.timestamp)}</td>
                                                                <td class="${d.isSpecial ? '' : (d.usdtAmount < 0 ? 'usdt-out' : 'usdt-in')}">
                                                                    ${d.isSpecial ? '特殊USDT交易' : (d.usdtAmount < 0 ? '用USDT买入' : '用其他币换USDT')}
                                                                    ${d.methodId ? `<small class="text-muted">(${d.methodId})</small>` : ''}
                                                                </td>
                                                                <td>${d.isSpecial ? '-' : Math.abs(d.usdtAmount).toFixed(6)}</td>
                                                                <td>${d.tokenAmount.toFixed(6)}</td>
                                                                <td class="ellipsis" title="${d.tokenAddress}">${d.tokenAddress}</td>
                                                                <td><a href="https://bscscan.com/tx/${d.hash}" target="_blank">查看</a></td>
                                                                <td>${d.gasCost ? d.gasCost.toFixed(6) : '-'}</td>
                                                            </tr>
                                                        `).join('')
                                                    }
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    accountsContainer.appendChild(accountCard);

                    // 渲染未识别交易
                    if (analysis.unknownTrades && analysis.unknownTrades.length > 0) {
                        renderUnknownTrades(i, analysis.unknownTrades, entry);
                    }
                }
                console.log('渲染分析结果：', allAnalysis);
            }

            function groupByHash(transfers) {
                const map = {};
                for (const tx of transfers) {
                    if (!map[tx.hash]) map[tx.hash] = [];
                    map[tx.hash].push(tx);
                }
                return Object.values(map);
            }

            function analyzeUSDTTrades(address, groupedTxs, timeRange) {
                const trades = [];
                let totalBuy = 0, totalSell = 0;
                for (const txGroup of groupedTxs) {
                    // 取消路由过滤
                    // const isSwap = txGroup.some(tx =>
                    //     DEX_ROUTER_LIST.includes(tx.to.toLowerCase()) ||
                    //     DEX_ROUTER_LIST.includes(tx.from.toLowerCase())
                    // );
                    // if (!isSwap) continue;

                    // 时间过滤
                    const time = parseInt(txGroup[0].timeStamp);
                    if (time < timeRange.start || time >= timeRange.end) continue;

                    let usdtIn = 0, usdtOut = 0;
                    let hash = txGroup[0].hash;
                    let tokenAddress = txGroup[0].contractAddress;
                    for (const tx of txGroup) {
                        if (tx.to.toLowerCase() === address.toLowerCase()) {
                            usdtIn += parseFloat(tx.value) / 1e18;
                        }
                        if (tx.from.toLowerCase() === address.toLowerCase()) {
                            usdtOut += parseFloat(tx.value) / 1e18;
                        }
                    }
                    if (usdtOut > 0) {
                        trades.push({
                            hash,
                            usdtAmount: -usdtOut,
                            tokenAmount: 0,
                            tokenAddress,
                            isBuy: true,
                            isSell: false,
                            timestamp: time
                        });
                        totalBuy += usdtOut;
                    }
                    if (usdtIn > 0) {
                        trades.push({
                            hash,
                            usdtAmount: usdtIn,
                            tokenAmount: 0,
                            tokenAddress,
                            isBuy: false,
                            isSell: true,
                            timestamp: time
                        });
                        totalSell += usdtIn;
                    }
                }
                return { trades, totalBuy, totalSell };
            }

            // 修改analyzeTxGroup函数，确保不会丢失卖出交易
            async function analyzeTxGroup(txGroup, address) {
                const tx = txGroup[0];
                const receipt = await getTxReceipt(tx.hash);
                if (!receipt || !receipt.logs) {
                    console.log(`【${address}】hash:${tx.hash} 没有收据或logs`);
                    return null;
                }

                // 获取主交易详情
                const txDetail = await getTxDetail(tx.hash);
                if (!txDetail) {
                    console.log(`【${address}】hash:${tx.hash} 没有主交易详情`);
                    return null;
                }
                
                const methodId = txDetail.input ? txDetail.input.slice(0, 10).toLowerCase() : '';
                console.log(`交易 ${tx.hash} 方法ID: ${methodId}`);
                
                // 计算gas费用 - 确保正确处理十六进制数据
                let gasCost = 0;
                try {
                    const gasUsed = parseInt(receipt.gasUsed, 16);
                    const gasPrice = parseInt(txDetail.gasPrice, 16);
                    gasCost = gasUsed * gasPrice / 1e18;
                    console.log(`交易 ${tx.hash} gas费用: ${gasCost} BNB`);
                } catch (e) {
                    console.error(`计算gas费用出错 ${tx.hash}:`, e);
                }

                const ERC20_TRANSFER_TOPIC = '0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef';
                
                // 确保地址格式统一为小写
                const normalizedAddress = address.toLowerCase();
                
                // 初始化USDT转入转出和其他代币转入转出的统计
                let usdtIn = 0, usdtOut = 0, tokenIn = 0, tokenOut = 0, tokenAddress = '';

                // 分析所有日志
                for (const log of receipt.logs) {
                    if (log.topics[0] === ERC20_TRANSFER_TOPIC) {
                        const from = '0x' + log.topics[1].slice(26).toLowerCase();
                        const to = '0x' + log.topics[2].slice(26).toLowerCase();
                        
                        try {
                            const amount = parseFloat(BigInt(log.data).toString()) / 1e18;
                            
                            // 检查是否是USDT转账
                            if (log.address.toLowerCase() === USDT_CONTRACT.toLowerCase()) {
                                // USDT转账
                                if (from === normalizedAddress) {
                                    usdtOut += amount;
                                    console.log(`交易 ${tx.hash} 检测到USDT转出: ${amount}`);
                                }
                                if (to === normalizedAddress) {
                                    usdtIn += amount;
                                    console.log(`交易 ${tx.hash} 检测到USDT转入: ${amount}`);
                                }
                            } else {
                                // 其他代币转账
                                if (from === normalizedAddress) {
                                    tokenOut += amount;
                                    if (!tokenAddress) tokenAddress = log.address.toLowerCase();
                                    console.log(`交易 ${tx.hash} 检测到代币转出: ${amount}, 合约: ${log.address}`);
                                }
                                if (to === normalizedAddress) {
                                    tokenIn += amount;
                                    if (!tokenAddress) tokenAddress = log.address.toLowerCase();
                                    console.log(`交易 ${tx.hash} 检测到代币转入: ${amount}, 合约: ${log.address}`);
                                }
                            }
                        } catch (e) {
                            console.error(`解析代币金额错误: ${tx.hash}`, e);
                        }
                    }
                }
                
                // 处理普通交易的情况
                // USDT转出且其他代币转入 = 买入交易
                if (usdtOut > 0 && tokenIn > 0) {
                    console.log(`✅ 检测到买入交易 ${tx.hash}: 支付${usdtOut} USDT, 获得${tokenIn}代币 (${tokenAddress})`);
                    return {
                        hash: tx.hash,
                        usdtAmount: -usdtOut,  // 用负数表示USDT支出
                        tokenAmount: tokenIn,
                        tokenAddress,
                        isBuy: true,
                        isSell: false,
                        timestamp: parseInt(tx.timeStamp),  // 确保转换为整数
                        gasCost: gasCost
                    };
                }
                
                // USDT转入且其他代币转出 = 卖出交易
                if (usdtIn > 0 && tokenOut > 0) {
                    console.log(`✅ 检测到卖出交易 ${tx.hash}: 支付${tokenOut}代币, 获得${usdtIn} USDT`);
                    return {
                        hash: tx.hash,
                        usdtAmount: usdtIn,  // 正数表示USDT收入
                        tokenAmount: -tokenOut,  // 负数表示代币支出
                        tokenAddress,
                        isBuy: false,
                        isSell: true,
                        timestamp: parseInt(tx.timeStamp),  // 确保转换为整数
                        gasCost: gasCost
                    };
                }
                
                // 处理只有USDT转入的情况（可能是卖出但未检测到代币转出）
                if (usdtIn > 0 && tokenOut === 0 && tokenIn === 0) {
                    console.log(`⚠️ 检测到USDT转入交易 ${tx.hash}: 获得${usdtIn} USDT, 未检测到代币流动`);
                    return {
                        hash: tx.hash,
                        usdtAmount: usdtIn,
                        tokenAmount: 0,
                        tokenAddress: tokenAddress || USDT_CONTRACT,
                        isBuy: false,
                        isSell: true,
                        timestamp: parseInt(tx.timeStamp),
                        gasCost: gasCost
                    };
                }
                
                // 处理只有USDT转出的情况（可能是买入但未检测到代币转入）
                if (usdtOut > 0 && tokenIn === 0 && tokenOut === 0) {
                    console.log(`⚠️ 检测到USDT转出交易 ${tx.hash}: 支付${usdtOut} USDT, 未检测到代币流动`);
                    return {
                        hash: tx.hash,
                        usdtAmount: -usdtOut,
                        tokenAmount: 0,
                        tokenAddress: tokenAddress || USDT_CONTRACT,
                        isBuy: true,
                        isSell: false,
                        timestamp: parseInt(tx.timeStamp),
                        gasCost: gasCost
                    };
                }
                
                // 处理特殊方法ID交易...
                // (保留现有的特殊方法ID处理代码)
                
                // 无法明确识别的交易
                return null;
            }

            // 使用明确的时间范围函数
            function getTimeRange(dateStr = '') {
                const now = new Date();
                let startDate, endDate;
                
                console.log("输入日期字符串:", dateStr);
                
                if (dateStr) {
                    // 如果提供了日期，使用该日期的8:00到次日8:00
                    startDate = new Date(dateStr);
                    console.log("解析后的日期对象:", startDate);
                    
                    // 检查日期是否有效
                    if (isNaN(startDate.getTime())) {
                        console.warn("日期解析失败，使用当前日期");
                        startDate = new Date(now);
                    }
                } else {
                    // 如果没有提供日期，使用今天8:00到明天8:00
                    startDate = new Date(now);
                    
                    // 如果当前时间早于8点，使用前一天8点到今天8点
                    if (now.getHours() < 8) {
                        startDate.setDate(startDate.getDate() - 1);
                    }
                }
                
                // 设置为当天的早上8点
                startDate.setHours(8, 0, 0, 0);
                
                // 结束时间总是开始时间的第二天早上8点
                endDate = new Date(startDate);
                endDate.setDate(endDate.getDate() + 1);
                
                // 转换为时间戳（秒）
                const start = Math.floor(startDate.getTime() / 1000);
                const end = Math.floor(endDate.getTime() / 1000);
                
                console.log(`时间范围日期对象: ${startDate.toLocaleString()} - ${endDate.toLocaleString()}`);
                console.log(`时间戳范围(秒): ${start} - ${end}`);
                
                return { 
                    start, 
                    end, 
                    startDate, 
                    endDate 
                };
            }

            // 获取BNB价格
            async function getBNBPrice() {
                try {
                    const response = await fetch('https://api.binance.com/api/v3/ticker/price?symbol=BNBUSDT');
                    const data = await response.json();
                    const price = parseFloat(data.price);
                    
                    // 确保价格是有效的数字
                    if (!isNaN(price) && price > 0) {
                        console.log(`获取到当前BNB价格: ${price} USDT`);
                        return price;
                    } else {
                        console.warn(`获取到无效的BNB价格: ${price}，使用默认价格`);
                        return 220; // 使用默认价格
                    }
                } catch (error) {
                    console.error('获取BNB价格失败:', error);
                    return 220; // 出错时使用默认价格
                }
            }

            // 1. 添加渲染未识别交易的函数 - 放在renderResults函数之后
            function renderUnknownTrades(index, unknownTrades, entry) {
                if (!unknownTrades || unknownTrades.length === 0) return;
                
                // 创建一个新的容器
                const container = document.createElement('div');
                container.className = 'mt-4';
                container.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center border-bottom pb-2">
                        <h6 class="mb-0">未识别的USDT交易 (${unknownTrades.length})</h6>
                        <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#unknownTradesCollapse_${index}">
                            <i class="bi bi-chevron-down"></i> 展开/收起
                        </button>
                    </div>
                    <div class="collapse" id="unknownTradesCollapse_${index}">
                        <div class="alert alert-warning mt-2">
                            <i class="bi bi-exclamation-triangle"></i> 
                            以下交易无法确定具体类型，未计入统计数据
                        </div>
                        <div class="pt-2" id="unknownTradesContainer_${index}"></div>
                    </div>
                `;
                
                // 将容器添加到账户卡片
                const accountCard = document.querySelector(`#accountCard_${index}`);
                accountCard.appendChild(container);
                
                // 渲染未知交易
                const tradesContainer = document.getElementById(`unknownTradesContainer_${index}`);
                
                // 对交易按时间倒序排列
                const sortedTrades = [...unknownTrades].sort((a, b) => {
                    return new Date(b.timestamp) - new Date(a.timestamp);
                });
                
                sortedTrades.forEach(trade => {
                    const tradeCard = document.createElement('div');
                    tradeCard.className = 'card trade-card border-warning';
                    
                    tradeCard.innerHTML = `
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="card-title mb-0">
                                        <i class="bi bi-question-circle text-warning"></i>
                                        未知交易 - 方法ID: ${trade.methodId || '未知'}
                                    </h6>
                                    <div class="mt-2">
                                        <div class="d-flex align-items-center">
                                            <span>合约地址:</span>
                                            <span class="ms-2 ellipsis" title="${trade.tokenAddress || '未知'}">
                                                ${trade.tokenAddress || '未知'}
                                            </span>
                                        </div>
                                        <div class="d-flex align-items-center mt-1">
                                            <span>Gas 费用:</span>
                                            <span class="ms-2">
                                                ${trade.gasCost ? trade.gasCost.toFixed(6) : '-'} BNB
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                <div class="text-end">
                                    <div class="text-muted mb-2">${formatTime(trade.timestamp)}</div>
                                    <a href="https://bscscan.com/tx/${trade.hash}" target="_blank" class="btn btn-sm btn-outline-secondary">
                                        <i class="bi bi-box-arrow-up-right"></i> 查看交易
                                    </a>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    tradesContainer.appendChild(tradeCard);
                });
            }
        });
    </script>
</body>
</html>
